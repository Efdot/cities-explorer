<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>Cities by Efdot x Diid | Explorer</title>
    <meta name="description" content="Explore the Cities generative art collection by Efdot x Diid on Art Blocks. Browse 500 unique city maps, filter by traits, and discover collectors.">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Cities by Efdot x Diid | Explorer">
    <meta property="og:description" content="Explore the Cities generative art collection. Browse unique city maps, filter by traits, and discover collectors.">
    <meta property="og:image" content="https://media-proxy.artblocks.io/1/0x7c78f67700e700b4005c8a3d920a1a99e6004800/0.png">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Cities by Efdot x Diid | Explorer">
    <meta name="twitter:description" content="Explore the Cities generative art collection. Browse unique city maps, filter by traits, and discover collectors.">
    <meta name="twitter:image" content="https://media-proxy.artblocks.io/1/0x7c78f67700e700b4005c8a3d920a1a99e6004800/0.png">

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://media-proxy.artblocks.io/1/0x7c78f67700e700b4005c8a3d920a1a99e6004800/0.png">
    <link rel="apple-touch-icon" href="https://media-proxy.artblocks.io/1/0x7c78f67700e700b4005c8a3d920a1a99e6004800/0.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#00E5CC">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        /* Focus states for accessibility */
        :focus { outline: none; }
        :focus-visible { outline: 2px solid var(--teal); outline-offset: 2px; }
        button:focus-visible, a:focus-visible, input:focus-visible, select:focus-visible {
            outline: 2px solid var(--teal);
            outline-offset: 2px;
        }

        :root {
            --bg-deep: #0A0910;
            --bg-panel: #14131c;
            --bg-card: #1e1d28;
            --bg-input: #28273a;
            --border: #363550;
            --text: #fff;
            --text-dim: #a0a0c0;
            --text-muted: #8888a8;
            --teal: #E8B86D; /* warm gold - was teal */
            --yellow: #FFE135;
            --pink: #D4A574; /* muted warm - was pink */
            --blue: #00B4FF;
            --purple: #B967FF;
            --orange: #FF8C42;
            --mint: #D4A574; /* muted warm tone */
            --warm: #E8B86D; /* warm gold accent */
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-deep);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            overflow: hidden;
            letter-spacing: 0.02em;
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        .app-wrapper { display: flex; width: 100%; height: 100vh; }

        /* Prevent iOS zoom on input focus */
        input, select, textarea { font-size: 16px !important; }

        .bg-bubbles { position: fixed; top: 0; left: 0; right: 0; bottom: 0; pointer-events: none; overflow: hidden; z-index: 0; }
        .bubble { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.15; animation: float 20s ease-in-out infinite; transition: background 1s ease-out; }
        .bubble-1 { width: 400px; height: 400px; background: var(--warm); top: -100px; right: -100px; }
        .bubble-2 { width: 300px; height: 300px; background: var(--orange); bottom: -50px; left: 20%; animation-delay: -5s; }
        .bubble-3 { width: 250px; height: 250px; background: var(--yellow); top: 40%; right: 10%; animation-delay: -10s; }
        @keyframes float { 0%, 100% { transform: translate(0, 0) scale(1); } 33% { transform: translate(30px, -30px) scale(1.05); } 66% { transform: translate(-20px, 20px) scale(0.95); } }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 300px;
            background: var(--bg-panel);
            padding: 28px 24px;
            padding-bottom: 80px;
            overflow-y: auto;
            height: 100vh;
            z-index: 100;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .sidebar h1 { font-size: 28px; font-weight: 700; text-transform: none; letter-spacing: 0.02em; margin-bottom: 4px; color: #fff; font-family: Helvetica, Arial, sans-serif; cursor: default; }
        .artist-logos { display: flex; align-items: center; gap: 6px; margin-bottom: 24px; }
        .artist-logo { height: 17px; width: auto; opacity: 0.5; transition: all 0.3s ease; filter: brightness(0) invert(1); cursor: pointer; }
        .artist-logo:hover { opacity: 0.9; filter: brightness(0) invert(1) drop-shadow(0 0 8px rgba(212, 165, 116, 0.5)); }
        .artist-logo.ef-logo:hover { animation: logoWiggle 0.4s ease-in-out; }
        .artist-logo.diid-logo { height: 22px; }
        @keyframes logoWiggle { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(-5deg); } 75% { transform: rotate(5deg); } }
        .blob-shop-fixed { position: fixed; bottom: 24px; right: 24px; height: 35px; width: auto; opacity: 0.4; transition: all 0.3s ease; cursor: pointer; z-index: 99; filter: grayscale(100%); }
        .blob-shop-fixed:hover { opacity: 1; transform: scale(1.15); filter: grayscale(0%); }
        /* Sidebar note area - reserved space */
        .sidebar-note-area { min-height: 60px; margin-top: 16px; padding: 0 4px; position: relative; }
        .note-placeholder { font-size: 9px; font-weight: 500; color: var(--text-muted); opacity: 0; cursor: pointer; animation: noteFadeIn 3s ease-out forwards; animation-delay: 1s; letter-spacing: 0.02em; }
        @keyframes noteFadeIn { 0% { opacity: 0; } 100% { opacity: 0.35; } }
        .note-dots { animation: dotsWiggle 1.5s steps(3) infinite; display: inline-block; }
        @keyframes dotsWiggle { 0%, 100% { opacity: 0.4; } 33% { opacity: 0.7; } 66% { opacity: 0.5; } }
        .note-cursor { animation: cursorBlink 0.5s steps(1) 3, cursorFadeOut 0.3s ease-out 1.5s forwards; margin-left: 1px; }
        @keyframes cursorBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        @keyframes cursorFadeOut { 0% { opacity: 1; } 100% { opacity: 0; } }
        .note-input { display: none; width: 100%; background: transparent; border: none; border-bottom: 1px solid var(--border); color: var(--text); font-size: 9px; font-family: inherit; font-weight: 500; padding: 6px 0; resize: none; height: 36px; line-height: 1.4; }
        .note-input:focus { outline: none; border-bottom-color: var(--text-muted); }
        .note-input::placeholder { color: var(--text-muted); opacity: 0.4; }
        .sidebar-note-area.active .note-placeholder { display: none; }
        .sidebar-note-area.active .note-input { display: block; }
        .note-counter { font-size: 7px; color: var(--text-muted); opacity: 0; text-align: right; margin-top: 4px; transition: opacity 0.2s; }
        .sidebar-note-area.active .note-counter { opacity: 0.4; }

        .studio-credit { margin-top: auto; padding-top: 12px; text-align: center; }
        .studio-credit a { font-size: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); opacity: 0.4; text-decoration: none; transition: all 0.3s ease; }
        .studio-credit a:hover { opacity: 0.8; color: var(--teal); }
        .logo-x { font-size: 7px; color: var(--text-muted); font-weight: 300; opacity: 0.4; }
        .section-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); margin-bottom: 14px; margin-top: 6px; }
        .control-group { margin-bottom: 14px; }
        .control-group label { display: block; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-dim); margin-bottom: 6px; }
        .control-group input[type="text"], .control-group input[type="number"], .control-group select { width: 100%; padding: 12px 16px; background: var(--bg-input); border: none; color: var(--text); border-radius: 50px; font-size: 13px; font-family: inherit; font-weight: 600; transition: all 0.3s ease; }
        .control-group input:focus, .control-group select:focus { outline: none; background: var(--bg-card); box-shadow: 0 0 0 2px rgba(0, 229, 204, 0.3); }
        .control-group select { cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='10' fill='%23a0a0c0'%3E%3Cpath d='M1 3l4 4 4-4'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; padding-right: 36px; color-scheme: dark; }
        .control-group select option { background: #1e1d28; color: #fff; padding: 8px; }

        .btn { width: 100%; padding: 14px; border: none; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); margin-bottom: 10px; }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: transparent; border: 2px solid var(--teal); color: var(--teal); }
        .btn-primary:hover { background: var(--teal); color: #000; box-shadow: 0 8px 24px rgba(0, 229, 204, 0.25); }
        .btn-secondary { background: var(--bg-input); color: var(--text-dim); }
        .btn-secondary:hover { background: var(--bg-card); color: var(--text); }
        .btn-download { background: var(--blue); color: #fff; }
        .btn-download:hover { box-shadow: 0 8px 24px rgba(0, 180, 255, 0.25); }
        .btn-twitter { background: #1DA1F2; color: #fff; }
        .btn-twitter:hover { background: #0d8ddb; }
        .btn-instagram { background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); color: #fff; }

        .btn-group { display: flex; gap: 10px; }
        .btn-group .btn { flex: 1; }
        .btn-sm { padding: 10px 12px; font-size: 9px; border-radius: 50px; margin-bottom: 6px; }

        /* Icon buttons */
        .icon-btn { width: 36px; height: 36px; padding: 0; border: none; border-radius: 50%; background: var(--bg-input); color: var(--text-dim); font-size: 15px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .icon-btn:hover { background: var(--bg-card); color: var(--text); }
        .icon-btn.active { background: var(--pink); color: #fff; }

        /* Heart favorite button */
        .heart-btn { width: 40px; height: 40px; background: var(--bg-input); border: none; font-size: 18px; border-radius: 50%; opacity: 0.7; transition: all 0.25s ease; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .heart-btn .heart-red { display: inline; }
        .heart-btn .heart-blue { display: none; }
        .heart-btn:hover { opacity: 1; transform: scale(1.1); background: var(--bg-card); }
        .heart-btn:hover .heart-red { display: none; }
        .heart-btn:hover .heart-blue { display: inline; }
        .heart-btn.favorited { opacity: 1; box-shadow: 0 0 8px var(--spot-color, var(--pink)); background: color-mix(in srgb, var(--spot-color, var(--pink)) 15%, var(--bg-input)); }
        .heart-btn.favorited .heart-red { display: inline; }
        .heart-btn.favorited .heart-blue { display: none; }
        .heart-btn.favorited:hover .heart-red { display: none; }
        .heart-btn.favorited:hover .heart-blue { display: inline; }

        /* Action bar with icons */
        .action-bar { display: flex; gap: 10px; align-items: center; margin-bottom: 12px; }
        .action-bar-main { flex: 1 1 auto; margin-bottom: 0; padding: 10px 16px; font-size: 9px; min-width: 0; }
        .action-bar .heart-btn { height: 40px; width: 40px; min-width: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .action-icons { display: flex; gap: 6px; flex-wrap: wrap; }
        .action-icons .icon-btn { width: 32px; height: 32px; font-size: 13px; border-radius: 50%; }

        /* Saved to favorites note */
        .saved-note { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); opacity: 0; height: 0; overflow: hidden; transition: opacity 0.3s ease, height 0.3s ease; margin-top: 0; }
        .saved-note.visible { opacity: 0.5; height: 24px; margin-top: 10px; }
        .saved-dots::after { content: ''; animation: savedDots 1.5s steps(4) infinite; }
        @keyframes savedDots { 0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; } }

        /* Icon buttons row */
        .icon-buttons-row { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 10px; }
        .icon-buttons-row .icon-btn { flex: 1; min-width: 32px; max-width: 40px; text-decoration: none; background: transparent; border-radius: 8px; width: 32px; height: 32px; font-size: 14px; }
        .icon-buttons-row .icon-btn:hover { transform: translateY(-1px); background: var(--bg-input); }
        .icon-buttons-row .opensea-icon { filter: grayscale(100%); }
        .icon-buttons-row .opensea-icon:hover { filter: grayscale(0%); }

        /* Sidebar bottom row */
        .sidebar-bottom-row { display: flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 0; margin-top: 8px; }
        .text-btn { background: none; border: none; color: var(--text-muted); font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; padding: 4px 2px; transition: color 0.2s ease; }
        .text-btn:hover { color: var(--text); }
        .text-btn .fav-count { color: var(--pink); }
        .row-divider { color: var(--border); font-size: 8px; }

        .btn-explore { background: transparent; border: 1px solid var(--border); color: var(--text-muted); position: relative; overflow: hidden; padding: 10px 14px; }
        .btn-explore:hover { background: var(--bg-card); color: var(--warm); border-color: var(--warm); }
        .btn-explore.active { background: var(--bg-card); border-color: var(--bg-card); color: var(--text-dim); }
        .btn-explore .explore-progress { position: absolute; bottom: 0; left: 0; height: 3px; background: var(--teal); width: 0%; transition: width 0.1s linear; }
        .btn-explore.active .explore-progress { animation: exploreCountdown 5s linear forwards; }
        @keyframes exploreCountdown { from { width: 0%; } to { width: 100%; } }
        @keyframes shuffleStart {
            0% { transform: scale(1) rotate(0deg); }
            20% { transform: scale(1.1) rotate(-3deg); }
            40% { transform: scale(0.95) rotate(2deg); }
            60% { transform: scale(1.05) rotate(-1deg); }
            80% { transform: scale(0.98) rotate(1deg); }
            100% { transform: scale(1) rotate(0deg); }
        }
        .btn-explore.shuffling { animation: shuffleStart 0.5s ease-out; }

        /* Collapsible filters */
        .filters-toggle { display: flex; justify-content: space-between; align-items: center; padding: 10px 18px; background: var(--bg-input); border-radius: 50px; cursor: pointer; margin-bottom: 10px; }
        .filters-toggle span { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); }
        .filters-toggle .toggle-icon { transition: transform 0.2s; }
        .filters-section.collapsed .filters-toggle .toggle-icon { transform: rotate(-90deg); }
        .filters-section.collapsed .filters-content { display: none; }
        .filters-section { margin-bottom: 12px; }

        /* Metadata section collapsible */
        .metadata-section { margin-bottom: 8px; }
        .metadata-toggle { display: flex; justify-content: space-between; align-items: center; padding: 10px 18px; background: var(--bg-input); border-radius: 50px; cursor: pointer; margin-bottom: 8px; }
        .metadata-toggle span { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); }
        .metadata-toggle .toggle-icon { transition: transform 0.2s; }
        .metadata-section.collapsed .metadata-toggle .toggle-icon { transform: rotate(-90deg); }
        .metadata-section.collapsed .metadata-content { display: none; }
        .filters-content { padding-top: 6px; padding-bottom: 8px; }
        .metadata-content { padding-bottom: 8px; }

        /* Checkbox filter */
        .checkbox-filter { display: flex; align-items: center; gap: 10px; padding: 10px 18px; background: var(--bg-input); border-radius: 50px; cursor: pointer; margin-bottom: 8px; }
        .checkbox-filter input { appearance: none; -webkit-appearance: none; width: 10px; height: 10px; border-radius: 50%; background: transparent; border: none; cursor: pointer; transition: all 0.2s ease; }
        .checkbox-filter input:checked { background: rgba(255, 107, 53, 0.4); border: none; }
        .checkbox-filter label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); cursor: pointer; }

        /* Grid size toggle button - cycles through sizes */
        .grid-size-toggle { width: 32px; height: 32px; padding: 0; border: none; border-radius: 50%; background: var(--bg-input); color: var(--text-muted); cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .grid-size-toggle:hover { background: var(--bg-card); color: var(--text); }
        .grid-size-toggle .size-icon { display: grid; transition: all 0.2s ease; }
        .grid-size-toggle .size-icon b { display: block; background: currentColor; aspect-ratio: 1; }
        /* Single large square */
        .grid-size-toggle .size-icon.size-1 { grid-template-columns: 14px; grid-template-rows: 14px; }
        .grid-size-toggle .size-icon.size-1 b { border-radius: 2px; }
        /* 2x2 grids - different sizes */
        .grid-size-toggle .size-icon.size-2 { grid-template-columns: repeat(2, 7px); grid-template-rows: repeat(2, 7px); gap: 2px; }
        .grid-size-toggle .size-icon.size-2 b { border-radius: 1px; }
        .grid-size-toggle .size-icon.size-3 { grid-template-columns: repeat(2, 6px); grid-template-rows: repeat(2, 6px); gap: 2px; }
        .grid-size-toggle .size-icon.size-3 b { border-radius: 1px; }
        .grid-size-toggle .size-icon.size-4 { grid-template-columns: repeat(2, 5px); grid-template-rows: repeat(2, 5px); gap: 2px; }
        .grid-size-toggle .size-icon.size-4 b { border-radius: 1px; }
        /* 3x3 grids */
        .grid-size-toggle .size-icon.size-6 { grid-template-columns: repeat(3, 4px); grid-template-rows: repeat(3, 4px); gap: 1px; }
        .grid-size-toggle .size-icon.size-6 b { border-radius: 1px; }
        .grid-size-toggle .size-icon.size-8 { grid-template-columns: repeat(3, 3px); grid-template-rows: repeat(3, 3px); gap: 1px; }
        .grid-size-toggle .size-icon.size-8 b { border-radius: 0; }
        /* 4x4 grids */
        .grid-size-toggle .size-icon.size-10 { grid-template-columns: repeat(4, 3px); grid-template-rows: repeat(4, 3px); gap: 1px; }
        .grid-size-toggle .size-icon.size-10 b { border-radius: 0; }
        .grid-size-toggle .size-icon.size-12 { grid-template-columns: repeat(4, 2px); grid-template-rows: repeat(4, 2px); gap: 1px; }
        .grid-size-toggle .size-icon.size-12 b { border-radius: 0; }
        .grid-size-toggle .size-icon.size-auto { grid-template-columns: repeat(4, 2px); grid-template-rows: repeat(4, 2px); gap: 1px; opacity: 0.6; }
        .grid-size-toggle .size-icon.size-auto b { border-radius: 0; }

        /* Grid column variations */
        .grid-items.grid-2-col, .grid-group-items.grid-2-col { grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .grid-items.grid-3-col, .grid-group-items.grid-3-col { grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .grid-items.grid-4-col, .grid-group-items.grid-4-col { grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .grid-items.grid-6-col, .grid-group-items.grid-6-col { grid-template-columns: repeat(6, 1fr); gap: 5px; }
        .grid-items.grid-8-col, .grid-group-items.grid-8-col { grid-template-columns: repeat(8, 1fr); gap: 4px; }
        .grid-items.grid-auto, .grid-group-items.grid-auto { grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 4px; }

        /* Favorites grid - clean, spacious layout */
        .grid-items.favorites-grid { gap: 16px; padding: 20px; width: 100%; }
        .grid-items.favorites-grid.grid-2-col { gap: 24px; }
        .grid-items.favorites-grid.grid-3-col { gap: 20px; }
        .grid-items.favorites-grid.grid-4-col { gap: 16px; }
        .grid-items.favorites-grid .grid-item { border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); }

        /* Collectors button in grid - brighter when not clicked, muted when active */
        .grid-mode-btn.collectors-btn { background: transparent; border-color: var(--border); color: var(--text-muted); opacity: 0.6; }
        .grid-mode-btn.collectors-btn:hover { background: rgba(255,255,255,0.03); border-color: var(--text-muted); color: var(--text-dim); opacity: 0.8; }
        .grid-mode-btn.collectors-btn.active { opacity: 0.25; border-color: transparent; color: var(--text-muted); background: transparent; }
        .grid-mode-btn.favorites-active { background: #FF6B4A; border-color: #FF6B4A; color: #fff; }
        .grid-mode-btn.favorites-active:hover { background: #ff8566; border-color: #ff8566; color: #fff; }
        /* Legacy size icon classes - kept for backwards compatibility */
        .size-small { width: 8px; height: 8px; display: block; background: currentColor; border-radius: 2px; }
        .size-medium { width: 12px; height: 12px; display: block; background: currentColor; border-radius: 2px; }
        .size-large { width: 16px; height: 16px; display: block; background: currentColor; border-radius: 2px; }

        /* Palette inspector */
        .palette-inspector { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 9, 16, 0.95); z-index: 1000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(10px); overflow-y: auto; }
        .palette-inspector.open { display: flex; }
        .palette-inspector-content { text-align: center; padding: 40px; max-width: 600px; }
        .palette-inspector-meta { display: flex; gap: 16px; justify-content: center; margin-bottom: 16px; flex-wrap: wrap; }
        .palette-meta-item { padding: 6px 12px; background: var(--bg-input); border-radius: 8px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-dim); }
        .palette-meta-item span { color: var(--teal); margin-left: 6px; }
                .palette-inspector-name { font-size: 42px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.12em; margin-bottom: 20px; line-height: 1.1; }
        .palette-inspector-colors { margin-bottom: 30px; }
        .palette-color-section { margin-bottom: 20px; }
        .palette-color-section-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 10px; }
        .palette-color-row { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; }
        .palette-color-chip { width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0; font-weight: 600; letter-spacing: 0.02em; text-transform: uppercase; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        .palette-color-chip:hover { transform: scale(1.2); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .palette-color-chip.expanded { border-radius: 14px; width: auto; min-width: 70px; padding: 0 10px; font-size: 8px; height: 28px; }
        .palette-color-chip.bg-chip { width: 100%; height: 40px; border-radius: 10px; font-size: 9px; margin-bottom: 8px; box-shadow: none; }
        .palette-color-chip.bg-chip:hover { border-radius: 10px; transform: none; }
        .palette-inspector-similar { margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--border); }
        .palette-inspector-similar-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 12px; }
        .similar-palettes-row { display: flex; gap: 8px; justify-content: center; flex-wrap: wrap; }
        .similar-palette-chip { padding: 8px 14px; border-radius: 20px; font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; cursor: pointer; transition: all 0.3s ease; }
        .similar-palette-chip:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .palette-inspector-close { background: var(--bg-input); border: none; color: var(--text-dim); padding: 14px 32px; border-radius: 50px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; transition: all 0.3s ease; margin-top: 24px; }
        .palette-inspector-close:hover { background: var(--bg-card); color: var(--text); }
        .palette-inspector-hex-toggle { display: flex; align-items: center; justify-content: center; gap: 8px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); cursor: pointer; margin: 20px 0; }
        .palette-inspector-hex-toggle input { appearance: none; -webkit-appearance: none; width: 10px; height: 10px; border-radius: 50%; background: var(--bg-card); border: 2px solid var(--text-muted); cursor: pointer; transition: all 0.2s ease; }
        .palette-inspector-hex-toggle input:checked { background: var(--purple); border-color: var(--purple); }
        .palette-inspector-hex { display: none; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 20px; }
        .palette-inspector-hex.visible { display: flex; }
        .palette-inspector-hex span { font-size: 10px; font-weight: 600; color: var(--text-muted); background: var(--bg-input); padding: 6px 10px; border-radius: 6px; font-family: monospace; }
        .btn-inspect { background: transparent; border: 1px solid var(--border); color: var(--text-dim); }
        .btn-inspect:hover { border-color: var(--teal); color: var(--teal); }

        /* Framed Mockup View - off-white wall with floater frame */
        .frame-mockup {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            /* Off-white warm wall */
            background: #f5f3f0;
            z-index: 2000; display: none; align-items: center; justify-content: center;
        }
        .frame-mockup.open { display: flex; }
        /* Subtle lighting on wall - soft gray shadow rectangles */
        .frame-mockup::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background:
                /* Top-left light source glow */
                radial-gradient(ellipse 80% 60% at 25% 25%, rgba(255,255,255,0.6) 0%, transparent 50%),
                /* Subtle bottom-right shadow */
                radial-gradient(ellipse 70% 50% at 80% 85%, rgba(0,0,0,0.04) 0%, transparent 40%);
            pointer-events: none;
        }
        .frame-mockup-content { display: flex; align-items: center; justify-content: center; padding: 60px; width: 100%; height: 100%; position: relative; }
        /* Off-white floater frame */
        .frame-wrapper {
            position: relative;
            background: #faf9f7; /* Off-white frame */
            padding: 12px; /* Thin frame face */
            max-width: 80vw;
            max-height: 80vh;
            /* Frame shadow on wall - blurry gray rectangles */
            box-shadow:
                /* Main drop shadow - blurry */
                8px 12px 30px rgba(0,0,0,0.18),
                15px 20px 50px rgba(0,0,0,0.12),
                /* Tighter shadow for depth */
                3px 4px 10px rgba(0,0,0,0.1);
        }
        /* Deep shadow recess between frame and art */
        .frame-inner {
            position: relative;
            /* Subtle dark gap between frame and art */
            background: #2a2826;
            padding: 4px; /* Float gap */
            /* Lighter inner shadow for subtle depth */
            box-shadow:
                inset 0 0 4px rgba(0,0,0,0.4),
                inset 0 1px 2px rgba(0,0,0,0.3);
        }
        /* The art floats above the shadow */
        .frame-inner img {
            display: block;
            width: 100%;
            height: auto;
            max-height: calc(80vh - 34px);
            object-fit: contain;
            position: relative;
            /* Art lifts slightly from the dark recess */
            box-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        .frame-mockup-close { position: absolute; top: 24px; right: 24px; width: 44px; height: 44px; border: none; background: rgba(255,255,255,0.95); color: #555; font-size: 20px; cursor: pointer; border-radius: 50%; box-shadow: 0 2px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; z-index: 10; }
        .frame-mockup-close:hover { background: #333; color: #fff; transform: scale(1.05); }
        .frame-mockup-download { position: absolute; top: 24px; right: 80px; width: 44px; height: 44px; border: none; background: rgba(255,255,255,0.95); color: #555; font-size: 20px; cursor: pointer; border-radius: 50%; box-shadow: 0 2px 12px rgba(0,0,0,0.15); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; z-index: 10; font-weight: bold; }
        .frame-mockup-download:hover { background: var(--teal); color: #000; transform: scale(1.05); }

        hr { border: none; height: 1px; background: linear-gradient(90deg, transparent, var(--border), transparent); margin: 12px 0; }

        .main-content { position: fixed; top: 0; left: 300px; right: 0; bottom: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; z-index: 5; pointer-events: none; box-sizing: border-box; }
        .main-content > * { pointer-events: auto; }
        .frame-container { position: relative; overflow: hidden; cursor: pointer; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), border-radius 0.3s ease-out; display: flex; align-items: center; justify-content: center; }
        .frame-container:hover { transform: scale(1.02); border-radius: 24px; }
        .preview-image { max-height: calc(100vh - 240px); max-width: 100%; width: auto; height: auto; display: block; transition: opacity 0.3s ease-out; object-fit: contain; }
        .bottom-info { margin-top: 12px; display: flex; flex-direction: column; align-items: center; gap: 6px; width: 100%; }
        .preview-image.fade-out { opacity: 0; }

        /* Explore fullscreen button - hidden, exit via ESC/space */
        .explore-fullscreen-btn { display: none !important; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }

        /* Fullscreen mode */
        body.fullscreen-mode .sidebar, body.fullscreen-mode .gallery-toggle, body.fullscreen-mode .collectors-toggle, body.fullscreen-mode .mint-toggle,
        body.fullscreen-mode .mobile-menu-toggle, body.fullscreen-mode .bottom-info, body.fullscreen-mode .top-nav-fixed, body.fullscreen-mode .mobile-bottom-bar,
        body.fullscreen-mode .pull-refresh-indicator { display: none !important; }
        body.fullscreen-mode .main-content { padding: 0; left: 0; }
        body.fullscreen-mode .frame-container { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; border-radius: 0; background: var(--bg-deep); }
        body.fullscreen-mode .preview-image { max-height: 100vh; max-width: 100vw; width: auto; height: auto; object-fit: contain; opacity: 0; transition: opacity 0.3s ease-out; }
        body.fullscreen-mode .preview-image.loaded { opacity: 1; }
        body.fullscreen-mode .click-to-view { display: none; }
        .fullscreen-exit-hint { display: none !important; }

        /* City note section - minimal, floats on background */
        .city-note { margin: 12px 0; display: none; }
        .city-note.visible { display: block; }
        .city-note textarea { width: 100%; padding: 4px 0; background: transparent; border: none; border-bottom: 1px solid var(--border); color: var(--text-muted); font-size: 9px; font-family: inherit; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; resize: none; transition: all 0.3s ease; line-height: 1.4; overflow: hidden; }
        .city-note textarea:focus { outline: none; border-bottom-color: var(--text-muted); color: var(--text); }
        .city-note textarea::placeholder { color: var(--text-muted); font-style: italic; text-transform: none; letter-spacing: 0; opacity: 0.5; }
        .city-note.has-note textarea { color: var(--text-dim); border-bottom-color: var(--text-muted); }
        .loading-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-card); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; transition: opacity 0.3s; }
        .loading-overlay.hidden { opacity: 0; pointer-events: none; }
        .spinner { width: 32px; height: 32px; border: 3px solid var(--bg-input); border-top-color: var(--teal); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 12px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { color: var(--text-muted); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; }
        .click-to-view { position: absolute; bottom: 0; left: 0; right: 0; padding: 8px 12px; background: linear-gradient(transparent, rgba(10, 9, 16, 0.9)); text-align: center; color: var(--teal); font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; opacity: 0; transition: opacity 0.3s; }
        .frame-container:hover .click-to-view { opacity: 1; }

        .info-display { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); text-align: center; padding: 8px 16px; background: var(--bg-panel); border-radius: 12px; }
        .info-display .token-id { color: var(--teal); }
        .info-display .token-line { margin-bottom: 4px; }
        .owner-display { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-top: 8px; margin-bottom: 4px; }
        .owner-display a { color: var(--text); text-decoration: none; font-weight: 700; }
        .owner-display a:hover { color: var(--teal); }

        /* Similar outputs */
        .similar-outputs { padding: 0; width: 100%; display: flex; flex-direction: column; align-items: center; opacity: 0.5; transition: opacity 0.3s ease; }
        .similar-outputs:hover { opacity: 0.85; }
        .similar-outputs-label { font-size: 7px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); margin-bottom: 8px; opacity: 0.5; }
        .similar-outputs-grid { display: flex; gap: 6px; justify-content: center; flex-wrap: wrap; max-width: 320px; }
        .similar-output { width: 48px; height: 85px; border-radius: 6px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .similar-output:hover { transform: scale(1.1) translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.4); }
        .similar-output img { width: 100%; height: 100%; object-fit: cover; }
        .similar-output-id { position: absolute; bottom: 0; left: 0; right: 0; padding: 6px; background: rgba(10, 9, 16, 0.85); font-size: 10px; font-weight: 700; text-align: center; color: var(--text); opacity: 0; transition: opacity 0.2s ease; }
        .similar-output:hover .similar-output-id { opacity: 1; }

        /* Stats summary */
        .stats-summary { text-align: center; padding: 10px 16px; font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
        .stats-summary strong { color: var(--teal); }
        .grid-stats-bar { display: none; justify-content: center; gap: 16px; padding: 8px 28px; background: var(--bg-card); font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
        .grid-stats-bar.visible { display: flex; }
        .grid-stats-bar strong { color: var(--teal); }

        .top-nav-fixed { position: fixed; top: 24px; right: 24px; z-index: 600; display: flex; gap: 0; align-items: center; }
        .view-toggle-btn { width: 40px; height: 40px; min-width: 40px; border: none; border-radius: 50%; background: var(--bg-panel); color: var(--text-dim); font-size: 20px; font-weight: 300; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-left: -4px; }
        .view-toggle-btn:first-child { margin-left: 0; }
        .view-toggle-btn:hover { background: var(--bg-card); color: var(--text); }
        .view-toggle-btn.grid-open { transform: rotate(45deg); }
        .mint-toggle { display: flex; align-items: flex-end; text-decoration: none; padding: 4px 3px; flex-shrink: 0; gap: 1px; opacity: 0.6; transition: opacity 0.3s ease; margin-right: 16px; }
        .mint-toggle:hover { opacity: 1; }
        .mint-letter { height: 20px; width: auto; display: block; transition: transform 0.15s ease, filter 0.3s ease; }
        .mint-toggle:hover .mint-letter { filter: brightness(1.1); animation: letterVibrate 0.3s ease-in-out infinite; }
        .mint-toggle:hover .mint-letter:nth-child(2) { animation-delay: 0.06s; }
        .mint-toggle:hover .mint-letter:nth-child(3) { animation-delay: 0.12s; }
        .mint-toggle:hover .mint-letter:nth-child(4) { animation-delay: 0.18s; }
        .mint-letter.wave { animation: letterWave 0.6s ease-out !important; }
        /* Subtle M only in single view */
        body:not(.grid-open) .mint-toggle { opacity: 0.3; }
        body:not(.grid-open) .mint-toggle:hover { opacity: 0.6; }
        body:not(.grid-open) .mint-letter { height: 14px; }
        body:not(.grid-open) .mint-letter:not(:first-child) { display: none; }
        @keyframes letterWave { 0% { transform: translateY(0) rotate(0deg); } 30% { transform: translateY(-5px) rotate(-4deg); } 50% { transform: translateY(-2px) rotate(2deg); } 70% { transform: translateY(-3px) rotate(-1deg); } 100% { transform: translateY(0) rotate(0deg); } }
        @keyframes letterVibrate { 0%, 100% { transform: translate(0, 0) rotate(0deg); } 50% { transform: translate(0.5px, -0.5px) rotate(0.5deg); } }

        .gallery-panel { position: fixed; top: 0; right: -380px; width: 380px; height: 100vh; background: var(--bg-panel); padding: 28px 24px; overflow-y: auto; transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1); z-index: 99; }
        .gallery-panel.open { right: 0; }
        .gallery-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; }
        .gallery-header h2 { font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.12em; color: var(--pink); }
        .gallery-close { background: var(--bg-input); border: none; color: var(--text-dim); width: 32px; height: 32px; border-radius: 50%; font-size: 16px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .gallery-close:hover { background: var(--bg-card); color: var(--text); }
        .gallery-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .gallery-item { position: relative; cursor: pointer; border-radius: 16px; overflow: hidden; background: var(--bg-card); aspect-ratio: 9/16; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .gallery-item:hover { transform: scale(1.03); }
        .gallery-item .item-info { width: 100%; height: 100%; position: relative; background: var(--bg-card); }
        .gallery-item .item-info img { width: 100%; height: 100%; object-fit: cover; display: block; }
        .gallery-item-id { position: absolute; bottom: 0; left: 0; right: 0; padding: 6px; background: linear-gradient(transparent, rgba(10, 9, 16, 0.9)); font-size: 10px; font-weight: 700; text-align: center; color: var(--text); }
        .gallery-item .item-actions { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 9, 16, 0.92); display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; opacity: 0; transition: opacity 0.2s; }
        .gallery-item:hover .item-actions { opacity: 1; }
        .item-actions button { padding: 12px 20px; border: none; border-radius: 50px; cursor: pointer; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; width: 80%; transition: all 0.3s ease; }
        .item-actions .load-btn { background: var(--teal); color: #000; }
        .item-actions .delete-btn { background: transparent; color: var(--pink); }
        .empty-gallery { grid-column: 1 / -1; text-align: center; color: var(--text-muted); padding: 60px 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.08em; line-height: 2; }

        /* Favorited palettes section - horizontal bar at top */
        .fav-palettes-section { margin-bottom: 16px; padding: 12px; background: var(--bg-card); border-radius: 12px; }
        .fav-palettes-header { font-size: 8px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.12em; color: var(--text-muted); margin-bottom: 10px; }
        .fav-palettes-grid { display: flex; gap: 6px; overflow-x: auto; padding-bottom: 4px; }
        .fav-palettes-grid::-webkit-scrollbar { height: 3px; }
        .fav-palettes-grid::-webkit-scrollbar-track { background: transparent; }
        .fav-palettes-grid::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
        .fav-palette-item { display: flex; align-items: center; gap: 6px; padding: 6px 10px; background: var(--bg-input); border-radius: 8px; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
        .fav-palette-item:hover { background: var(--bg-deep); transform: scale(1.02); }
        .fav-palette-swatch { width: 18px; height: 18px; border-radius: 4px; flex-shrink: 0; }
        .fav-palette-name { font-size: 9px; font-weight: 700; color: var(--text); text-transform: uppercase; letter-spacing: 0.03em; white-space: nowrap; }
        .fav-palette-count { display: none; }
        .fav-palette-remove { width: 16px; height: 16px; font-size: 10px; }
        .fav-palette-remove { width: 20px; height: 20px; border: none; background: transparent; color: var(--text-muted); font-size: 12px; cursor: pointer; border-radius: 50%; transition: all 0.2s; display: flex; align-items: center; justify-content: center; margin-left: auto; }
        .fav-palette-remove:hover { background: var(--bg-input); color: var(--orange); }
        .fav-divider { height: 1px; background: var(--border); margin: 16px 0; }

        .keyboard-hints { margin-top: auto; padding-top: 24px; }
        .keyboard-hints h3 { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.15em; color: var(--text-muted); margin-bottom: 14px; }
        .hint-row { display: flex; justify-content: space-between; align-items: center; font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); margin-bottom: 10px; }
        .hint-row kbd { background: var(--bg-input); padding: 5px 10px; border-radius: 8px; font-family: inherit; font-size: 9px; font-weight: 700; }

        .token-nav { display: flex; gap: 8px; align-items: center; }
        .token-nav button { padding: 12px 16px; background: var(--bg-input); border: none; color: var(--text-dim); border-radius: 50px; cursor: pointer; font-size: 14px; font-weight: 700; transition: all 0.3s ease; }
        .token-nav button:hover { background: var(--bg-card); color: var(--teal); }
        .token-input-wrapper { flex: 1; position: relative; display: flex; align-items: center; }
        .token-hash { position: absolute; left: 14px; color: var(--text-muted); font-size: 13px; font-weight: 600; pointer-events: none; z-index: 1; }
        .token-nav input { flex: 1; text-align: center; padding-left: 28px !important; }

        .status-message { position: fixed; bottom: 32px; left: 50%; transform: translateX(-50%) translateY(20px); background: var(--bg-card); padding: 16px 28px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; opacity: 0; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1000; }
        .status-message.visible { opacity: 1; transform: translateX(-50%) translateY(0); }
        .status-message.success { background: var(--teal); color: #000; }
        .status-message.error { background: var(--pink); color: #fff; }

        .filter-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .filter-grid .control-group { margin-bottom: 0; }
        .filter-grid .control-group label { font-size: 8px; margin-bottom: 4px; }
        .filter-grid select { font-size: 8px !important; padding: 6px 10px; background-position: right 10px center; padding-right: 26px; }
        .filter-actions { display: flex; gap: 8px; margin-top: 12px; }
        .filter-actions .btn { margin-bottom: 0; padding: 10px 12px; }
        .btn-clear { background: var(--bg-input); color: var(--text-dim); }
        .btn-clear:hover { background: var(--bg-card); color: var(--orange); }
        .btn-random-filter { background: var(--yellow); color: #000; }
        .btn-random-filter:hover { background: var(--orange); }
        .match-count { text-align: center; font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; color: var(--text-muted); margin: 16px 0 12px; padding: 0; }
        .match-count:empty { display: none; margin: 0; }
        .match-count strong { color: var(--teal); font-weight: 700; }

        .traits-display { padding: 14px; background: var(--bg-input); border-radius: 14px; font-size: 10px; min-height: 120px; max-height: 200px; overflow-y: auto; }
        .traits-display .trait-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.05em; gap: 8px; }
        .traits-display .trait-row:last-child { margin-bottom: 0; }
        .traits-display .trait-name { color: var(--text-muted); font-weight: 600; flex-shrink: 0; }
        .traits-display .trait-value { color: var(--text); font-weight: 700; flex: 1; text-align: right; }
        .traits-display .trait-rarity { font-size: 8px; color: var(--text-muted); background: var(--bg-card); padding: 2px 6px; border-radius: 4px; flex-shrink: 0; }
        .traits-display .trait-rarity.rare { color: var(--orange); background: rgba(255, 140, 66, 0.15); }
        .traits-display .trait-swatches { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }

        .collection-link { display: block; text-align: center; padding: 14px 20px; background: var(--bg-input); border-radius: 50px; color: var(--text-dim); text-decoration: none; font-size: 10px; font-weight: 700; letter-spacing: 0.1em; transition: all 0.3s ease; }
        .collection-link:hover { background: var(--bg-card); color: var(--teal); }
        .marketplace-links { display: flex; gap: 6px; flex-wrap: wrap; }
        .marketplace-link { flex: 1; min-width: 70px; padding: 10px 12px; background: var(--bg-input); border-radius: 50px; color: var(--text-dim); text-decoration: none; font-size: 9px; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; text-align: center; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .marketplace-link:hover { background: var(--bg-card); color: var(--teal); transform: translateY(-1px); }
        .marketplace-link.opensea:hover { color: #2081E2; }
        .marketplace-link.artblocks:hover { color: var(--teal); }
        .marketplace-link.raster:hover { color: var(--pink); }
        .marketplace-link.offer-btn { background: var(--warm); border: 2px solid var(--warm); color: #000; font-weight: 800; }
        .marketplace-link.offer-btn:hover { background: var(--orange); border-color: var(--orange); color: #000; box-shadow: 0 4px 16px rgba(232, 184, 109, 0.3); }
        .owner-actions { display: flex; gap: 8px; }
        .owner-actions .marketplace-link { flex: 1; }
        .listing-info { margin-top: 10px; padding: 12px 16px; background: var(--bg-card); border-radius: 12px; display: none; }
        .listing-info.visible { display: block; }
        .listing-info .listing-price { font-size: 16px; font-weight: 800; color: var(--teal); }
        .listing-info .listing-label { font-size: 9px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); margin-bottom: 4px; }
        .listing-info .listing-source { font-size: 9px; color: var(--text-dim); margin-top: 4px; }
        .mint-link { background: linear-gradient(90deg, #F4A261, #E07B5A, #C77B8B, #9B6B9E, #E07B5A, #F4A261); background-size: 500% 100%; color: #1a1a2e; margin-bottom: 10px; animation: colorShift 15s ease-in-out infinite; }
        .mint-link:hover { box-shadow: 0 4px 16px rgba(224, 123, 90, 0.3); color: #1a1a2e; animation: colorShift 8s ease-in-out infinite; }
        @keyframes colorShiftFast { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        /* Mint countdown */
        .mint-countdown { display: flex; align-items: center; justify-content: space-between; padding: 5px 10px; background: var(--bg-input); border-radius: 50px; margin-bottom: 6px; font-size: 7px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.06em; opacity: 0.5; transition: opacity 0.3s ease; }
        .mint-countdown:hover { opacity: 0.8; }
        .countdown-label { color: var(--text-muted); }
        .countdown-timer { color: var(--text-dim); font-variant-numeric: tabular-nums; }
        .mint-countdown.ended { display: none; }

        .supply-tracker { display: block; text-decoration: none; transition: all 0.4s ease; cursor: pointer; position: relative; margin-bottom: 12px; }
        .supply-bar { position: relative; height: 18px; background: var(--bg-input); border-radius: 9px; overflow: hidden; }
        .supply-fill { position: absolute; top: 0; left: 0; height: 100%; background: linear-gradient(90deg, #D4A574, #E8B86D, #D4A574); background-size: 200% 100%; border-radius: 9px; transition: width 0.5s ease; animation: supplyShimmer 15s ease-in-out infinite; }
        @keyframes supplyShimmer { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
        .supply-label { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; padding: 0 10px; font-size: 9px; font-weight: 600; letter-spacing: 0.12em; color: #000; z-index: 2; }
        .supply-tracker .mint-text { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; justify-content: center; opacity: 0; color: #fff; font-size: 8px; font-weight: 700; letter-spacing: 0.1em; transition: opacity 0.3s ease; z-index: 3; border-radius: 9px; background: linear-gradient(90deg, var(--orange), var(--yellow), var(--pink), var(--orange)); background-size: 300% 100%; animation: colorShift 12s ease-in-out infinite; }
        .supply-tracker:hover .supply-bar { box-shadow: 0 2px 8px rgba(212, 165, 116, 0.25); }
        .supply-tracker:hover .mint-text { opacity: 1; }
        .supply-tracker.sold-out .supply-fill { background: linear-gradient(90deg, var(--orange), var(--warm)); }
        .supply-tracker.sold-out .supply-label { color: #fff; }

        .collectors-toggle { display: none; }
        .collectors-panel { position: fixed; top: 0; right: -420px; width: 420px; height: 100vh; background: var(--bg-panel); padding: 28px 24px; overflow-y: auto; transition: right 0.35s cubic-bezier(0.4, 0, 0.2, 1); z-index: 550; pointer-events: none; }
        .collectors-panel.open { right: 0; pointer-events: auto; }
        .collectors-panel::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 6px; height: 80px; background: var(--border); border-radius: 0 4px 4px 0; cursor: ew-resize; transition: background 0.2s, width 0.2s, opacity 0.2s; opacity: 0; pointer-events: none; }
        .collectors-panel.open::before { opacity: 1; pointer-events: auto; }
        .collectors-panel.open:hover::before, .collectors-panel.dragging::before { background: var(--teal); width: 8px; }
        .gallery-panel::before { content: ''; position: absolute; left: 0; top: 50%; transform: translateY(-50%); width: 6px; height: 80px; background: var(--border); border-radius: 0 4px 4px 0; cursor: ew-resize; transition: background 0.2s, width 0.2s, opacity 0.2s; opacity: 0; pointer-events: none; }
        .gallery-panel.open::before { opacity: 1; pointer-events: auto; }
        .gallery-panel.open:hover::before, .gallery-panel.dragging::before { background: var(--pink); width: 8px; }
        .collectors-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .collectors-header h2 { font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.12em; color: #fff; display: flex; align-items: center; gap: 6px; }
        .collectors-header .collapse-arrow { font-size: 14px; opacity: 0.6; transition: all 0.2s ease; }
        .collectors-header h2:hover .collapse-arrow { opacity: 1; }
        .collectors-close { background: var(--bg-input); border: none; color: var(--text-dim); width: 32px; height: 32px; border-radius: 50%; font-size: 16px; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; }
        .collectors-close:hover { background: var(--bg-card); color: var(--text); }
        .collectors-stats { text-align: center; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); margin-bottom: 20px; padding: 12px 18px; background: var(--bg-input); border-radius: 50px; }
        .collectors-stats strong { color: var(--teal); }
        .collectors-pills { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; }
        .collector-pill { padding: 8px 14px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; cursor: pointer; transition: transform 0.2s ease-out, filter 0.3s ease, box-shadow 0.3s ease; position: relative; overflow: hidden; white-space: nowrap; }
        .collector-pill::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.15), transparent); transition: left 0.5s ease; }
        .collector-pill:hover::before { left: 100%; }
        .collector-pill:hover { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .collector-pill .pill-count { opacity: 0.7; margin-left: 4px; font-size: 10px; }
        .collector-pill .pill-emoji { display: none; }
        @keyframes waterfallPulse {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.15); }
        }
        .collector-pill { animation: waterfallPulse 3s ease-in-out infinite; }
        .collector-pill:nth-child(1) { animation-delay: 0s; }
        .collector-pill:nth-child(2) { animation-delay: 0.15s; }
        .collector-pill:nth-child(3) { animation-delay: 0.3s; }
        .collector-pill:nth-child(4) { animation-delay: 0.45s; }
        .collector-pill:nth-child(5) { animation-delay: 0.6s; }
        .collector-pill:nth-child(6) { animation-delay: 0.75s; }
        .collector-pill:nth-child(7) { animation-delay: 0.9s; }
        .collector-pill:nth-child(8) { animation-delay: 1.05s; }
        .collector-pill:nth-child(9) { animation-delay: 1.2s; }
        .collector-pill:nth-child(10) { animation-delay: 1.35s; }
        .collector-pill:nth-child(n+11) { animation-delay: calc((var(--pill-index, 0) % 10) * 0.15s); }
        .leaderboard-btn { width: 100%; padding: 12px; background: linear-gradient(90deg, var(--warm), var(--orange), var(--yellow), var(--warm)); background-size: 400% 100%; border: none; border-radius: 16px; color: #000; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; transition: all 0.3s ease; margin-bottom: 10px; animation: colorShift 20s ease-in-out infinite; opacity: 0.85; }
        .leaderboard-btn:hover { opacity: 1; }
        .leaderboard-btn:hover { box-shadow: 0 8px 24px rgba(185, 103, 255, 0.25); }
        @keyframes colorShift { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .back-btn { background: var(--bg-input); color: var(--text-dim); }
        .back-btn:hover { background: var(--bg-card); color: var(--text); box-shadow: none; }
        .leaderboard-view { display: none; }
        .leaderboard-view.active { display: block; }
        .pills-view { display: block; }
        .pills-view.hidden { display: none; }
        .leaderboard-list { list-style: none; }
        .leaderboard-item { margin-bottom: 10px; }
        .leaderboard-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .leaderboard-rank { font-size: 10px; font-weight: 600; color: var(--border); width: 24px; opacity: 0; transition: opacity 0.2s ease; }
        .leaderboard-item:hover .leaderboard-rank { opacity: 1; }
        .leaderboard-name { flex: 1; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; transition: transform 0.2s ease-out; display: inline-block; }
        .leaderboard-item:hover .leaderboard-name { transform: rotate(-1.5deg) translateX(2px); }
        .leaderboard-count { font-size: 12px; font-weight: 800; color: var(--teal); }
        .leaderboard-bar { height: 8px; background: var(--bg-input); border-radius: 4px; overflow: hidden; }
        .leaderboard-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s ease-out; }

        .loading-bar-container { position: fixed; top: 0; left: 0; right: 0; height: 3px; background: var(--bg-panel); z-index: 1000; opacity: 0; transition: opacity 0.3s; }
        .loading-bar-container.visible { opacity: 1; }
        .loading-bar { height: 100%; background: linear-gradient(90deg, #D4A574, #E8B86D, #D4A574); background-size: 200% 100%; animation: shimmer 1.5s ease-in-out infinite; width: 0%; transition: width 0.3s ease-out; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

        /* Grid View Panel */
        .grid-toggle { position: fixed; bottom: 24px; left: 324px; z-index: 100; width: auto; padding: 16px 28px; background: transparent; border: 2px solid var(--purple); color: var(--purple); font-size: 12px; border-radius: 24px; transition: all 0.3s ease, opacity 0.3s ease, transform 0.3s ease; }
        .grid-toggle:hover { background: var(--purple); color: #fff; box-shadow: 0 6px 28px rgba(185, 103, 255, 0.4); transform: translateY(-2px); }
        body.grid-open .grid-toggle { opacity: 0; pointer-events: none; transform: translateY(20px); }
        .grid-panel { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-deep); z-index: 500; display: none; overflow: hidden; }
        .grid-panel.open { display: flex; flex-direction: column; }
        .grid-header { display: flex; justify-content: center; align-items: center; padding: 20px 28px; background: var(--bg-panel); border-bottom: 1px solid var(--border); flex-shrink: 0; gap: 20px; min-height: 70px; position: relative; }
        .grid-brand { position: absolute; left: 28px; display: flex; flex-direction: row; align-items: baseline; gap: 12px; }
        .grid-brand h1 { font-size: 28px; font-weight: 700; text-transform: none; letter-spacing: 0.02em; color: #fff; margin: 0; font-family: Helvetica, Arial, sans-serif; cursor: default; transition: color 0.8s ease, transform 0.8s ease, font-style 0.8s ease; line-height: 1; }
        .grid-artist-logos { display: flex; align-items: baseline; gap: 8px; }
        .grid-artist-logo { height: 16px; width: auto; opacity: 0.5; filter: brightness(0) invert(1); transition: all 0.3s ease; position: relative; top: 1px; }
        .grid-artist-logo.diid-logo { height: 20px; top: -1px; }
        .grid-artist-logo:hover { opacity: 0.9; filter: brightness(0) invert(1) drop-shadow(0 0 8px rgba(212, 165, 116, 0.5)); }
        .grid-artist-logo.ef-logo:hover { animation: logoWiggle 0.4s ease-in-out; }
        .grid-logo-x { font-size: 10px; color: var(--text-muted); opacity: 0.4; position: relative; top: -5px; }
        .grid-controls { display: flex; gap: 10px; align-items: center; }
        .grid-mode-btn { padding: 14px 24px; background: transparent; border: 2px solid var(--mint); border-radius: 50px; color: var(--mint); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; transition: all 0.3s ease; }
        .grid-mode-btn:hover { background: rgba(212, 165, 116, 0.1); border-color: var(--warm); color: var(--warm); }
        .grid-mode-btn.active { background: rgba(232, 184, 109, 0.15); border-color: var(--warm); color: var(--warm); }
        .filter-toggle-bar { display: flex; align-items: center; justify-content: center; padding: 10px 16px; background: var(--bg-panel); border-bottom: 1px solid var(--border); cursor: pointer; }
        .filter-toggle-bar span { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; color: var(--text-muted); }
        .filter-toggle-bar .arrow { margin-left: 6px; font-size: 8px; transition: transform 0.3s ease; }
        .filter-toggle-bar.open .arrow { transform: rotate(180deg); }
        .grid-filter-bar { display: flex; gap: 12px; padding: 0; background: var(--bg-panel); flex-shrink: 0; align-items: center; flex-wrap: wrap; max-height: 0; overflow: hidden; transition: max-height 0.35s cubic-bezier(0.4, 0, 0.2, 1), padding 0.25s ease-out, opacity 0.2s ease-out; border-bottom: none; opacity: 0; }
        .grid-filter-bar.open { max-height: 200px; padding: 16px 28px; border-bottom: 1px solid var(--border); opacity: 1; }
        .grid-filter-bar select { padding: 10px 14px; background: var(--bg-input); border: none; color: var(--text); border-radius: 12px; font-size: 11px; font-family: inherit; font-weight: 600; cursor: pointer; min-width: 150px; color-scheme: dark; }
        .grid-filter-bar select:focus { outline: none; box-shadow: 0 0 0 2px rgba(0, 229, 204, 0.3); }
        .grid-filter-bar select option { background: #1e1d28; color: #fff; padding: 10px 14px; }
        .multi-select { position: relative; min-width: 160px; }
        .multi-select.palette-select { min-width: 220px; }
        .multi-select.bounds-select { min-width: 180px; }
        .multi-select-btn { padding: 10px 16px; background: var(--bg-input); border: none; color: var(--text); border-radius: 50px; font-size: 11px; font-family: inherit; font-weight: 600; cursor: pointer; width: 100%; text-align: left; display: flex; justify-content: space-between; align-items: center; gap: 8px; }
        .multi-select-btn:hover { background: var(--bg-card); }
        .multi-select-btn .arrow { font-size: 8px; opacity: 0.6; }
        .multi-select-btn.has-selection { color: var(--teal); }
        .multi-select-dropdown { position: absolute; top: 100%; left: 0; min-width: 100%; background: var(--bg-card); border-radius: 12px; margin-top: 4px; padding: 8px 0; max-height: 280px; overflow-y: auto; z-index: 1000; display: none; box-shadow: 0 8px 32px rgba(0,0,0,0.4); white-space: nowrap; }
        .palette-select .multi-select-dropdown { min-width: 240px; }
        .bounds-select .multi-select-dropdown { min-width: 200px; }
        .multi-select.open .multi-select-dropdown { display: block; }
        .multi-select-item { display: flex; align-items: center; gap: 10px; padding: 8px 14px; cursor: pointer; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; transition: background 0.2s; }
        .multi-select-item:hover { background: var(--bg-input); }
        .multi-select-item input { appearance: none; -webkit-appearance: none; width: 8px; height: 8px; border-radius: 50%; background: transparent; border: 1.5px solid var(--text-dim); cursor: pointer; flex-shrink: 0; transition: all 0.2s ease; opacity: 0.5; }
        .multi-select-item input:checked { background: var(--text-muted); border-color: var(--text-muted); opacity: 0.7; }
        .multi-select-item.select-all { border-bottom: 1px solid var(--border); margin-bottom: 4px; padding-bottom: 10px; color: var(--text-dim); }
        .multi-select-label { flex: 1; }
        .multi-select-count { font-size: 9px; color: var(--text-muted); font-weight: 500; }
        .multi-select-swatch { display: flex; gap: 2px; padding: 3px; border-radius: 4px; flex-shrink: 0; }
        .multi-select-swatch span { width: 8px; height: 8px; border-radius: 2px; }
        .grid-checkbox { display: flex; align-items: center; gap: 8px; padding: 8px 16px; background: var(--bg-input); border-radius: 50px; font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-dim); cursor: pointer; transition: all 0.3s ease; }
        .grid-checkbox:hover { background: var(--bg-card); color: var(--text); }
        .grid-checkbox input { appearance: none; -webkit-appearance: none; width: 8px; height: 8px; border-radius: 50%; background: transparent; border: 1.5px solid var(--text-dim); cursor: pointer; transition: all 0.2s ease; opacity: 0.5; }
        .grid-checkbox input:checked { background: var(--text-muted); border-color: var(--text-muted); opacity: 0.7; }
        .grid-filter-spacer { flex: 1; }
        .grid-supply-tracker { width: 120px; height: 28px; position: relative; flex-shrink: 0; }
        .grid-supply-bar { position: relative; height: 100%; background: var(--bg-input); border-radius: 14px; overflow: hidden; }
        .grid-supply-fill { position: absolute; top: 0; left: 0; height: 100%; background: linear-gradient(90deg, #D4A574, #E8B86D, #D4A574); background-size: 200% 100%; border-radius: 14px; transition: width 0.5s ease; animation: supplyShimmer 8s ease-in-out infinite; }
        .grid-supply-label { position: absolute; top: 0; left: 0; right: 0; bottom: 0; display: flex; align-items: center; padding: 0 12px; font-size: 9px; font-weight: 700; letter-spacing: 0.05em; color: #000; z-index: 2; }
        .grid-showing-count { font-size: 10px; font-weight: 500; color: var(--text-muted); display: none; letter-spacing: 0.03em; white-space: nowrap; flex-shrink: 0; }
        .grid-showing-count.visible { display: inline; opacity: 0.4; }
        .collector-banner { display: none; align-items: center; justify-content: center; gap: 12px; padding: 14px 24px; background: linear-gradient(90deg, var(--orange), var(--warm)); }
        .collector-banner.visible { display: flex; }
        .collector-banner-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.1em; color: rgba(255,255,255,0.7); }
        .collector-banner-name { font-size: 16px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.1em; color: #fff; }
        .collector-banner-close { background: rgba(255,255,255,0.2); border: none; color: #fff; width: 28px; height: 28px; border-radius: 50%; font-size: 16px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; margin-left: auto; }
        .collector-banner-close:hover { background: rgba(255,255,255,0.3); transform: scale(1.1); }
        .grid-content { flex: 1; overflow-y: auto; padding: 20px; }
        .grid-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; }
        .grid-item { aspect-ratio: 9/16; background: var(--bg-card); border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .grid-item:hover { transform: scale(1.03); box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); z-index: 10; }
        .grid-item.selected { outline: 3px solid var(--teal); }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; }
        .grid-item-label { position: absolute; bottom: 0; left: 0; right: 0; padding: 8px; background: linear-gradient(transparent, rgba(10, 9, 16, 0.9)); font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text); text-align: center; }
        .grid-item-fav { position: absolute; top: 6px; right: 6px; width: 28px; height: 28px; border: none; background: rgba(10, 9, 16, 0.35); color: rgba(255,255,255,0.4); font-size: 14px; cursor: pointer; border-radius: 50%; opacity: 0.6; transition: all 0.2s ease; z-index: 2; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .grid-item:hover .grid-item-fav { opacity: 1; background: rgba(10, 9, 16, 0.7); color: rgba(255,255,255,0.8); }
        .grid-item-fav:hover { background: #fff; color: #333; transform: scale(1.15); }
        .grid-item-fav.favorited { opacity: 1; color: var(--spot-text, #000); background: var(--spot-color, var(--yellow)); box-shadow: 0 2px 12px color-mix(in srgb, var(--spot-color, var(--yellow)) 50%, transparent); backdrop-filter: none; }
        .grid-item-fav.favorited:hover { opacity: 1; background: #fff; color: #333; }
        /* Always show fav buttons on touch devices */
        @media (pointer: coarse) {
            .grid-item-fav { opacity: 0.5; width: 36px; height: 36px; font-size: 16px; }
            .grid-item-fav.favorited { opacity: 1; }
        }
        .grid-item-rank { position: absolute; top: 6px; left: 6px; background: linear-gradient(135deg, var(--orange), var(--yellow)); color: #000; font-size: 9px; font-weight: 800; padding: 3px 6px; border-radius: 4px; z-index: 2; }
        .grid-item-tooltip { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: var(--bg-card); border-radius: 10px; padding: 10px 12px; font-size: 9px; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s, transform 0.2s; z-index: 100; box-shadow: 0 4px 20px rgba(0,0,0,0.4); margin-bottom: 8px; }
        .grid-item:hover .grid-item-tooltip { opacity: 1; transform: translateX(-50%) translateY(-4px); }
        .grid-item-tooltip-row { display: flex; justify-content: space-between; gap: 16px; margin-bottom: 4px; }
        .grid-item-tooltip-row:last-child { margin-bottom: 0; }
        .grid-item-tooltip-label { color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
        .grid-item-tooltip-value { color: var(--text); font-weight: 700; text-transform: uppercase; }
        .grid-item-tooltip-pct { color: var(--text-muted); margin-left: 6px; }
        .grid-item-tooltip-pct.rare { color: var(--orange); }
        .grid-group { margin-bottom: 24px; }
        .grid-group-header { display: flex; align-items: center; gap: 12px; padding: 12px 20px; background: var(--bg-panel); border-radius: 50px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s; }
        .grid-group-header:hover { background: var(--bg-card); }
        .grid-group-fav { width: 24px; height: 24px; border: none; background: transparent; color: var(--spot-color, var(--text-muted)); font-size: 16px; cursor: pointer; border-radius: 50%; transition: all 0.3s ease; flex-shrink: 0; display: flex; align-items: center; justify-content: center; opacity: 0.4; }
        .grid-group-fav:hover { background: rgba(255,255,255,0.1); color: var(--spot-color, var(--pink)); opacity: 1; }
        .grid-group-fav.favorited { color: var(--spot-color, var(--pink)); opacity: 1; }
        .grid-group-shuffle { width: 24px; height: 24px; border: none; background: transparent; color: var(--text-muted); font-size: 12px; cursor: pointer; border-radius: 50%; transition: all 0.3s ease; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .grid-group-shuffle:hover { background: var(--bg-input); color: var(--teal); }
        .grid-group-color { width: 24px; height: 24px; border-radius: 6px; flex-shrink: 0; opacity: 0.7; transition: opacity 0.2s ease; }
        .grid-group-header:hover .grid-group-color { opacity: 1; }
        .grid-group-swatches { display: flex; gap: 0; height: 24px; border-radius: 4px; overflow: hidden; transition: gap 0.3s ease; }
        .grid-group-swatches span { width: 3px; height: 24px; border-radius: 0; transition: width 0.3s ease; }
        .grid-group-header:hover .grid-group-swatches { gap: 3px; }
        .grid-group-header:hover .grid-group-swatches span { width: 14px; border-radius: 3px; }
        .grid-group-name { flex: 1; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text); }
        .grid-group-count { font-size: 11px; font-weight: 700; color: var(--teal); }
        .grid-group-toggle { color: var(--text-muted); font-size: 14px; transition: transform 0.2s; }
        .grid-group.collapsed .grid-group-toggle { transform: rotate(-90deg); }
        .grid-group.collapsed .grid-group-items { display: none !important; }
        .grid-group-items { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px; }
        .grid-pagination { display: flex; justify-content: center; align-items: center; gap: 12px; padding: 20px; flex-shrink: 0; background: var(--bg-panel); border-top: 1px solid var(--border); }
        .grid-pagination button { padding: 12px 20px; background: var(--bg-input); border: none; border-radius: 50px; color: var(--text-dim); font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; cursor: pointer; transition: all 0.3s ease; }
        .grid-pagination button:hover:not(:disabled) { background: var(--bg-card); color: var(--teal); }
        .grid-pagination button:disabled { opacity: 0.4; cursor: not-allowed; }
        .grid-pagination .page-info { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-muted); }
        @media (max-width: 768px) {
            .grid-header { padding: 14px 16px; flex-direction: column; gap: 10px; min-height: auto; align-items: stretch; }
            .grid-brand { position: static; flex-wrap: nowrap; justify-content: flex-start; gap: 8px; align-items: baseline; }
            .grid-brand h1 { font-size: 18px; }
            .grid-controls { order: 2; justify-content: flex-start; }
            .grid-artist-logos { gap: 4px; display: flex; }
            .grid-artist-logo { height: 11px; top: 0; }
            .grid-artist-logo.diid-logo { height: 14px; }
            .grid-logo-x { font-size: 7px; top: -1px; }
            .filter-toggle-bar { padding: 8px 12px; }
            .filter-toggle-bar span { font-size: 9px; }
            .grid-filter-bar.open { padding: 10px 12px; }
            .grid-filter-bar select { min-width: 100px; font-size: 10px; padding: 8px 10px; }
            .grid-checkbox { padding: 6px 10px; font-size: 9px; }
            .grid-content { padding: 8px; }
            .grid-items { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 8px; }
            .grid-group-items { grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)) !important; gap: 8px !important; }
            .grid-controls { flex-wrap: wrap; gap: 6px; justify-content: center; width: 100%; }
            .grid-mode-btn { padding: 10px 16px; font-size: 9px; border-width: 2px; min-height: 40px; }
            .gallery-room-toggle, .grid-size-toggle { width: 40px; height: 40px; font-size: 16px; }
            /* Palette headers on mobile */
            .grid-group-header { padding: 10px 12px; gap: 6px; flex-wrap: nowrap; }
            .grid-group-name { font-size: 10px; letter-spacing: 0.05em; flex: 1 1 auto; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .grid-group-count { font-size: 9px; padding: 2px 6px; flex-shrink: 0; }
            .grid-group-fav, .grid-group-shuffle { width: 32px; height: 32px; font-size: 14px; flex-shrink: 0; }
            .grid-group-toggle { font-size: 12px; flex-shrink: 0; }
            .grid-group-color { width: 22px; height: 22px; flex-shrink: 0; }
            .grid-group-swatches { display: none; }
            .grid-filter-spacer, .grid-supply-tracker, .grid-showing-count { display: none; }
            .grid-stats-bar { padding: 6px 12px; font-size: 8px; gap: 10px; flex-wrap: wrap; justify-content: center; }
            /* Move filter bar to bottom on mobile */
            .grid-panel { display: flex; flex-direction: column; }
            .filter-toggle-bar { order: 10; position: fixed; bottom: 0; left: 0; right: 0; margin: 0; border-radius: 0; z-index: 160; background: var(--bg-panel); border-top: 1px solid var(--border); padding: 14px 16px; }
            .grid-filter-bar { order: 11; position: fixed; bottom: 50px; left: 0; right: 0; z-index: 159; border-radius: 0; max-height: 50vh; overflow-y: auto; }
            .grid-filter-bar.open { padding: 16px; }
            .grid-content { order: 5; padding-bottom: 70px; }
        }

        /* Condensed sidebar for narrow windows */
        @media (max-width: 1200px) {
            .supply-tracker, .grid-supply-tracker { display: none; }
            .filters-section .filters-content, .metadata-section .metadata-content { display: none; }
            .filters-section .toggle-icon, .metadata-section .toggle-icon { transform: rotate(-90deg); }
            .filter-grid { gap: 6px; }
            .filter-grid .control-group label { font-size: 8px; }
            .filter-grid select { font-size: 10px; padding: 8px 12px; }
            .filters-toggle, .metadata-toggle { padding: 8px 14px; }
            .filters-toggle span, .metadata-toggle span { font-size: 8px; }
            .section-label { font-size: 8px; margin: 10px 0 6px; }
            hr { margin: 8px 0; }
        }

        /* Show smaller logos when window is narrow */
        @media (max-width: 1200px) {
            .grid-artist-logos { gap: 4px; }
            .grid-artist-logo { height: 12px; }
            .grid-artist-logo.diid-logo { height: 15px; }
            .grid-logo-x { font-size: 7px; }
        }

        .mobile-menu-toggle { display: none; position: fixed; top: 16px; left: 16px; z-index: 200; width: 40px; height: 40px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 50%; cursor: pointer; flex-direction: column; align-items: center; justify-content: center; gap: 5px; box-shadow: 0 2px 12px rgba(0,0,0,0.3); }
        .mobile-menu-toggle span { display: block; width: 20px; height: 2px; background: var(--text-dim); border-radius: 1px; transition: all 0.3s; }
        .mobile-menu-toggle.active span:nth-child(1) { transform: rotate(45deg) translate(5px, 5px); }
        .mobile-menu-toggle.active span:nth-child(2) { opacity: 0; }
        .mobile-menu-toggle.active span:nth-child(3) { transform: rotate(-45deg) translate(5px, -5px); }
        .sidebar-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 9, 16, 0.8); z-index: 9; opacity: 0; transition: opacity 0.3s; }
        .sidebar-overlay.visible { opacity: 1; }

        @media (max-width: 768px) {
            body { overflow: hidden; }
            .mobile-menu-toggle { display: flex; }
            .sidebar { position: fixed; left: -300px; top: 0; height: 100vh; width: 280px; z-index: 100; transition: left 0.3s ease; overflow-y: auto; }
            .sidebar.open { left: 0; }
            .sidebar-overlay { display: block; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(10, 9, 16, 0.85); z-index: 99; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
            .sidebar-overlay.visible { opacity: 1; pointer-events: auto; }
            .main-content { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; padding: 16px; padding-top: 70px; padding-bottom: 80px; justify-content: center; align-items: center; box-sizing: border-box; }
            .frame-container { width: auto; max-width: calc(100% - 32px); display: flex; align-items: center; justify-content: center; overflow: visible; }
            .preview-image { max-height: calc(100vh - 220px); max-width: 100%; width: auto; height: auto; object-fit: contain; }
            .bottom-info { margin-top: 12px; }
            .top-nav-fixed { top: 12px; right: 12px; gap: 6px; }
            .view-toggle-btn { width: 32px; height: 32px; min-width: 32px; font-size: 16px; }
            .mint-toggle { display: flex; padding: 2px; gap: 0px; }
            .mint-letter { height: 12px; }
            .grid-toggle { bottom: 16px; left: 50%; transform: translateX(-50%); padding: 12px 24px; font-size: 10px; }
            .collectors-toggle { display: none; }
            .gallery-panel, .collectors-panel { width: 100%; right: -100%; }
            .gallery-panel.open, .collectors-panel.open { right: 0; }
            /* Hide the top-nav view toggle when collectors panel is open on mobile to avoid double X */
            body.collectors-open .top-nav-fixed { display: none; }
            .info-display { padding: 8px 12px; font-size: 9px; }
            .status-message { bottom: 80px; padding: 12px 20px; font-size: 10px; }
            .keyboard-hints { display: none; }
            .section-label:first-of-type { margin-top: 0; }
            .similar-outputs { margin-top: 4px; }
        }
        @media (max-width: 480px) {
            .filter-grid { grid-template-columns: 1fr; }
            .btn-group, .share-group { flex-direction: column; }
            .main-content { padding: 12px; padding-top: 60px; padding-bottom: 70px; }
            .preview-image { max-height: calc(100vh - 200px); }
            .bottom-info { margin-top: 8px; gap: 4px; }
            .info-display { padding: 6px 10px; font-size: 8px; }
        }
        @media (pointer: coarse) {
            .btn { min-height: 48px; }
            .token-nav button { min-width: 48px; min-height: 48px; }
            .gallery-item .item-actions { opacity: 1; background: rgba(10, 9, 16, 0.7); }
            /* Larger touch targets for mobile */
            .heart-btn { width: 48px; height: 48px; font-size: 22px; }
            .icon-btn { width: 44px; height: 44px; font-size: 18px; }
            .grid-item-fav { width: 32px; height: 32px; font-size: 14px; }
            .grid-group-fav, .grid-group-shuffle { width: 32px; height: 32px; font-size: 14px; }
        }

        /* Mobile bottom controls bar */
        .mobile-bottom-bar { display: none; }
        @media (max-width: 768px) {
            .mobile-bottom-bar {
                display: flex;
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 64px;
                background: var(--bg-panel);
                border-top: 1px solid var(--border);
                z-index: 150;
                align-items: center;
                justify-content: space-around;
                padding: 0 8px;
                gap: 4px;
            }
            .mobile-bottom-bar button {
                flex: 1;
                height: 48px;
                max-width: 80px;
                border: none;
                border-radius: 12px;
                background: var(--bg-input);
                color: var(--text-dim);
                font-size: 18px;
                cursor: pointer;
                transition: all 0.2s ease;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .mobile-bottom-bar button:active { transform: scale(0.95); background: var(--bg-card); }
            .mobile-bottom-bar button.active { background: var(--teal); color: #000; }
            .mobile-bottom-bar .mobile-heart-btn.favorited { background: var(--pink); color: #fff; }
            /* Adjust main content for bottom bar */
            .main-content { padding-bottom: 80px !important; }
            .grid-toggle { display: none; }
            /* Grid panel needs bottom padding for controls */
            .grid-panel { padding-bottom: 70px; }
            .grid-content { padding-bottom: 80px; }
        }

        /* Pull to refresh indicator */
        .pull-refresh-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: var(--bg-panel);
            border-radius: 0 0 20px 20px;
            color: var(--text-dim);
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            z-index: 200;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            transition: transform 0.2s ease;
        }
        .pull-refresh-indicator.visible { display: block; }
        .pull-refresh-indicator.pulling { color: var(--teal); }
        .pull-refresh-indicator.refreshing { color: var(--warm); }
        .pull-refresh-indicator .refresh-icon { display: inline-block; margin-right: 6px; transition: transform 0.3s ease; }
        .pull-refresh-indicator.refreshing .refresh-icon { animation: spin 0.6s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

        /* Double-tap heart animation */
        .double-tap-heart {
            position: fixed;
            pointer-events: none;
            font-size: 80px;
            z-index: 1000;
            opacity: 0;
            transform: scale(0);
            transition: none;
            color: #FF6B8A;
            text-shadow: 0 0 30px rgba(255, 107, 138, 0.8), 0 0 60px rgba(255, 107, 138, 0.4);
        }
        .double-tap-heart.show {
            animation: doubleTapHeart 0.8s ease-out forwards;
        }
        @keyframes doubleTapHeart {
            0% { opacity: 0; transform: scale(0) rotate(-15deg); }
            15% { opacity: 1; transform: scale(1.3) rotate(5deg); }
            30% { transform: scale(0.9) rotate(-3deg); }
            45% { transform: scale(1.1) rotate(2deg); }
            60% { transform: scale(1) rotate(0deg); }
            100% { opacity: 0; transform: scale(1.2) rotate(0deg); }
        }

        /* Landscape mode on mobile - condense vertical space */
        @media (max-height: 500px) and (orientation: landscape) {
            .grid-header { padding: 8px 16px; gap: 6px; min-height: auto; }
            .grid-brand h1 { font-size: 16px; }
            .grid-artist-logo { height: 10px; }
            .grid-artist-logo.diid-logo { height: 12px; }
            .grid-controls { gap: 4px; }
            .grid-mode-btn { padding: 6px 12px; font-size: 8px; min-height: 32px; }
            .gallery-room-toggle, .grid-size-toggle { width: 32px; height: 32px; font-size: 12px; }
            .filter-toggle-bar { padding: 8px 12px; }
            .grid-filter-bar.open { padding: 8px 12px; }
            .grid-group-header { padding: 6px 10px; }
            .grid-group-name { font-size: 9px; }
            .grid-group-fav, .grid-group-shuffle, .grid-group-color { width: 20px; height: 20px; font-size: 10px; }
            .grid-content { padding: 6px; }
            .grid-items, .grid-group-items { gap: 4px !important; }
            .mobile-bottom-bar { height: 48px; }
            .mobile-bottom-bar button { height: 38px; max-width: 60px; font-size: 14px; }
            .main-content { padding-top: 50px !important; padding-bottom: 60px !important; }
            .top-nav-fixed { top: 8px; right: 8px; gap: 4px; }
            .view-toggle-btn { width: 28px; height: 28px; min-width: 28px; font-size: 14px; }
            .mint-toggle { padding: 1px; }
            .mint-letter { height: 10px; }
            .preview-image { max-height: calc(100vh - 120px); }
            .pull-refresh-indicator { padding: 8px 16px; font-size: 9px; }
        }

        /* Extra condensed for very short landscape screens */
        @media (max-height: 400px) and (orientation: landscape) {
            .grid-header { padding: 6px 12px; flex-direction: row; align-items: center; }
            .grid-brand { gap: 6px; }
            .grid-brand h1 { font-size: 14px; }
            .grid-artist-logos { display: none; }
            .grid-controls { width: auto; }
            .grid-mode-btn { padding: 5px 10px; font-size: 7px; }
            .filter-toggle-bar { padding: 6px 10px; position: static; }
            .grid-filter-bar { position: static; max-height: none; }
            .mobile-bottom-bar { height: 40px; }
            .mobile-bottom-bar button { height: 32px; font-size: 12px; border-radius: 8px; }
            .main-content { padding-top: 40px !important; padding-bottom: 50px !important; }
            .preview-image { max-height: calc(100vh - 100px); }
        }

        /* Smooth orientation change transitions */
        body.orientation-changing * {
            transition: all 0.2s ease !important;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

        /* Whimsical animations */
        /* Token ID slot machine bounce */
        @keyframes slotBounce { 0% { transform: translateY(-4px); opacity: 0; } 50% { transform: translateY(1px); } 100% { transform: translateY(0); opacity: 1; } }
        .token-input-wrapper input.digit-change { animation: slotBounce 0.15s ease-out; }

        /* Similar outputs breathing */
        .similar-output { animation: breathe 3s ease-in-out infinite; }
        .similar-output:nth-child(2) { animation-delay: 0.5s; }
        .similar-output:nth-child(3) { animation-delay: 1s; }
        .similar-output:nth-child(4) { animation-delay: 1.5s; }
        @keyframes breathe { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.015); } }

        /* Owner name typewriter */
        .owner-display a { display: inline-block; }
        .owner-display.typing a span { opacity: 0; animation: typeIn 0.03s ease forwards; }
        @keyframes typeIn { to { opacity: 1; } }

        /* Filter glow when active */
        .filter-grid select.has-value { box-shadow: 0 0 0 1px var(--teal), 0 0 8px rgba(0, 229, 204, 0.2); }
        @keyframes filterPulse { 0% { box-shadow: 0 0 0 1px var(--teal), 0 0 8px rgba(0, 229, 204, 0.2); } 50% { box-shadow: 0 0 0 1px var(--teal), 0 0 12px rgba(0, 229, 204, 0.4); } 100% { box-shadow: 0 0 0 1px var(--teal), 0 0 8px rgba(0, 229, 204, 0.2); } }
        .filter-grid select.just-selected { animation: filterPulse 0.4s ease-out; }

        /* Navigation bounce at limits */
        @keyframes bounceBack { 0% { transform: translateX(0); } 30% { transform: translateX(-3px); } 60% { transform: translateX(1px); } 100% { transform: translateX(0); } }
        @keyframes bounceForward { 0% { transform: translateX(0); } 30% { transform: translateX(3px); } 60% { transform: translateX(-1px); } 100% { transform: translateX(0); } }
        .token-nav button.at-limit-prev { animation: bounceBack 0.3s ease-out; }
        .token-nav button.at-limit-next { animation: bounceForward 0.3s ease-out; }

        /* Preview image settle */
        @keyframes imageSettle { 0% { transform: scale(1.008); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        .preview-image.just-loaded { animation: imageSettle 0.25s ease-out; }

        /* Favorite heart burst */
        @keyframes heartBurst { 0% { transform: scale(1); } 20% { transform: scale(1.3); } 100% { transform: scale(1); } }
        .heart-btn.burst { animation: heartBurst 0.35s ease-out; }
        .heart-particles { position: absolute; top: 50%; left: 50%; pointer-events: none; }
        .heart-particle { position: absolute; width: 4px; height: 4px; border-radius: 50%; animation: particleFly 0.5s ease-out forwards; }
        @keyframes particleFly { 0% { transform: translate(-50%, -50%) scale(1); opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; } }

        /* Side navigation arrows */
        .side-nav-arrow { position: fixed; top: 50%; transform: translateY(-50%); width: 40px; height: 80px; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: opacity 0.3s ease; z-index: 50; color: var(--text-muted); font-size: 20px; }
        .side-nav-arrow:hover { opacity: 0.8 !important; color: var(--text); }
        .side-nav-arrow.left { left: 310px; }
        .side-nav-arrow.right { right: 10px; }
        .main-content:hover ~ .side-nav-arrow, .side-nav-arrow:hover { opacity: 0.3; }
        @media (max-width: 768px) { .side-nav-arrow { display: none; } }

        /* Welcome/loading screen */
        .welcome-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-deep); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.8s ease, visibility 0.8s ease; }
        .welcome-screen.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
        .welcome-content { display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .welcome-greeting { position: absolute; top: 18%; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.4em; color: var(--text-muted); opacity: 0.25; cursor: default; transition: opacity 0.3s ease; }
        .welcome-greeting:hover { opacity: 0.5; }
        .welcome-greeting .phrase { display: none; }
        .welcome-greeting:hover .default { display: none; }
        .welcome-greeting:hover .phrase { display: inline; }
        .welcome-animation-container { position: relative; width: 190px; height: 190px; }
        .welcome-blob, .welcome-city { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); height: 154px; width: auto; transition: opacity 1s ease; }
        .welcome-city { height: 190px; opacity: 0; }
        .welcome-screen.show-city .welcome-blob { opacity: 0; }
        .welcome-screen.show-city .welcome-city { opacity: 1; }
        .welcome-progress-container { width: 118px; height: 2px; background: rgba(255,255,255,0.08); border-radius: 1px; overflow: visible; margin-top: 56px; opacity: 0.5; }
        .welcome-progress-bar { height: 100%; width: 0%; background: rgba(255,255,255,0.4); border-radius: 1px; transition: width 0.3s ease-out; animation: wiggle 1s ease-in-out infinite; transform-origin: left center; }
        @keyframes wiggle {
            0% { transform: translateY(0); }
            12.5% { transform: translateY(-1px); }
            25% { transform: translateY(0); }
            37.5% { transform: translateY(1px); }
            50% { transform: translateY(0); }
            62.5% { transform: translateY(-1px); }
            75% { transform: translateY(0); }
            87.5% { transform: translateY(1px); }
        }
        .welcome-text { font-size: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.4em; color: var(--text-muted); opacity: 0.3; margin-top: 47px; }
        .welcome-logos { display: flex; align-items: center; gap: 7px; opacity: 0; animation: welcomeLogosFadeIn 1.5s ease-out forwards; animation-delay: 0.5s; }
        .welcome-logos.welcome-logos-bottom { position: absolute; bottom: 18%; }
        .welcome-logos .artist-logo { height: 14px; opacity: 0.4; cursor: default; }
        .welcome-logos .artist-logo.diid-logo { height: 18px; }
        .welcome-logos .logo-x { font-size: 8px; color: var(--text-muted); font-weight: 300; opacity: 0.3; }
        @keyframes welcomeLogosFadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Extra grid sizes */
        .grid-items.grid-11-col, .grid-group-items.grid-11-col { grid-template-columns: repeat(11, 1fr); gap: 3px; }
        .grid-items.grid-12-col, .grid-group-items.grid-12-col { grid-template-columns: repeat(12, 1fr); gap: 2px; }
        .grid-items.grid-1-col, .grid-group-items.grid-1-col { grid-template-columns: 1fr; gap: 20px; max-width: 500px; margin: 0 auto; }
        .grid-1-col .grid-item { aspect-ratio: 9/16; border-radius: 12px; }

        /* Immersive Gallery Room - simplified, just art */
        .gallery-room { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: #08070d; z-index: 10000; display: none; overflow: hidden; }
        .gallery-room.open { display: block; animation: galleryFadeIn 0.8s ease-out; }
        @keyframes galleryFadeIn { from { opacity: 0; } to { opacity: 1; } }
        .gallery-room-ambient { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: radial-gradient(ellipse at 50% 120%, rgba(212, 165, 116, 0.05) 0%, transparent 60%); pointer-events: none; }
        .gallery-room-wall { position: absolute; top: 0; left: 0; height: 100%; display: flex; align-items: center; gap: 60px; padding: 0 100px; will-change: transform; }
        .gallery-room-frame { flex-shrink: 0; background: linear-gradient(145deg, #1a1a2e, #12121f); padding: 12px; border-radius: 4px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1); position: relative; cursor: pointer; }
        .gallery-room-frame img { height: 60vh; width: auto; display: block; border-radius: 2px; transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .gallery-room-frame:hover { transform: scale(1.02); }
        .gallery-room-frame:hover img { transform: scale(1.08); }
        .gallery-room-frame-label { display: none; }
        .gallery-room-counter { position: fixed; top: 30px; left: 30px; font-size: 10px; font-weight: 600; color: rgba(255,255,255,0.2); text-transform: uppercase; letter-spacing: 0.15em; opacity: 0; transition: opacity 0.3s ease; }
        .gallery-room:hover .gallery-room-counter { opacity: 1; }
        .gallery-room-close { position: fixed; top: 30px; right: 30px; width: 44px; height: 44px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 50%; color: rgba(255,255,255,0.4); font-size: 20px; cursor: pointer; opacity: 0; transition: all 0.3s ease; z-index: 10001; }
        .gallery-room:hover .gallery-room-close { opacity: 1; cursor: pointer; }
        .gallery-room-close:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .gallery-room-info { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); color: rgba(255,255,255,0.2); font-size: 8px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.2em; opacity: 0; transition: opacity 0.3s ease; }
        .gallery-room:hover .gallery-room-info { opacity: 1; }
        .gallery-room-controls { display: none; }
        .gallery-room-toggle { display: flex; align-items: center; justify-content: center; width: 32px; height: 32px; background: rgba(40, 39, 58, 0.6); border: none; border-radius: 50%; color: var(--text-muted); font-size: 14px; cursor: pointer; transition: all 0.3s ease; opacity: 0.6; }
        .gallery-room-toggle:hover { background: var(--bg-card); color: var(--text); opacity: 1; }

    </style>
</head>
<body>
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-content">
            <div class="welcome-animation-container">
                <img src="loading-goo.gif" alt="Loading" class="welcome-city">
            </div>
            <div class="welcome-text">CITIES</div>
            <div class="welcome-progress-container">
                <div class="welcome-progress-bar" id="welcomeProgressBar"></div>
            </div>
        </div>
        <div class="welcome-logos welcome-logos-bottom">
            <img src="ef-logo.png" alt="Efdot" class="artist-logo ef-logo">
            <span class="logo-x"></span>
            <img src="diid-logo.png" alt="Diid" class="artist-logo diid-logo">
        </div>
    </div>

    <div class="loading-bar-container" id="loadingBarContainer">
        <div class="loading-bar" id="loadingBar"></div>
    </div>

    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <div class="bg-bubbles">
        <div class="bubble bubble-1"></div>
        <div class="bubble bubble-2"></div>
        <div class="bubble bubble-3"></div>
    </div>

    <div class="app-wrapper">
    <div class="sidebar" id="sidebar">
        <h1 id="sidebarTitle">Cities</h1>
        <div class="artist-logos">
            <a href="https://www.efdotstudio.com" target="_blank" title="Efdot Studio"><img src="ef-logo.png" alt="Efdot" class="artist-logo ef-logo"></a>
            <span class="logo-x"></span>
            <a href="https://diid.art" target="_blank" title="Diid"><img src="diid-logo.png" alt="Diid" class="artist-logo diid-logo"></a>
        </div>

        <div class="control-group">
            <div class="token-nav">
                <button id="prevToken" aria-label="Previous city">&larr;</button>
                <div class="token-input-wrapper">
                    <span class="token-hash">#</span>
                    <input type="number" id="tokenId" value="0" min="0" max="317" placeholder="0-317" aria-label="City token number (0-317)">
                </div>
                <button id="nextToken" aria-label="Next city">&rarr;</button>
            </div>
        </div>
        <div class="owner-display" id="ownerDisplay"></div>
        <div class="listing-info" id="listingInfo"></div>
        <div class="owner-actions" id="ownerActions" style="margin-top: 8px; margin-bottom: 16px;">
            <a href="#" target="_blank" class="marketplace-link offer-btn" id="makeOfferBtn">MAKE OFFER</a>
        </div>

        <div class="city-note" id="cityNote">
            <textarea id="cityNoteInput" placeholder="Add a note..." rows="1"></textarea>
        </div>

        <div class="filters-section collapsed" id="filtersSection">
            <div class="filters-toggle" id="filtersToggle">
                <span>FILTERS</span>
                <span class="toggle-icon"></span>
            </div>
            <div class="filters-content">
                <div class="filter-grid">
                    <div class="control-group">
                        <label>TIME</label>
                        <select id="filterTime"><option value="">ANY</option></select>
                    </div>
                    <div class="control-group">
                        <label>PALETTE</label>
                        <select id="filterPalette"><option value="">ANY</option></select>
                    </div>
                    <div class="control-group">
                        <label>BOUNDS</label>
                        <select id="filterBounds"><option value="">ANY</option></select>
                    </div>
                    <div class="control-group">
                        <label>TRAFFIC</label>
                        <select id="filterTraffic"><option value="">ANY</option></select>
                    </div>
                    <div class="control-group">
                        <label>LINE</label>
                        <select id="filterLine"><option value="">ANY</option></select>
                    </div>
                    <div class="control-group">
                        <label>RENDER</label>
                        <select id="filterRender"><option value="">ANY</option></select>
                    </div>
                    <div class="control-group">
                        <label>ZOOM</label>
                        <select id="filterZoom"><option value="">ANY</option></select>
                    </div>
                    <div class="control-group">
                        <label>WATER</label>
                        <select id="filterWater"><option value="">ANY</option></select>
                    </div>
                </div>
                <div class="filter-actions">
                    <button class="btn btn-clear" id="clearFilters">CLEAR</button>
                    <button class="btn btn-random-filter" id="randomFiltered">RANDOM</button>
                </div>
            </div>
        </div>
        <div class="match-count" id="matchCount">LOADING...</div>

        <div class="metadata-section collapsed" id="metadataSection">
            <div class="metadata-toggle" id="metadataToggle">
                <span>METADATA</span>
                <span class="toggle-icon"></span>
            </div>
            <div class="metadata-content">
                <div id="traitsDisplay" class="traits-display">LOADING...</div>
                <button class="btn btn-inspect btn-sm" id="inspectPalette" style="margin-top: 10px;">INSPECT PALETTE</button>
            </div>
        </div>

        <hr>
        <div class="action-bar">
            <button class="btn btn-explore action-bar-main" id="exploreRandom" aria-label="Enter fullscreen shuffle mode">FULLSCREEN<span class="explore-progress" aria-hidden="true"></span></button>
            <button class="icon-btn heart-btn" id="saveFavorite" title="Save to Favorites" aria-label="Save to favorites"><span class="heart-red" aria-hidden="true"></span><span class="heart-blue" aria-hidden="true"></span></button>
        </div>
        <div class="saved-note" id="savedNote">SAVED TO FAVORITES<span class="saved-dots"></span></div>

        <div class="icon-buttons-row">
            <button class="icon-btn" id="copyLink" title="Copy Link" aria-label="Copy link to clipboard"></button>
            <button class="icon-btn" id="shareTwitter" title="Share on X" aria-label="Share on X (Twitter)"></button>
            <a href="#" id="iconOpenSea" target="_blank" class="icon-btn opensea-icon" title="View on OpenSea"></a>
            <button class="icon-btn" id="frameViewBtn" title="View framed mockup" aria-label="View framed on wall"></button>
            <button class="icon-btn" id="downloadPng" title="Download for Stories (1080x1920)" aria-label="Download JPG for Instagram/X Stories"></button>
        </div>

        <div class="mint-countdown" id="mintCountdown">
            <span class="countdown-label">MINT CLOSES</span>
            <span class="countdown-timer" id="countdownTimer"></span>
        </div>

        <a href="https://www.artblocks.io/collection/0x7c78f67700e700b4005c8a3d920a1a99e6004800-0" target="_blank" class="supply-tracker" id="supplyTracker">
            <div class="supply-bar">
                <div class="supply-fill" id="supplyFill" style="width: 64%;"></div>
                <div class="supply-label"><span id="mintedPercent">64</span>%</div>
            </div>
            <span class="mint-text">VIEW ON ARTBLOCKS</span>
        </a>

        <div class="sidebar-bottom-row">
            <button class="text-btn" id="sidebarCollectorsBtn">COLLECTORS</button>
            <span class="row-divider"></span>
            <button class="text-btn" id="toggleGallery">FAVORITES <span class="fav-count" id="favCount">0</span></button>
            <span class="row-divider"></span>
            <button class="text-btn" id="toggleShortcuts">?</button>
        </div>
        <div class="keyboard-hints" id="keyboardHints" style="display: none;">
            <div class="hint-row"><span>SAVE</span><kbd>S</kbd></div>
            <div class="hint-row"><span>DOWNLOAD</span><kbd>D</kbd></div>
            <div class="hint-row"><span>TWEET</span><kbd>T</kbd></div>
            <div class="hint-row"><span>NAV</span><kbd>&larr; &rarr;</kbd></div>
            <div class="hint-row"><span>RANDOM</span><kbd>F</kbd></div>
            <div class="hint-row"><span>FULLSCREEN</span><kbd>SPACE</kbd></div>
            <div class="hint-row"><span>COPY LINK</span><kbd>L</kbd></div>
        </div>
        <div class="sidebar-note-area">
            <div class="note-placeholder" id="notePlaceholder">Add a note<span class="note-dots">...</span><span class="note-cursor">|</span></div>
            <textarea class="note-input" id="noteInput" maxlength="140" placeholder="Add a note..."></textarea>
            <div class="note-counter"><span id="noteCharCount">0</span>/140</div>
        </div>
        <div class="studio-credit">
            <a href="https://www.artblocks.io/studio" target="_blank">Supported by Art Blocks Studio</a>
        </div>
    </div>

    <div class="side-nav-arrow left" id="sideNavPrev"></div>
    <div class="side-nav-arrow right" id="sideNavNext"></div>

    <div class="main-content">
        <div class="frame-container" id="frameContainer">
            <div class="loading-overlay" id="loadingOverlay">
                <div class="spinner"></div>
                <div class="loading-text">LOADING</div>
            </div>
            <img id="preview-image" class="preview-image" alt="Cities Preview">
            <div class="click-to-view" id="clickToView">VIEW ON ART BLOCKS</div>
            <button class="explore-fullscreen-btn" id="exploreFullscreenBtn" title="Enter Fullscreen" aria-label="Enter fullscreen mode"></button>
        </div>
        <div class="fullscreen-exit-hint" id="fullscreenExitHint">TAP TO EXIT</div>
        <div class="bottom-info">
            <div class="info-display">
                <div class="token-line">CITIES #<span class="token-id" id="displayToken">0</span></div>
            </div>
            <div class="similar-outputs" id="similarOutputs">
                <div class="similar-outputs-grid" id="similarOutputsGrid"></div>
            </div>
        </div>
    </div>
    </div>

    <div class="top-nav-fixed">
        <a href="https://www.artblocks.io/collection/cities-by-efdot-x-diid" target="_blank" class="mint-toggle" id="mintToggle"><img src="mint-m.png" alt="M" class="mint-letter"><img src="mint-i.png" alt="I" class="mint-letter"><img src="mint-n.png" alt="N" class="mint-letter"><img src="mint-t.png" alt="T" class="mint-letter"></a>
        <button class="view-toggle-btn" id="viewToggleBtn" title="Toggle Grid/Single View" aria-label="Toggle between grid and single view" aria-expanded="false">+</button>
    </div>

    <div class="gallery-panel" id="galleryPanel" role="dialog" aria-label="Favorites panel" aria-hidden="true">
        <div class="gallery-header">
            <h2>FAVORITES</h2>
            <button class="gallery-close" id="closeGallery">&times;</button>
        </div>
        <div class="fav-palettes-section" id="favPalettesSection">
            <div class="fav-palettes-header">FAVORITE PALETTES</div>
            <div class="fav-palettes-grid" id="favPalettesGrid">
                <div class="fav-palette-item" data-palette="Beach Day">
                    <div class="fav-palette-swatch" style="background: #f1e9d2;"></div>
                    <div class="fav-palette-name">Beach Day</div>
                    <button class="fav-palette-remove"></button>
                </div>
            </div>
        </div>
        <div class="gallery-grid" id="galleryGrid">
            <div class="empty-gallery">NO FAVORITES YET<br><br>CLICK  ON CITIES OR PALETTES</div>
        </div>
    </div>

    <button class="btn btn-secondary collectors-toggle" id="toggleCollectors">COLLECTORS</button>

    <div class="collectors-panel" id="collectorsPanel" role="dialog" aria-label="Collectors panel" aria-hidden="true">
        <div class="collectors-header">
            <h2 id="collectorsTitle" style="cursor: pointer;"><span class="collectors-title-text">COLLECTORS</span> <span class="collapse-arrow"></span></h2>
            <button class="collectors-close" id="closeCollectors">&times;</button>
        </div>
        <div class="pills-view" id="pillsView">
            <div class="collectors-stats"><strong>111</strong> COLLECTORS  <strong>245</strong> CITIES COLLECTED</div>
            <button class="leaderboard-btn" id="showLeaderboard">VIEW LEADERBOARD</button>
            <div class="collectors-pills" id="collectorsPills"></div>
        </div>
        <div class="leaderboard-view" id="leaderboardView">
            <button class="leaderboard-btn back-btn" id="backToPills"> BACK TO ALL COLLECTORS</button>
            <ul class="leaderboard-list" id="leaderboardList"></ul>
        </div>
    </div>

    <button class="btn btn-secondary grid-toggle" id="toggleGrid" aria-label="Open grid view of all cities">GRID VIEW</button>

    <div class="grid-panel" id="gridPanel" role="dialog" aria-label="Cities grid view" aria-hidden="true">
        <div class="grid-header">
            <div class="grid-brand">
                <h1 id="gridTitle">Cities</h1>
                <div class="grid-artist-logos">
                    <a href="https://www.efdotstudio.com" target="_blank" title="Efdot Studio"><img src="ef-logo.png" alt="Efdot" class="grid-artist-logo ef-logo"></a>
                    <span class="grid-logo-x"></span>
                    <a href="https://diid.art" target="_blank" title="Diid"><img src="diid-logo.png" alt="Diid" class="grid-artist-logo diid-logo"></a>
                </div>
            </div>
            <div class="grid-controls">
                <button class="grid-size-toggle" id="gridSizeToggle" title="Change grid size">
                    <span class="size-icon" id="sizeIcon"></span>
                </button>
                <button class="grid-mode-btn" data-mode="grid" id="gridAllFavBtn">ALL</button>
                <button class="grid-mode-btn active" data-mode="palette" id="paletteColorToggle">BY PALETTE</button>
                <button class="grid-mode-btn collectors-btn" id="gridCollectorsBtn">COLLECTORS</button>
                <button class="gallery-room-toggle" id="galleryRoomToggle" title="Enter immersive gallery"></button>
            </div>
        </div>
        <div class="filter-toggle-bar" id="filterToggleBar"><span>FILTERS</span><span class="arrow"></span></div>
        <div class="grid-filter-bar" id="gridFilterBar">
            <div class="multi-select palette-select" id="paletteMultiSelect">
                <button class="multi-select-btn" type="button">PALETTES <span class="arrow"></span></button>
                <div class="multi-select-dropdown"></div>
            </div>
            <div class="multi-select" id="timeMultiSelect">
                <button class="multi-select-btn" type="button">TIMES <span class="arrow"></span></button>
                <div class="multi-select-dropdown"></div>
            </div>
            <div class="multi-select" id="zoomMultiSelect">
                <button class="multi-select-btn" type="button">ZOOMS <span class="arrow"></span></button>
                <div class="multi-select-dropdown"></div>
            </div>
            <div class="multi-select bounds-select" id="boundsMultiSelect">
                <button class="multi-select-btn" type="button">BOUNDS <span class="arrow"></span></button>
                <div class="multi-select-dropdown"></div>
            </div>
            <div class="multi-select" id="trafficMultiSelect">
                <button class="multi-select-btn" type="button">TRAFFIC <span class="arrow"></span></button>
                <div class="multi-select-dropdown"></div>
            </div>
            <label class="grid-checkbox"><input type="checkbox" id="gridWaterFilter"> WATER</label>
            <div class="grid-filter-spacer"></div>
            <span class="grid-showing-count" id="gridShowingCount">318 showing</span>
            <div class="grid-supply-tracker">
                <div class="grid-supply-bar">
                    <div class="grid-supply-fill" id="gridSupplyFill" style="width: 63.6%;"></div>
                    <div class="grid-supply-label"><span id="gridMintedCount">318</span>/500</div>
                </div>
            </div>
        </div>
        <div class="collector-banner" id="collectorBanner">
            <span class="collector-banner-label">COLLECTION OF</span>
            <span class="collector-banner-name" id="collectorBannerName"></span>
            <button class="collector-banner-close" id="collectorBannerClose">&times;</button>
        </div>
        <div class="grid-content" id="gridContent"></div>
        <div class="grid-pagination" id="gridPagination">
            <button id="gridPrevPage"> PREV</button>
            <span class="page-info" id="gridPageInfo">PAGE 1 OF 1</span>
            <button id="gridNextPage">NEXT </button>
        </div>
    </div>

    <div class="status-message" id="statusMessage"></div>

    <div class="palette-inspector" id="paletteInspector">
        <div class="palette-inspector-content">
            <div class="palette-inspector-name" id="paletteInspectorName"></div>
            <div class="palette-inspector-meta" id="paletteInspectorMeta"></div>
            <div class="palette-inspector-colors" id="paletteInspectorColors"></div>
            <label class="palette-inspector-hex-toggle">
                <input type="checkbox" id="showHexCodes"> SHOW HEX CODES
            </label>
            <div class="palette-inspector-hex" id="paletteInspectorHex"></div>
            <div class="palette-inspector-similar" id="paletteInspectorSimilar"></div>
            <button class="palette-inspector-close" id="closePaletteInspector">CLOSE</button>
        </div>
    </div>

    <!-- Framed Mockup View -->
    <div class="frame-mockup" id="frameMockup">
        <div class="frame-mockup-content">
            <div class="frame-wrapper" id="frameWrapper">
                <div class="frame-inner">
                    <img id="frameMockupImage" src="" alt="Framed city artwork">
                </div>
            </div>
        </div>
        <button class="frame-mockup-download" id="downloadFramed" title="Download framed image"></button>
        <button class="frame-mockup-close" id="closeFrameMockup"></button>
    </div>

    <!-- Immersive Gallery Room -->
    <div class="gallery-room" id="galleryRoom">
        <div class="gallery-room-ambient"></div>
        <div class="gallery-room-wall" id="galleryRoomWall"></div>
        <div class="gallery-room-counter" id="galleryRoomCounter">12 Cities</div>
        <button class="gallery-room-close" id="galleryRoomClose"></button>
        <div class="gallery-room-controls">
            <button class="gallery-room-btn" id="galleryPauseBtn" title="Pause/Play"></button>
            <button class="gallery-room-btn" id="gallerySpeedBtn" title="Change speed">1</button>
        </div>
    </div>

    <script>
        const CONTRACT = '0x7c78f67700e700b4005c8a3d920a1a99e6004800';
        const GENERATOR = 'https://generator.artblocks.io';
        const MEDIA_BASE = 'https://media-proxy.artblocks.io/1';
        let MAX_TOKEN = 317;
        const CACHE_VERSION = 'v1';
        const TRAITS_CACHE_KEY = `cities-traits-${CACHE_VERSION}`;
        const CACHE_EXPIRY = 24 * 60 * 60 * 1000;

        const SIZES = { small: { width: 337, height: 600 }, medium: { width: 450, height: 800 }, large: { width: 540, height: 960 } };

        // Collectors data - will be fetched from API for live updates
        let COLLECTORS_DATA = [];

        // 10 vastly different Cities palettes for collector pills - randomized on each visit
        const CITIES_PALETTE_SETS = [
            // Set 1: Vibrant mix
            [
                { name: 'Brooklyn', bg: '#03071E', colors: ['#370617', '#DC2F02', '#FFBA08'], text: '#FFBA08' },
                { name: 'Beach Day', bg: '#f1e9d2', colors: ['#5e4f00', '#6F4E37', '#000080'], text: '#5e4f00' },
                { name: 'Bioluminescent', bg: '#1410af', colors: ['#d54981', '#007eff', '#affff7'], text: '#affff7' },
                { name: 'Heat Wave', bg: '#FF9100', colors: ['#da4801', '#FF4800', '#ffffff'], text: '#000' },
                { name: 'Marakata', bg: '#18382A', colors: ['#4FA98D', '#B5FF7B', '#5AE8AC'], text: '#B5FF7B' },
                { name: 'Joyride', bg: '#5b0060', colors: ['#800080', '#A020F0', '#B86BB5'], text: '#B86BB5' },
                { name: 'Blue Hour', bg: '#3856a1', colors: ['#7896e1', '#e0ab73', '#ff6600'], text: '#e0ab73' },
                { name: 'Autumnal', bg: '#f6efd9', colors: ['#f29c6b', '#b01e1e', '#ffcb05'], text: '#b01e1e' },
                { name: 'Cerulean', bg: '#12419a', colors: ['#20e3df', '#da0246', '#ffff1c'], text: '#20e3df' },
                { name: 'Concrete Cone', bg: '#ff5c00', colors: ['#000000', '#e8e0ca', '#f3eee0'], text: '#000' }
            ],
            // Set 2: Moody mix
            [
                { name: 'Midnight', bg: '#151722', colors: ['#6c7fae', '#c1ceea', '#d2e5ff'], text: '#c1ceea' },
                { name: 'Carioca', bg: '#fed2e2', colors: ['#fda1c2', '#251f6c', '#eeee5f'], text: '#251f6c' },
                { name: 'Into The Night', bg: '#0b0f1d', colors: ['#ffcb05', '#ff5f00', '#e54eb4'], text: '#ffcb05' },
                { name: 'Momentary Oasis', bg: '#4C956C', colors: ['#6AA889', '#FFF8F0', '#B7D5C7'], text: '#FFF8F0' },
                { name: 'Fly Solo', bg: '#240c42', colors: ['#59009b', '#f4b621', '#a3f0e8'], text: '#a3f0e8' },
                { name: 'Sunset Blush', bg: '#F47C74', colors: ['#FF5E52', '#FBE1DC', '#A96AFB'], text: '#fff' },
                { name: 'Live Jazz', bg: '#0d1a36', colors: ['#66a3ff', '#FFC400', '#d6f6e0'], text: '#FFC400' },
                { name: 'La Haze', bg: '#ffce46', colors: ['#ed25c8', '#860063', '#5b0000'], text: '#5b0000' },
                { name: 'New Resident', bg: '#1f043a', colors: ['#b858cb', '#12b9f4', '#10dd9c'], text: '#10dd9c' },
                { name: 'Brick Facade', bg: '#bc4a3c', colors: ['#c9c3b9', '#f9f8f7', '#dbd0f1'], text: '#f9f8f7' }
            ],
            // Set 3: Earthy/warm mix
            [
                { name: 'CDMX', bg: '#937159', colors: ['#1b1f3e', '#fdebf1', '#ffcd9f'], text: '#fdebf1' },
                { name: 'Renewal', bg: '#d8efff', colors: ['#32cbff', '#117df6', '#4ab5ff'], text: '#117df6' },
                { name: 'Bodega Run', bg: '#0d2b6d', colors: ['#adcdfe', '#ffcf32', '#edd6fe'], text: '#ffcf32' },
                { name: 'Golden Hum', bg: '#fffdf5', colors: ['#ffcf46', '#fc6e20', '#a1c35d'], text: '#fc6e20' },
                { name: 'Mental Mine', bg: '#363153', colors: ['#337699', '#5baecf', '#ffde66'], text: '#ffde66' },
                { name: 'Other Planet', bg: '#210754', colors: ['#7fd190', '#bd3f3e', '#effda1'], text: '#effda1' },
                { name: 'Minted Mile', bg: '#75aca1', colors: ['#bb86d8', '#b93043', '#0318f8'], text: '#fff' },
                { name: 'Marfa Memory', bg: '#D6B37C', colors: ['#B4653B', '#67FFFF', '#ffffff'], text: '#B4653B' },
                { name: 'Hyper Glow', bg: '#2b4483', colors: ['#e70688', '#54da82', '#67e4d7'], text: '#67e4d7' },
                { name: 'Boiling Point', bg: '#f1c232', colors: ['#f77f00', '#e84327', '#3f2f1b'], text: '#3f2f1b' }
            ]
        ];

        // Combine all palette sets and shuffle for more variety
        const ALL_PILL_PALETTES = CITIES_PALETTE_SETS.flat();

        // Shuffle array function
        function shuffleArray(arr) {
            const shuffled = [...arr];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Shuffle on load for variety
        const PILL_PALETTES = shuffleArray(ALL_PILL_PALETTES);

        // City emojis distributed across the palettes
        const CITY_EMOJIS = ['', '', '', '', '', '', '', '', '', ''];

        // Palette metadata: time of day, energy, hour
        const PALETTE_META = {
            'Aboveground Current': { time: 'Evening', energy: 'Resting', hour: '22:38' },
            'Alleyway': { time: 'Night', energy: 'Resting', hour: '19:17' },
            'Autumnal': { time: 'Daylight', energy: 'Living', hour: '14:30' },
            'Azulejos': { time: 'Morning', energy: 'Living', hour: '14:36' },
            'Beach Day': { time: 'Morning', energy: 'Living', hour: '10:15' },
            'Bee Line': { time: 'Dawn', energy: 'Rising', hour: '5:35' },
            'Berlin': { time: 'Evening', energy: 'Fading', hour: '21:21' },
            'Bioluminescent': { time: 'Night', energy: 'Resting', hour: 'Blue Hour' },
            'Bitter Haze': { time: 'Night', energy: 'Fading', hour: 'Anytime' },
            'Blinker': { time: 'Night', energy: 'Resting', hour: '0:33' },
            'Blue Hour': { time: 'Dusk', energy: 'Fading', hour: 'Blue Hour' },
            'Blue Skies': { time: 'Daylight', energy: 'Living', hour: '9:29' },
            'Blush Signal': { time: 'Dawn', energy: 'Rising', hour: '10:44' },
            'Bodega Run': { time: 'Night', energy: 'Resting', hour: '23:22' },
            'Boiling Point': { time: 'Afternoon', energy: 'Living', hour: '16:39' },
            'Brick Facade': { time: 'Dusk', energy: 'Fading', hour: '18:46' },
            'Broadway': { time: 'Afternoon', energy: 'Living', hour: '13:16' },
            'Brooklyn': { time: 'Night', energy: 'Resting', hour: '1:23' },
            'Buenos Aires': { time: 'Dusk', energy: 'Fading', hour: '13:21' },
            'Burnout': { time: 'Afternoon', energy: 'Fading', hour: '16:30' },
            'Burnt Impression': { time: 'Dusk', energy: 'Fading', hour: '18:30' },
            'Caffeine': { time: 'Afternoon', energy: 'Living', hour: '9:00' },
            'Caramel Collision': { time: 'Daylight', energy: 'Living', hour: '18:00' },
            'Carioca': { time: 'Afternoon', energy: 'Living', hour: '20:24' },
            'CDMX': { time: 'Evening', energy: 'Fading', hour: '16:12' },
            'Cerulean': { time: 'Evening', energy: 'Resting', hour: 'Blue Hour' },
            'Cinematic Site': { time: 'Evening', energy: 'Resting', hour: '7:50' },
            'Clear Sky Blues': { time: 'Dawn', energy: 'Rising', hour: '14:14' },
            'Concrete Cone': { time: 'Daylight', energy: 'Living', hour: '22:22' },
            'Concrete Heat': { time: 'Afternoon', energy: 'Living', hour: 'Anytime' },
            'Constellations': { time: 'Afternoon', energy: 'Fading', hour: '22:24' },
            'Cotton Candy Noise': { time: 'Night', energy: 'Resting', hour: '19:00' },
            'Crosstown': { time: 'Daylight', energy: 'Living', hour: 'Anytime' },
            'Cruiser': { time: 'Dawn', energy: 'Rising', hour: '20:25' },
            'Curious Blue': { time: 'Dawn', energy: 'Rising', hour: '12:12' },
            'Daybreak Dust': { time: 'Dawn', energy: 'Rising', hour: '8:15' },
            'Diffused Grays': { time: 'Night', energy: 'Fading', hour: 'Anytime' },
            'Downplay': { time: 'Dusk', energy: 'Fading', hour: '19:51' },
            'Dusk Session': { time: 'Dusk', energy: 'Fading', hour: '22:00' },
            'Dust Storm': { time: 'Dawn', energy: 'Rising', hour: '7:17' },
            'Evening Odds': { time: 'Evening', energy: 'Resting', hour: '2:51' },
            'Fly Solo': { time: 'Night', energy: 'Resting', hour: '23:01' },
            'Golden Hum': { time: 'Dawn', energy: 'Rising', hour: '8:29' },
            'Hard Shadow': { time: 'Daylight', energy: 'Living', hour: '11:11' },
            'Heat Wave': { time: 'Morning', energy: 'Living', hour: '15:12' },
            'Hudson Happening': { time: 'Night', energy: 'Fading', hour: '23:18' },
            'Hyper Glow': { time: 'Evening', energy: 'Fading', hour: '20:30' },
            'Impromptu Hue': { time: 'Afternoon', energy: 'Living', hour: '19:35' },
            'Indigo Steps': { time: 'Night', energy: 'Resting', hour: 'Blue Hour' },
            'Into The Night': { time: 'Night', energy: 'Resting', hour: '0:12' },
            'Island Summer': { time: 'Daylight', energy: 'Living', hour: '13:00' },
            'Jaipur Gem': { time: 'Daylight', energy: 'Living', hour: '7:30' },
            'Joyride': { time: 'Afternoon', energy: 'Fading', hour: '22:30' },
            'La Haze': { time: 'Afternoon', energy: 'Living', hour: '18:32' },
            'Last Train Home': { time: 'Evening', energy: 'Resting', hour: '23:28' },
            'Liberty Lane': { time: 'Afternoon', energy: 'Fading', hour: '17:55' },
            'Live Jazz': { time: 'Night', energy: 'Resting', hour: '23:11' },
            'London Fog': { time: 'Evening', energy: 'Resting', hour: 'Anytime' },
            'Low Sun Rush': { time: 'Dusk', energy: 'Fading', hour: '19:24' },
            'Lucid Blue': { time: 'Night', energy: 'Resting', hour: '23:41' },
            'Manhattan': { time: 'Night', energy: 'Resting', hour: '0:00' },
            'Marakata': { time: 'Night', energy: 'Resting', hour: '21:09' },
            'Marfa Memory': { time: 'Daylight', energy: 'Fading', hour: '16:32' },
            'Mauve Orleans': { time: 'Daylight', energy: 'Living', hour: '15:13' },
            'Mental Mine': { time: 'Night', energy: 'Resting', hour: '21:59' },
            'Miami': { time: 'Night', energy: 'Resting', hour: 'Blue Hour' },
            'Midday Brights': { time: 'Afternoon', energy: 'Living', hour: '14:01' },
            'Midnight': { time: 'Night', energy: 'Resting', hour: '0:00' },
            'Minted Mile': { time: 'Evening', energy: 'Fading', hour: '16:33' },
            'Momentary Oasis': { time: 'Evening', energy: 'Fading', hour: '13:40' },
            'Mono Contrast': { time: 'Daylight', energy: 'Living', hour: 'Anytime' },
            'Morning Meditation': { time: 'Dawn', energy: 'Rising', hour: '8:49' },
            'Mundane Morning': { time: 'Daylight', energy: 'Living', hour: '10:01' },
            'Naturalistic': { time: 'Dusk', energy: 'Fading', hour: '19:17' },
            'Neighborly Love': { time: 'Afternoon', energy: 'Living', hour: '18:06' },
            'New Resident': { time: 'Night', energy: 'Resting', hour: '11:51' },
            'Night Flow': { time: 'Night', energy: 'Resting', hour: '1:12' },
            'Night Light': { time: 'Night', energy: 'Resting', hour: '19:11' },
            'One Phone Call': { time: 'Night', energy: 'Resting', hour: '2:00' },
            'Other Planet': { time: 'Night', energy: 'Resting', hour: '21:30' },
            'Out Late': { time: 'Night', energy: 'Resting', hour: '23:34' },
            'Pepdot': { time: 'Morning', energy: 'Living', hour: '14:21' },
            'Present Moment': { time: 'Morning', energy: 'Living', hour: '15:21' },
            'Red Mirage': { time: 'Morning', energy: 'Living', hour: '13:11' },
            'Renewal': { time: 'Daylight', energy: 'Living', hour: '9:54' },
            'Restful Pause': { time: 'Afternoon', energy: 'Living', hour: '20:02' },
            'San Francisco': { time: 'Dusk', energy: 'Fading', hour: '16:20' },
            'Signal Arc': { time: 'Dusk', energy: 'Fading', hour: '19:38' },
            'Slow Collage': { time: 'Afternoon', energy: 'Fading', hour: '11:00' },
            'Soft Shadow': { time: 'Dusk', energy: 'Fading', hour: '19:41' },
            'Subtle Static': { time: 'Afternoon', energy: 'Fading', hour: '15:32' },
            'Sunset Blush': { time: 'Dusk', energy: 'Fading', hour: '9:12' },
            'Swift Transfer': { time: 'Night', energy: 'Resting', hour: '3:14' },
            'Taxi Station': { time: 'Dusk', energy: 'Fading', hour: '16:00' },
            'Thick Air': { time: 'Dusk', energy: 'Fading', hour: '20:18' },
            'Timeless Static': { time: 'Afternoon', energy: 'Living', hour: '15:00' },
            'Tinted Ink': { time: 'Daylight', energy: 'Living', hour: 'Anytime' },
            'Tourist Trap': { time: 'Afternoon', energy: 'Living', hour: '14:12' },
            'Tunnel Vision': { time: 'Dusk', energy: 'Fading', hour: '8:30' },
            'Ultra Violet': { time: 'Afternoon', energy: 'Living', hour: '14:28' },
            'Under Bloom': { time: 'Evening', energy: 'Fading', hour: '17:55' },
            'Underdog': { time: 'Afternoon', energy: 'Living', hour: '18:48' },
            'Underground': { time: 'Evening', energy: 'Resting', hour: 'Anytime' },
            'Uptown': { time: 'Afternoon', energy: 'Fading', hour: '18:16' },
            'Vanilla Pastelo': { time: 'Afternoon', energy: 'Living', hour: '15:54' },
            'Vibrating Blocks': { time: 'Afternoon', energy: 'Fading', hour: '20:31' },
            'Waverly Lavender': { time: 'Morning', energy: 'Living', hour: '8:37' },
            'Whisper Line': { time: 'Evening', energy: 'Fading', hour: 'Anytime' },
            'Wind Down': { time: 'Dusk', energy: 'Fading', hour: '18:33' },
            'World Fair': { time: 'Daylight', energy: 'Living', hour: '14:40' },
            'Woven Glow': { time: 'Afternoon', energy: 'Fading', hour: 'Anytime' },
            'X Ray Film': { time: 'Night', energy: 'Resting', hour: '2:22' }
        };

        // Palette hex data: name -> { bg, colors: [all palette colors] }
        const PALETTE_DATA = {
            'Aboveground Current': { bg: '#0d2049', colors: ['#081124', '#112044', '#2f7bee', '#f5df86', '#000000', '#bcb50f', '#eec7c9', '#e3d536', '#f8cb62', '#FFDDA0', '#cce0ff', '#b3ecc6'] },
            'Alleyway': { bg: '#a096bd', colors: ['#bfcce0', '#767579', '#58529f', '#7f5ac1', '#dabab7', '#dad9df', '#bbbbc2', '#b2b4c0', '#adabb9', '#ccff66', '#7c6b70', '#c0c8cc'] },
            'Autumnal': { bg: '#f6efd9', colors: ['#f29c6b', '#db5e35', '#b01e1e', '#591918', '#fff7f0', '#ffb76f', '#f8d3b1', '#ffebd6', '#E67424', '#ffa982', '#92340d', '#ffcb05'] },
            'Azulejos': { bg: '#f8f5f0', colors: ['#0A1D6F', '#3657B2', '#506AD8', '#6B7FF0', '#2A5CCF', '#192FAD', '#141F8A', '#728ED8', '#96B6D8', '#BBCFF0', '#2E3D7A', '#394CAF'] },
            'Beach Day': { bg: '#f1e9d2', colors: ['#5e4f00', '#423300', '#260700', '#a99746', '#6F4E37', '#5e4f00', '#1C1812', '#423b33', '#323030', '#d7d0aa', '#ccb78f', '#000080'] },
            'Bee Line': { bg: '#FFB300', colors: ['#000000', '#333333', '#222222', '#111111', '#e8e0ca', '#5c5c5c', '#000000', '#333333', '#222222', '#060606', '#f3eee0', '#5c5c5c'] },
            'Berlin': { bg: '#2C3E8E', colors: ['#58529f', '#7f5ac1', '#4c695c', '#a79986', '#d6d6d6', '#bcc3cd', '#a5a9b9', '#617392', '#556482', '#1b3d44', '#b1d5e6', '#eaeaea'] },
            'Bioluminescent': { bg: '#1410af', colors: ['#d54981', '#e7929b', '#007eff', '#702192', '#a23188', '#de5b7b', '#120e9d', '#1510b7', '#007eff', '#130fa6', '#affff7', '#00a0ff'] },
            'Bitter Haze': { bg: '#817681', colors: ['#b3a9b3', '#403640', '#ffcc00', '#ccc2cc', '#271c27', '#c1acb4', '#6b616b', '#655b65', '#635963', '#887e88', '#eb9123', '#7ec599'] },
            'Blinker': { bg: '#0d2049', colors: ['#bca10f', '#f0d54a', '#f4e87b', '#bc770f', '#f2c069', '#bc940f', '#0b1c41', '#0d214c', '#0e2453', '#060f25', '#0b1b3e', '#091633'] },
            'Blue Hour': { bg: '#3856a1', colors: ['#7896e1', '#05236e', '#000a54', '#91affa', '#e0ab73', '#ff6600', '#324d90', '#3a5aa9', '#4062b9', '#355198', '#2f4988', '#273c70'] },
            'Blue Skies': { bg: '#d8efff', colors: ['#87CEEB', '#ECE9F8', '#00BFFF', '#B0E0E6', '#66ccff', '#1569C7', '#b9daf1', '#eff8fe', '#ffffff', '#c0e5ff', '#91d2ff', '#5cb2ee'] },
            'Blush Signal': { bg: '#fffaf0', colors: ['#ffb3ab', '#ffc1c1', '#ca7f6d', '#fdf5f5', '#ebb189', '#fee2e1', '#fdf5ee', '#fcf1ec', '#faeada', '#845d5c', '#ffde66', '#fce3c3'] },
            'Bodega Run': { bg: '#0d2b6d', colors: ['#061a44', '#0c2c73', '#adcdfe', '#ffffff', '#000000', '#ffcf32', '#FFF4B2', '#d3990f', '#FFEB8F', '#f3daae', '#be9ad8', '#edd6fe'] },
            'Boiling Point': { bg: '#f1c232', colors: ['#83846d', '#3f2f1b', '#f77f00', '#eaeaea', '#eaeaea', '#4e2729', '#f1c232', '#83846d', '#e84327', '#ffba4a', '#3f2f1b', '#f77f00'] },
            'Brick Facade': { bg: '#bc4a3c', colors: ['#4e5358', '#c9c3b9', '#3d3e4d', '#202829', '#8d3024', '#f9f8f7', '#251e34', '#554478', '#8e80a9', '#2d2241', '#c0b3d9', '#dbd0f1'] },
            'Broadway': { bg: '#f0ede7', colors: ['#000000', '#000000', '#0033A0', '#FAE600', '#E53935', '#1E5B7E', '#11457E', '#3D26B3', '#214478', '#FFD700', '#fffc00', '#E2702A'] },
            'Brooklyn': { bg: '#03071E', colors: ['#370617', '#6A040F', '#9D0208', '#D00000', '#DC2F02', '#E85D04', '#F48C06', '#FAA307', '#FFBA08', '#61dbb2', '#7FFFD4', '#FF00FF'] },
            'Buenos Aires': { bg: '#eaeaea', colors: ['#ffa800', '#fc6e20', '#ffb300', '#b25d44', '#b25d44', '#fdedd2', '#fbe08d', '#ffd684', '#ffdb72', '#fca778', '#897d93', '#fafae4'] },
            'Burnout': { bg: '#f5937a', colors: ['#822007', '#690700', '#8ca5f6', '#ffac93', '#ffac93', '#99907a', '#a24a34', '#be573c', '#c5654c', '#ab4e37', '#994631', '#7e3a28'] },
            'Burnt Impression': { bg: '#8FA3AE', colors: ['#455560', '#1E1E1C', '#FF5C00', '#FF6E1A', '#FBC174', '#6A8CA5', '#7c93a0', '#98aab4', '#aab9c1', '#859ba7', '#738c9a', '#5d7480'] },
            'Caffeine': { bg: '#f7f6f5', colors: ['#453b05', '#302603', '#1c0702', '#81753d', '#060301', '#453b05', '#5f4a06', '#2A251F', '#000000', '#b7b08a', '#ccb78f', '#423300'] },
            'Caramel Collision': { bg: '#D1C4B2', colors: ['#5D3A00', '#E06C00', '#F5BA57', '#D94F00', '#872800', '#B23B00', '#E1C699', '#CFB38B', '#B89B78', '#F5DEB3', '#F79C5C', '#AF491F'] },
            'Carioca': { bg: '#fed2e2', colors: ['#fda1c2', '#eeee5f', '#251f6c', '#2c60a9', '#5e91b6', '#f25db4', '#fdb8d1', '#fee5ee', '#e3b0da', '#faedf2', '#b2d5a8', '#eeee5f'] },
            'CDMX': { bg: '#937159', colors: ['#af8c74', '#1b1f3e', '#ddb4c0', '#fdebf1', '#ffcd9f', '#ec9a76', '#4b382c', '#977a67', '#8a6d59', '#5b4638', '#665042', '#544236'] },
            'Cerulean': { bg: '#12419a', colors: ['#20e3df', '#1d4ea3', '#6e75d3', '#34877a', '#0051bb', '#cffada', '#17444d', '#123d87', '#7f9de8', '#203985', '#da0246', '#ffff1c'] },
            'Cinematic Site': { bg: '#607D8B', colors: ['#8EA0B8', '#5E7380', '#3C5A76', '#B0BEC5', '#263238', '#78909C', '#758B95', '#6D858F', '#5D6D75', '#4C5E66', '#D2F1F9', '#ADC7D4'] },
            'Clear Sky Blues': { bg: '#94d8ff', colors: ['#2a609e', '#0b7ed0', '#00adda', '#3d72c0', '#3d72c0', '#b6dfff', '#b1dcff', '#addaff', '#afd8fc', '#fcffc5', '#fdff8c', '#fff1c1'] },
            'Concrete Cone': { bg: '#ff5c00', colors: ['#000000', '#333333', '#222222', '#111111', '#444444', '#e8e0ca', '#cb530e', '#953e0d', '#222222', '#292929', '#444444', '#f3eee0'] },
            'Concrete Heat': { bg: '#A9A9A9', colors: ['#FFD67B', '#DDC07A', '#D6A461', '#F5E45C', '#A67C52', '#7A5B3E', '#C1B6A3', '#B5AFA1', '#fdf5ee', '#A2968C', '#CFCFCF', '#D64545'] },
            'Constellations': { bg: '#1b1420', colors: ['#1A2B1F', '#4A5A90', '#FEDD0D', '#F5F5CC', '#6588C7', '#48A662', '#50657A', '#3A4D7A', '#9CA8C8', '#4B3D28', '#FF8C00', '#FFC600'] },
            'Cotton Candy Noise': { bg: '#f4f4f4', colors: ['#d6d6d6', '#a4d5ff', '#fab6d4', '#22375e', '#22375e', '#fdf7f7', '#f2f2f2', '#e6e9eb', '#f6f9fc', '#6d4c5b', '#d3ff66', '#fffaf0'] },
            'Crosstown': { bg: '#FFFAF0', colors: ['#000000', '#333333', '#222222', '#111111', '#444444', '#5c5c5c', '#000000', '#333333', '#222222', '#353434', '#1f1f1f', '#5c5c5c'] },
            'Cruiser': { bg: '#3c3153', colors: ['#f0cd3a', '#a3c3b1', '#6b7075', '#c9ae00', '#3e484e', '#767d6a', '#f0cd3a', '#a3c3b1', '#2c2f38', '#abb49c', '#6b7075', '#c9ae00'] },
            'Curious Blue': { bg: '#d4f0ff', colors: ['#bae1ff', '#1e7cae', '#5baecf', '#fff1c1', '#fff1c1', '#d6e3ed', '#d4e8f8', '#badcfa', '#bbe0ff', '#3a475e', '#ffefa7', '#bfcce0'] },
            'Daybreak Dust': { bg: '#f0efec', colors: ['#f8ebbc', '#ffb300', '#fc6e20', '#a79986', '#a79986', '#fde1c0', '#e6d6c9', '#f7dfcb', '#efd3bb', '#29545c', '#b1d5e6', '#ffe0e0'] },
            'Diffused Grays': { bg: '#c3cbcf', colors: ['#4b4747', '#8a7670', '#6e6e6e', '#434343', '#434343', '#ced7d9', '#b1b1b1', '#cecece', '#e2e0d8', '#d65790', '#ff66c3', '#cbcecf'] },
            'Downplay': { bg: '#785f4e', colors: ['#5b4680', '#191c32', '#c58a9b', '#f1a6c1', '#ffaa5a', '#db784d', '#6c5546', '#7e6351', '#8a6d59', '#725a4a', '#665042', '#544236'] },
            'Dusk Session': { bg: '#463766', colors: ['#5c636a', '#ebe8e4', '#47495d', '#253032', '#303c41', '#ffffff', '#251e34', '#8272a3', '#8e80a9', '#749a71', '#c0b3d9', '#f2eefb'] },
            'Dust Storm': { bg: '#f9b9aa', colors: ['#d4a373', '#a65c3b', '#706353', '#f4e0c3', '#f4e0c3', '#b54a41', '#f9b9aa', '#d4a373', '#e8c3a3', '#ddbac3', '#a65c3b', '#706353'] },
            'Evening Odds': { bg: '#051437', colors: ['#ffdf32', '#fef8d9', '#040e22', '#1b3772', '#657fb8', '#ffcf32', '#0b1c41', '#ffad32', '#ffcf32', '#ffee2c', '#cce0ff', '#92d1a7'] },
            'Fly Solo': { bg: '#240c42', colors: ['#59009b', '#0a245d', '#eee378', '#f4b621', '#59009b', '#203369', '#0e1736', '#31084f', '#516090', '#223a87', '#a3f0e8', '#a3f0e8'] },
            'Golden Hum': { bg: '#fffdf5', colors: ['#151722', '#ffcf46', '#ffa800', '#fc6e20', '#fc6e20', '#fff6ee', '#fffbde', '#fff6d3', '#faf8cd', '#a1c35d', '#9b868c', '#fffdf5'] },
            'Hard Shadow': { bg: '#e3e3db', colors: ['#ffcf46', '#ffe46c', '#ffa800', '#fc6e20', '#fc6e20', '#fdf7f5', '#fffbf2', '#f7f5f1', '#f9f1e6', '#fca778', '#68b1b3', '#b7b2ae'] },
            'Heat Wave': { bg: '#FF9100', colors: ['#da4801', '#ff7f32', '#FF6D00', '#ffffff', '#fee6c1', '#FF4800', '#FF9E00', '#f9f8f7', '#fee6c1', '#FF8500', '#cc0f95', '#ffffa9'] },
            'Hudson Happening': { bg: '#191970', colors: ['#87CEEB', '#708090', '#2E8B57', '#FF4500', '#A9D0A9', '#000080', '#444C6D', '#5D6D84', '#75809A', '#dbb18c', '#FFA07A', '#4682B4'] },
            'Hyper Glow': { bg: '#2b4483', colors: ['#e70688', '#54da82', '#67e4d7', '#a6ac17', '#e54eb4', '#0e1596', '#263d75', '#2d4789', '#314e96', '#28407c', '#24396f', '#1e2f5b'] },
            'Impromptu Hue': { bg: '#db9215', colors: ['#001a33', '#001F3F', '#003366', '#3221A3', '#004080', '#468dd1', '#1c2835', '#7888CD', '#c9def5', '#B4C5E4', '#5361C7', '#4A53BB'] },
            'Indigo Steps': { bg: '#101a3c', colors: ['#263d75', '#2d4789', '#3a5caf', '#28407c', '#24396f', '#1f2d54', '#0e1736', '#1e2e61', '#121d45', '#0f1839', '#8497d1', '#556cb9'] },
            'Into The Night': { bg: '#0b0f1d', colors: ['#ffcb05', '#fef9c5', '#ffffff', '#ff5f00', '#fb8e2c', '#ff3b3b', '#131c3a', '#1f2b4d', '#45385f', '#392e4e', '#ffffa9', '#e54eb4'] },
            'Island Summer': { bg: '#F5DEB3', colors: ['#1E90FF', '#D72638', '#FFB6C1', '#FFA500', '#4B0082', '#00CED1', '#A0DFFF', '#FFE5CC', '#FFDDDD', '#F5CBA7', '#FF6347', '#20B2AA'] },
            'Jaipur Gem': { bg: '#D8A8B7', colors: ['#2E535B', '#3D2B56', '#1CA66A', '#475BB5', '#E67424', '#F080A0', '#cc8da1', '#ddb5c1', '#e9cfd7', '#d29aac', '#c68096', '#b45875'] },
            'Joyride': { bg: '#5b0060', colors: ['#800080', '#8A2BE2', '#A020F0', '#9370DB', '#9932CC', '#B86BB5', '#510056', '#5f0064', '#68006e', '#56005b', '#4d0051', '#3f0043'] },
            'La Haze': { bg: '#ffce46', colors: ['#a07600', '#ce6624', '#ed25c8', '#9f0000', '#860063', '#5b0000', '#ca7505', '#ff9eec', '#e7a7a1', '#a46566', '#f876df', '#ba9da2'] },
            'Last Train Home': { bg: '#2c2c2c', colors: ['#58529f', '#a79986', '#b7934c', '#df2049', '#df2049', '#393031', '#534f56', '#313839', '#3c3643', '#78615a', '#947fff', '#363153'] },
            'Liberty Lane': { bg: '#A9BA9D', colors: ['#708090', '#87CEEB', '#FFD700', '#B87333', '#FFFFFF', '#5A5A5A', '#C0C0B0', '#A0A0A0', '#E0E0E0', '#B0C0C0', '#FFB300', '#2F4F2F'] },
            'Live Jazz': { bg: '#0d1a36', colors: ['#091736', '#10275b', '#66a3ff', '#FFF8DC', '#000000', '#FFC400', '#cce0ff', '#bd675e', '#FFEB8F', '#dcba7d', '#FFF4B2', '#d6f6e0'] },
            'London Fog': { bg: '#c8c8c8', colors: ['#b1a5a1', '#a7a6a6', '#828282', '#a8a8a8', '#f05b67', '#ff0015', '#bdbdbd', '#d0d0d0', '#e2e2e2', '#7e554b', '#b6674e', '#ff0015'] },
            'Low Sun Rush': { bg: '#f9f7ed', colors: ['#fc6e20', '#ffb300', '#b7934c', '#876935', '#876935', '#fecfc3', '#fdcbaf', '#fab78a', '#fba676', '#523743', '#d3ff66', '#fce3c3'] },
            'Lucid Blue': { bg: '#00254b', colors: ['#008bf4', '#2f455c', '#003d7a', '#004c99', '#005fbd', '#008bf4', '#001b38', '#002042', '#002348', '#001d3b', '#001a35', '#00152c'] },
            'Manhattan': { bg: '#22375e', colors: ['#3c69be', '#1b2b4f', '#fe675e', '#00d0a0', '#1d2cff', '#3d69bd', '#857b6c', '#3b4e56', '#808da3', '#2c383d', '#877cff', '#3d4eff'] },
            'Marakata': { bg: '#18382A', colors: ['#4FA98D', '#2E6D57', '#60A280', '#15725C', '#3E8C6F', '#0F1C18', '#1B352B', '#244438', '#305E4B', '#102D21', '#B5FF7B', '#5AE8AC'] },
            'Marfa Memory': { bg: '#D6B37C', colors: ['#F4C882', '#B4653B', '#F5E1B9', '#F1C27B', '#C69C6D', '#9D7950', '#E0C79D', '#CFAE8A', '#ffffff', '#C7A376', '#67FFFF', '#9D7950'] },
            'Mauve Orleans': { bg: '#f1e9d2', colors: ['#800080', '#8A2BE2', '#A020F0', '#9370DB', '#9932CC', '#8B008B', '#800080', '#A546A8', '#B86BB5', '#CD8ACD', '#730077', '#5F0063'] },
            'Mental Mine': { bg: '#363153', colors: ['#22375e', '#337699', '#5baecf', '#58529f', '#58529f', '#515156', '#474649', '#5e5e5f', '#3f3d3d', '#845d5c', '#ffde66', '#1f1722'] },
            'Miami': { bg: '#182f5a', colors: ['#007BA7', '#1d4ea3', '#6e75d3', '#34877a', '#0051bb', '#59d8c5', '#20535d', '#e7929b', '#7f9de8', '#3251b0', '#e6a9f3', '#ffff1c'] },
            'Midday Brights': { bg: '#e9e4ab', colors: ['#ff9500', '#a37410', '#ff7b00', '#de7106', '#de7106', '#d6d6d4', '#e0e0dc', '#ebe9e5', '#f5f3ed', '#ef8a7f', '#ffc466', '#f9f7f0'] },
            'Midnight': { bg: '#151722', colors: ['#151628', '#242744', '#6c7fae', '#96adce', '#c1ceea', '#e9eff9', '#171927', '#1b1d2e', '#83a4d2', '#181a29', '#d2e5ff', '#12131e'] },
            'Minted Mile': { bg: '#75aca1', colors: ['#1a5e45', '#bb86d8', '#cccfda', '#b93043', '#0318f8', '#5f1bee', '#62a194', '#7eb1a7', '#90bcb3', '#6ba69a', '#5c998d', '#4b7e74'] },
            'Momentary Oasis': { bg: '#4C956C', colors: ['#6AA889', '#B7D5C7', '#E8F3F1', '#FFF8F0', '#FFF8F0', '#4C956C', '#448661', '#4f9c71', '#58aa7c', '#488d66', '#407e5b', '#35684b'] },
            'Mono Contrast': { bg: '#f5f5f5', colors: ['#111111', '#222222', '#d8d8d8', '#c7c7c7', '#b9b9b9', '#ababab', '#111111', '#333333', '#d5d5d5', '#c7c7c7', '#444444', '#d8d8d8'] },
            'Morning Meditation': { bg: '#f7ecbb', colors: ['#cfb720', '#fffc0f', '#e36a0f', '#f97a00', '#f97a00', '#b9a58f', '#cab299', '#dcbea2', '#edcbac', '#99b5df', '#9aafbd', '#fddbbe'] },
            'Mundane Morning': { bg: '#f8f8f8', colors: ['#a7c9d4', '#e6c5bc', '#627181', '#f5f9fc', '#ffffff', '#c9adb0', '#bababa', '#d9d9d9', '#eeeeee', '#c4c4c4', '#afafaf', '#909090'] },
            'Naturalistic': { bg: '#685b5b', colors: ['#e0857b', '#9f8000', '#d8dcdd', '#a759c7', '#52a0ef', '#3099df', '#4d4545', '#5a5050', '#625858', '#3c3535', '#e0acf5', '#fad022'] },
            'Neighborly Love': { bg: '#fff5f9', colors: ['#fc6e20', '#ffa800', '#a79986', '#337699', '#337699', '#fec9ba', '#fec4a0', '#f5a071', '#fc9151', '#73e5ea', '#ffce66', '#fce3c3'] },
            'New Resident': { bg: '#1f043a', colors: ['#b858cb', '#4b2f5a', '#ce06f3', '#12b9f4', '#e36de3', '#ffafcc', '#10dd9c', '#650976', '#dd66f3', '#98d8ef', '#ce06f3', '#e36de3'] },
            'Night Flow': { bg: '#101a3c', colors: ['#ffff33', '#fae599', '#ddd04e', '#d09a18', '#4B0082', '#1f2d54', '#0e1736', '#101b3e', '#121d45', '#0f1839', '#0d1632', '#0b122a'] },
            'Night Light': { bg: '#29023a', colors: ['#07938e', '#db60f8', '#455728', '#8342bf', '#f06e29', '#8aeeb8', '#240134', '#2b023c', '#2f0242', '#260137', '#ff66cb', '#ff66cb'] },
            'One Phone Call': { bg: '#1a1c2c', colors: ['#131421', '#202237', '#586994', '#738eb7', '#91a6d4', '#aec4e4', '#171927', '#1b1d2e', '#1d2032', '#181a29', '#404377', '#313448'] },
            'Other Planet': { bg: '#210754', colors: ['#27466d', '#0a423a', '#7fd190', '#bd3f3e', '#effda1', '#2e29ad', '#1d064b', '#220758', '#250860', '#1f064f', '#1c0547', '#fbfdf2'] },
            'Out Late': { bg: '#171010', colors: ['#f3f2f2', '#dcdcdc', '#2F2C29', '#3E3A36', '#1A1410', '#201C16', '#110F0D', '#2e2e2e', '#3C3935', '#514D48', '#E63B2E', '#00A652'] },
            'Pepdot': { bg: '#ecebed', colors: ['#05aa0e', '#0a8811', '#040406', '#1441ff', '#fc070d', '#158f1c', '#d4d2d6', '#f7f7f8', '#ffffff', '#e0dee1', '#c8c5cb', '#a5a0a9'] },
            'Present Moment': { bg: '#ecb317', colors: ['#ecd287', '#ce6624', '#ff59e0', '#9f0000', '#860063', '#5b0000', '#9e5d08', '#ff9eec', '#e7a7a1', '#a46566', '#f876df', '#ba9da2'] },
            'Red Mirage': { bg: '#f6efd9', colors: ['#DC143C', '#8B0000', '#A52A2A', '#B22222', '#800020', '#FF4500', '#DC143C', '#FF6347', '#FF7F50', '#FF6656', '#FFA07A', '#FFB6C1'] },
            'Renewal': { bg: '#d8efff', colors: ['#c2e9f9', '#8ccff2', '#32cbff', '#e2daea', '#ade3fe', '#117df6', '#82b7dd', '#eff8fe', '#ffffff', '#c0e5ff', '#91d2ff', '#4ab5ff'] },
            'Restful Pause': { bg: '#732da3', colors: ['#9b6eb9', '#ada9c0', '#d0e0eb', '#fefeff', '#fefeff', '#ffffff', '#8678b1', '#aba0c8', '#f2f1f7', '#c2bbd8', '#aba0c8', '#8678b1'] },
            'San Francisco': { bg: '#337699', colors: ['#73b6d9', '#004366', '#d4b96b', '#8ccff2', '#002a4c', '#3366ff', '#2d7093', '#1f6285', '#1e6184', '#216487', '#ffffa9', '#eb9123'] },
            'Signal Arc': { bg: '#58529f', colors: ['#9892df', '#251f6c', '#b1abf8', '#dda890', '#99907a', '#0c0652', '#4f498f', '#5c56a6', '#6b65af', '#534d97', '#4a4587', '#3d396f'] },
            'Slow Collage': { bg: '#5F658C', colors: ['#ACB5D7', '#FCFCF5', '#646472', '#F1A354', '#53577B', '#4D516B', '#EAC49F', '#B5B1BB', '#46495D', '#FF69B4', '#FF69B4', '#00CED1'] },
            'Soft Shadow': { bg: '#cfc9e0', colors: ['#4b2862', '#67497c', '#6e6a86', '#749ab3', '#d2bf9d', '#f3bc77', '#b7aed0', '#dbd6e7', '#f2f1f7', '#c2bbd8', '#aba0c8', '#8678b1'] },
            'Subtle Static': { bg: '#f0eeee', colors: ['#e2e6e9', '#363153', '#837c7c', '#fdf5f5', '#fdf5f5', '#e8e7e8', '#a5a5a5', '#e2e2e2', '#d0d3d8', '#52c7cc', '#ffce66', '#d6d6d6'] },
            'Sunset Blush': { bg: '#F47C74', colors: ['#FF867C', '#FF5E52', '#FFAA99', '#FBE1DC', '#FFD1C7', '#A34238', '#FBAEA6', '#E5948B', '#EED4CE', '#C9584E', '#FFEDE8', '#A96AFB'] },
            'Swift Transfer': { bg: '#0a0705', colors: ['#333333', '#606060', '#8c8c8c', '#b8b8b8', '#ffffff', '#f2f8f7', '#F21E2C', '#0d0907', '#0e0a08', '#0c0806', '#fec631', '#F9591F'] },
            'Taxi Station': { bg: '#d6cecf', colors: ['#635b5c', '#ffcc00', '#dcc9d2', '#efe7e8', '#efe7e8', '#4a4242', '#877e7f', '#9d9596', '#aba4a5', '#8e8687', '#807778', '#696263'] },
            'Thick Air': { bg: '#6f7369', colors: ['#afb3a9', '#3c4036', '#c8ccc2', '#99907a', '#a0cbbb', '#23271c', '#63675e', '#74786e', '#7f8478', '#696d63', '#5e6159', '#4d5049'] },
            'Timeless Static': { bg: '#e2e6e9', colors: ['#363153', '#58529f', '#837c7c', '#d6d6d6', '#d6d6d6', '#eeedee', '#eeeeee', '#f8f4f4', '#e7eaef', '#78615a', '#947fff', '#f4f4f4'] },
            'Tinted Ink': { bg: '#f1c1ea', colors: ['#001a33', '#3221A3', '#003366', '#001F3F', '#004080', '#00509E', '#2f4359', '#94a0d3', '#96a5b4', '#d1ddf2', '#838dd6', '#4A53BB'] },
            'Tourist Trap': { bg: '#fffaf0', colors: ['#ffcba1', '#ffcf46', '#d88c7a', '#ae5029', '#913f1d', '#fbf7e5', '#fef1f1', '#fff3ef', '#f8eaea', '#5e6d87', '#ffefa7', '#ffe0e0'] },
            'Tunnel Vision': { bg: '#968e8f', colors: ['#3f4245', '#dac5a1', '#31323c', '#1a1f20', '#21272a', '#cdc6bf', '#362c4a', '#3f3357', '#dac5a1', '#6d5c8d', '#332946', '#2a223a'] },
            'Ultra Violet': { bg: '#f4f2f7', colors: ['#E6E6FA', '#D8BFD8', '#9370DB', '#ffffff', '#6A5ACD', '#6959CD', '#d2c5e2', '#e2daea', '#f8f6fa', '#cbbfdb', '#b5a3cb', '#9479b4'] },
            'Under Bloom': { bg: '#2E535B', colors: ['#D8A8B7', '#F080A0', '#1CA66A', '#475BB5', '#E67424', '#3D2B56', '#294a51', '#30575f', '#345f68', '#2b4e56', '#27464d', '#203a3f'] },
            'Underdog': { bg: '#faf2f0', colors: ['#f37a37', '#ffa800', '#a79986', '#006BB6', '#006BB6', '#fec9ba', '#fec4a0', '#f5a071', '#fc9151', '#3ba1a6', '#ffce66', '#fce3c3'] },
            'Underground': { bg: '#1d2036', colors: ['#101019', '#1a1c2a', '#4a5572', '#567097', '#657fb8', '#7899c8', '#171927', '#173068', '#1d2032', '#181a29', '#161725', '#12131e'] },
            'Uptown': { bg: '#6b7b90', colors: ['#c1c1c3', '#fffd7b', '#ff0000', '#0002ff', '#fffc00', '#ff66cb', '#fffb7d', '#c1c1c3', '#f7f8c9', '#009bf7', '#4d545a', '#644cbe'] },
            'Vanilla Pastelo': { bg: '#fee6c1', colors: ['#929487', '#d41159', '#f26a8d', '#fee6c1', '#fae599', '#f9f8f7', '#fdd495', '#feeed6', '#ffffff', '#fdddab', '#fccb7f', '#fbb03d'] },
            'Vibrating Blocks': { bg: '#B7094C', colors: ['#A01A58', '#892B64', '#723C70', '#5C4D7D', '#455E89', '#2E6F95', '#1780A1', '#0091AD', '#000000', '#FFAA00', '#FFA500', '#2E8B57'] },
            'Waverly Lavender': { bg: '#d7cde3', colors: ['#ffffff', '#f7f1f7', '#b99fed', '#ffffff', '#8e81e0', '#8d7fe0', '#c0b1d3', '#e2daea', '#f8f6fa', '#cbbfdb', '#b5a3cb', '#9479b4'] },
            'Whisper Line': { bg: '#665b6c', colors: ['#e5e0e8', '#332839', '#1a0f20', '#aab2a9', '#bfb4c5', '#ff6600', '#5b5161', '#6b5f71', '#75687c', '#605666', '#564d5b', '#473f4b'] },
            'Wind Down': { bg: '#ae5029', colors: ['#ee9069', '#7b1d00', '#5e97ef', '#620400', '#ffa982', '#ff0033', '#a54720', '#b0522b', '#92340d', '#a74922', '#c37c57', '#3145a1'] },
            'World Fair': { bg: '#F3F0E8', colors: ['#89CFF0', '#FFB6C1', '#FFD700', '#8A2BE2', '#FFFFFF', '#A9A9A9', '#EDDDC5', '#D5C4A1', '#BFA47D', '#A78F5A', '#FF8C00', '#7B68EE'] },
            'Woven Glow': { bg: '#838293', colors: ['#504f60', '#363546', '#747385', '#ced7d9', '#ced7d9', '#5a5968', '#dcdbec', '#8a8999', '#df96b6', '#7b7a8c', '#fab6d4', '#fab6d4'] },
            'X Ray Film': { bg: '#0D0907', colors: ['#2b2b2b', '#505050', '#757575', '#9a9a9a', '#e6e6e6', '#f2f8f7', '#585454', '#302520', '#362f2b', '#201b18', '#fafafa', '#e6e6e6'] }
        };

        // Palette blurbs - short evocative descriptions
        const PALETTE_BLURBS = {
            'Aboveground Current': 'Electric blue pulse beneath the evening grid',
            'Alleyway': 'Neon haze through wet pavement at dusk',
            'Autumnal': 'Burnt leaves and brick, last warmth of the year',
            'Azulejos': 'Portuguese tile dreams, deep blue on white',
            'Beach Day': 'Sand in your shoes, salt on your skin',
            'Bee Line': 'High contrast, no detours, straight through',
            'Berlin': 'Club exit at 6am, grey sky salvation',
            'Bioluminescent': 'Deep sea glow, something alive down there',
            'Bitter Haze': 'Smoke break on the fire escape',
            'Blinker': 'Yellow caution through the midnight fog',
            'Blue Hour': 'That fifteen minutes when everything glows',
            'Blue Skies': 'Cloudless and wide open, nowhere to hide',
            'Blush Signal': 'Soft morning, coffee steam, bare feet',
            'Bodega Run': 'Fluorescent glow, corner store salvation',
            'Boiling Point': 'Summer concrete, tempers short, hydrant open',
            'Brick Facade': 'Old building, older stories, paint peeling',
            'Broadway': 'Marquee lights and taxi horns at curtain call',
            'Brooklyn': 'Fire escapes and rooftop sunsets',
            'Buenos Aires': 'Tango warmth, afternoon light through shutters',
            'Burnout': 'Running hot, fading fast, still beautiful',
            'Burnt Impression': 'Rust and sky, industrial coast',
            'Caffeine': 'First cup, newspaper ink, slow start',
            'Caramel Collision': 'Sticky sweet afternoon, golden hour spill',
            'Carioca': 'Carnival pink, sun-bleached and sweating',
            'CDMX': 'Terracotta and indigo, mercado morning',
            'Cerulean': 'Deep end of the pool, holding your breath',
            'Cinematic Site': 'Film noir fog, streetlight halo',
            'Clear Sky Blues': 'Not a cloud, not a worry, not today',
            'Concrete Cone': 'Construction orange, hard hat territory',
            'Concrete Heat': 'Pavement shimmer, ice cream truck distant',
            'Constellations': 'Rooftop stargazing, city lights below',
            'Cotton Candy Noise': 'Soft static, pastel frequencies',
            'Crosstown': 'Black and white, no grey area',
            'Cruiser': 'Low rider, windows down, bass heavy',
            'Curious Blue': 'Swimming pool light on the ceiling',
            'Daybreak Dust': 'First light on cracked earth, coffee in hand',
            'Diffused Grays': 'Overcast and okay with it',
            'Downplay': 'Muted tones, loud thoughts',
            'Dusk Session': 'Purple hour, skate park empty',
            'Dust Storm': 'Desert wind, eyes half-closed',
            'Evening Odds': 'Betting on the night, dealer takes all',
            'Fly Solo': 'Alone but not lonely, neon company',
            'Golden Hum': 'Honey light through dusty windows',
            'Hard Shadow': 'High noon, nowhere to hide',
            'Heat Wave': 'Too hot to move, too bright to see',
            'Hudson Happening': 'River breeze, downtown glitter',
            'Hyper Glow': 'Arcade cabinet, high score chase',
            'Impromptu Hue': 'Unplanned detour, better than expected',
            'Indigo Steps': 'Descending into the deep blue',
            'Into The Night': 'Past midnight, past caring',
            'Island Summer': 'Hammock weather, rum punch afternoon',
            'Jaipur Gem': 'Spice market shimmer, silk and stone',
            'Joyride': 'Borrowed car, empty highway, purple dusk',
            'La Haze': 'Smog and magic, city of angels',
            'Last Train Home': 'Platform shadows, midnight transfer',
            'Liberty Lane': 'Old glory, weathered but standing',
            'Live Jazz': 'Blue notes, brown liquor, red lips',
            'London Fog': 'Grey on grey, red bus cuts through',
            'Low Sun Rush': 'Golden hour traffic, windows down',
            'Lucid Blue': 'Clear thinking at impossible depths',
            'Manhattan': 'Concrete canyon, yellow cab flash',
            'Marakata': 'Emerald jungle, something ancient',
            'Marfa Memory': 'Desert art, mysterious lights',
            'Mauve Orleans': 'Wrought iron and wisteria',
            'Mental Mine': 'Deep in thought, digging for gold',
            'Miami': 'Vice colors, ocean drive, top down',
            'Midday Brights': 'Sun directly overhead, no shadows',
            'Midnight': 'City sleeps, you dont',
            'Minted Mile': 'Fresh start, green light, go',
            'Momentary Oasis': 'Brief respite, keep moving',
            'Mono Contrast': 'Black coffee, white walls, clear head',
            'Morning Meditation': 'Sunrise stretch, mind empty',
            'Mundane Morning': 'Regular day, regular way, okay',
            'Naturalistic': 'Earth tones, grounded feeling',
            'Neighborly Love': 'Philly warmth, front stoop summer',
            'New Resident': 'Just moved in, boxes everywhere',
            'Night Flow': 'Smooth ride through sleeping streets',
            'Night Light': 'Hallway glow, 3am thoughts',
            'One Phone Call': 'Late night dial, hoping they answer',
            'Other Planet': 'Somewhere else entirely, alien familiar',
            'Out Late': 'Should have left hours ago',
            'Pepdot': 'Primary colors, elementary joy',
            'Present Moment': 'Right here, right now, nowhere else',
            'Red Mirage': 'Heat shimmer, something approaching',
            'Renewal': 'Fresh coat, clean slate, try again',
            'Restful Pause': 'Lavender fields, eyes closed',
            'San Francisco': 'Fog rolling in, bridge barely visible',
            'Signal Arc': 'Radio waves, distant transmission',
            'Slow Collage': 'Cut and paste, take your time',
            'Soft Shadow': 'Gentle contrast, easy afternoon',
            'Subtle Static': 'White noise, background hum',
            'Sunset Blush': 'Sky embarrassed by its own beauty',
            'Swift Transfer': 'Platform to platform, dont miss it',
            'Taxi Station': 'Waiting for a ride, meter running',
            'Thick Air': 'Humid, heavy, hard to breathe',
            'Timeless Static': 'Always been here, always will be',
            'Tinted Ink': 'Love letter, purple prose',
            'Tourist Trap': 'Overpriced but worth the photo',
            'Tunnel Vision': 'One way forward, blinders on',
            'Ultra Violet': 'Beyond visible, feeling more than seeing',
            'Under Bloom': 'Cherry blossoms, looking up',
            'Underdog': 'Nobody expected this, watch closely',
            'Underground': 'Subway hum, stranger shoulders',
            'Uptown': 'Money moves, marble lobbies',
            'Vanilla Pastelo': 'Soft serve sunset, sweet and simple',
            'Vibrating Blocks': 'Cant sit still, too much energy',
            'Waverly Lavender': 'West Village morning, quiet street',
            'Whisper Line': 'Secrets passed, barely audible',
            'Wind Down': 'End of day, letting go',
            'World Fair': 'Retro future, optimism on display',
            'Woven Glow': 'Fabric of light, threaded through',
            'X Ray Film': 'See right through, nothing hidden'
        };

        let currentTokenId = 0;
        let currentSize = 'medium';
        let favorites = JSON.parse(localStorage.getItem('cities-favorites') || '[]');
        let tokenTraits = {};
        let tokenOwners = {};
        let traitValues = { timeOfDay: new Set(), palette: new Set(), bounds: new Set(), traffic: new Set(), line: new Set(), render: new Set(), zoom: new Set(), water: new Set() };
        let exploreInterval = null;
        let isFullscreen = false;
        let touchStartX = 0;
        let touchEndX = 0;

        const loadingBarContainer = document.getElementById('loadingBarContainer');
        const loadingBar = document.getElementById('loadingBar');
        const mobileMenuToggle = document.getElementById('mobileMenuToggle');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const frameContainer = document.getElementById('frameContainer');
        const previewImage = document.getElementById('preview-image');
        const tokenIdInput = document.getElementById('tokenId');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const displayToken = document.getElementById('displayToken');
        const ownerDisplay = document.getElementById('ownerDisplay');
        const galleryPanel = document.getElementById('galleryPanel');
        const galleryGrid = document.getElementById('galleryGrid');
        const favCount = document.getElementById('favCount');
        const statusMessage = document.getElementById('statusMessage');
        const traitsDisplay = document.getElementById('traitsDisplay');
        const matchCount = document.getElementById('matchCount');
        const collectorsPanel = document.getElementById('collectorsPanel');
        const supplyTracker = document.getElementById('supplyTracker');
        const filterTime = document.getElementById('filterTime');
        const filterPalette = document.getElementById('filterPalette');
        const filterBounds = document.getElementById('filterBounds');
        const filterTraffic = document.getElementById('filterTraffic');
        const filterLine = document.getElementById('filterLine');
        const filterRender = document.getElementById('filterRender');
        const filterZoom = document.getElementById('filterZoom');
        const filterWater = document.getElementById('filterWater');

        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            return { token: params.get('token') || params.get('t') };
        }

        function updateUrlWithToken(tokenId) {
            const url = new URL(window.location);
            url.searchParams.set('token', tokenId);
            window.history.replaceState({}, '', url);
        }

        function loadCachedTraits() {
            try {
                const cached = localStorage.getItem(TRAITS_CACHE_KEY);
                if (cached) {
                    const { data, timestamp } = JSON.parse(cached);
                    if (Date.now() - timestamp < CACHE_EXPIRY) { tokenTraits = data; return true; }
                }
            } catch (e) { console.error('Cache error', e); }
            return false;
        }

        function saveCachedTraits() {
            try { localStorage.setItem(TRAITS_CACHE_KEY, JSON.stringify({ data: tokenTraits, timestamp: Date.now() })); } catch (e) {}
        }

        function showLoadingBar() { loadingBarContainer.classList.add('visible'); }
        function hideLoadingBar() { loadingBarContainer.classList.remove('visible'); loadingBar.style.width = '0%'; }
        function updateLoadingBar(progress) { loadingBar.style.width = `${progress}%`; }

        function toggleMobileMenu() {
            const isOpen = sidebar.classList.toggle('open');
            mobileMenuToggle.classList.toggle('active', isOpen);
            sidebarOverlay.classList.toggle('visible', isOpen);
            document.body.style.overflow = isOpen ? 'hidden' : '';
        }

        function closeMobileMenu() {
            sidebar.classList.remove('open');
            mobileMenuToggle.classList.remove('active');
            sidebarOverlay.classList.remove('visible');
            document.body.style.overflow = '';
        }

        mobileMenuToggle.addEventListener('click', toggleMobileMenu);
        sidebarOverlay.addEventListener('click', closeMobileMenu);

        // Handle window resize to fix responsive state
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const isMobile = window.innerWidth <= 768;
                if (!isMobile) {
                    // Reset mobile menu state when going to desktop
                    closeMobileMenu();
                    sidebar.classList.remove('open');
                }
            }, 100);
        });

        function getGeneratorUrl(tokenId) { return `${GENERATOR}/${CONTRACT}/${tokenId}`; }
        function getPreviewUrl(tokenId) { return `${MEDIA_BASE}/${CONTRACT}/${tokenId}.png`; }
        function getThumbnailUrl(tokenId) { return `${MEDIA_BASE}/${CONTRACT}/${tokenId}.png?width=200`; }
        function getSmallThumbnailUrl(tokenId) { return `${MEDIA_BASE}/${CONTRACT}/${tokenId}.png?width=50`; }

        // Helper to parse hex color to RGB
        function hexToRgb(hex) {
            const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
            } : { r: 128, g: 128, b: 128 };
        }

        // Helper to convert RGB to hex
        function rgbToHex(r, g, b) {
            return '#' + [r, g, b].map(x => Math.round(Math.max(0, Math.min(255, x))).toString(16).padStart(2, '0')).join('');
        }

        // Calculate relative luminance
        function getLuminance(hex) {
            const rgb = hexToRgb(hex);
            const [r, g, b] = [rgb.r, rgb.g, rgb.b].map(c => {
                c = c / 255;
                return c <= 0.03928 ? c / 12.92 : Math.pow((c + 0.055) / 1.055, 2.4);
            });
            return 0.2126 * r + 0.7152 * g + 0.0722 * b;
        }

        // Get contrast ratio between two colors
        function getContrastRatio(hex1, hex2) {
            const l1 = getLuminance(hex1);
            const l2 = getLuminance(hex2);
            const lighter = Math.max(l1, l2);
            const darker = Math.min(l1, l2);
            return (lighter + 0.05) / (darker + 0.05);
        }

        // Adjust spot color for contrast against background
        function getContrastingSpotColor(spotColor, bgColor) {
            const contrast = getContrastRatio(spotColor, bgColor);
            if (contrast >= 2.5) return spotColor; // Good enough contrast

            const spotRgb = hexToRgb(spotColor);
            const bgLum = getLuminance(bgColor);

            // If background is dark, lighten the spot color; if light, darken it
            const factor = bgLum > 0.5 ? 0.6 : 1.6;
            const adjusted = rgbToHex(
                spotRgb.r * factor + (factor > 1 ? 40 : 0),
                spotRgb.g * factor + (factor > 1 ? 40 : 0),
                spotRgb.b * factor + (factor > 1 ? 40 : 0)
            );

            // If still not enough contrast, go more extreme
            if (getContrastRatio(adjusted, bgColor) < 2.5) {
                return bgLum > 0.5 ? '#333333' : '#FFFFFF';
            }
            return adjusted;
        }

        function generateGridItem(id, showRank = false, rank = 0, eagerLoad = false) {
            const traits = tokenTraits[id];
            const palette = traits?.['Palette'];
            const paletteData = PALETTE_DATA[palette];
            const bgColor = paletteData?.bg || '#1a1a2e';
            const rawSpotColor = paletteData?.colors?.[10] || '#FFE135';
            const spotColor = getContrastingSpotColor(rawSpotColor, bgColor);
            // Find a contrasting color from the palette for the heart icon
            const colors = paletteData?.colors || [];
            let spotTextColor = getLuminance(spotColor) > 0.5 ? '#000' : '#fff';
            // Try to find a palette color that contrasts well with the spot color
            for (const c of [colors[0], colors[1], colors[2], colors[3], bgColor, colors[11]]) {
                if (c && getContrastRatio(c, spotColor) >= 3) {
                    spotTextColor = c;
                    break;
                }
            }
            const loadingAttr = eagerLoad ? 'eager' : 'lazy';
            return `
                <div class="grid-item" data-token="${id}" style="background:${bgColor}; --spot-color:${spotColor}; --spot-text:${spotTextColor};">
                    <button class="grid-item-fav ${isCityFavorited(id) ? 'favorited' : ''}" data-token="${id}"></button>
                    <img src="${getSmallThumbnailUrl(id)}" alt="City ${id}" loading="${loadingAttr}" decoding="async">
                    <div class="grid-item-label">#${id}</div>
                    ${showRank ? `<div class="grid-item-rank">#${rank}</div>` : ''}
                    ${generateGridTooltip(id)}
                </div>
            `;
        }

        // Image loading with retry
        function loadImageWithRetry(img, url, retries = 2) {
            img.onerror = () => {
                if (retries > 0) {
                    setTimeout(() => {
                        img.src = url + '&retry=' + (3 - retries);
                        loadImageWithRetry(img, url, retries - 1);
                    }, 1000);
                } else {
                    img.style.opacity = '0.3';
                    img.alt = 'Failed to load';
                }
            };
        }
        function shortenAddress(address) { return address ? address.slice(0, 6) + '...' + address.slice(-4) : ''; }

        async function fetchTokenTraits(tokenId) {
            if (tokenTraits[tokenId]) return tokenTraits[tokenId];
            try {
                const response = await fetch(`https://token.artblocks.io/${CONTRACT}/${tokenId}`);
                const data = await response.json();
                const traits = {};
                if (data.features) { for (const [key, value] of Object.entries(data.features)) { traits[key] = value; } }
                tokenTraits[tokenId] = traits;
                return traits;
            } catch (e) { return null; }
        }

        async function fetchTokenOwner(tokenId) {
            if (tokenOwners[tokenId]) return tokenOwners[tokenId];
            try {
                // Use Art Blocks Hasura GraphQL API for owner data and user display name
                const query = `{
                    tokens_metadata(where: {contract_address: {_eq: "${CONTRACT}"}, token_id: {_eq: "${tokenId}"}}) {
                        token_id
                        owner_address
                    }
                }`;
                const response = await fetch('https://data.artblocks.io/v1/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await response.json();

                if (data.data?.tokens_metadata?.[0]?.owner_address) {
                    const ownerAddress = data.data.tokens_metadata[0].owner_address;
                    const owner = {
                        address: ownerAddress,
                        ens: null,
                        artblocksName: null
                    };

                    // Try to get Art Blocks display name for the owner
                    try {
                        const userQuery = `{ users(where: {public_address: {_eq: "${ownerAddress}"}}) { display_name } }`;
                        const userResponse = await fetch('https://data.artblocks.io/v1/graphql', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ query: userQuery })
                        });
                        const userData = await userResponse.json();
                        if (userData.data?.users?.[0]?.display_name) {
                            owner.artblocksName = userData.data.users[0].display_name;
                        }
                    } catch (e) { /* User fetch failed */ }

                    // Try ENS lookup if no Art Blocks name
                    if (!owner.artblocksName) {
                        try {
                            const ensResponse = await fetch(`https://api.ensideas.com/ens/resolve/${ownerAddress}`);
                            if (ensResponse.ok) {
                                const ensData = await ensResponse.json();
                                if (ensData.name) owner.ens = ensData.name;
                            }
                        } catch (e) { /* ENS fetch failed */ }
                    }

                    tokenOwners[tokenId] = owner;
                    return owner;
                }
                return { address: null, ens: null, artblocksName: null };
            } catch (e) {
                console.log('Owner fetch error:', e);
                return { address: null, ens: null, artblocksName: null };
            }
        }

        async function fetchTokenData(tokenId) {
            const [traits, owner] = await Promise.all([fetchTokenTraits(tokenId), fetchTokenOwner(tokenId)]);
            return { traits, owner };
        }

        async function loadAllTokenData() {
            const hasCached = loadCachedTraits();
            if (hasCached && Object.keys(tokenTraits).length >= MAX_TOKEN) {
                matchCount.textContent = 'LOADING FROM CACHE...';
                extractTraitValues(); populateFilters(); updateMatchCount();
                openGridOnLoad();
                return;
            }
            matchCount.textContent = 'LOADING TRAITS...';
            showLoadingBar();
            const batchSize = 20;
            let loaded = 0;
            const total = MAX_TOKEN + 1;
            for (let i = 0; i <= MAX_TOKEN; i += batchSize) {
                const batch = [];
                for (let j = i; j < Math.min(i + batchSize, MAX_TOKEN + 1); j++) { batch.push(fetchTokenTraits(j)); }
                await Promise.all(batch);
                loaded += batch.length;
                updateLoadingBar(Math.round((loaded / total) * 100));
                matchCount.textContent = `TRAITS ${Math.min(loaded, total)}/${total}`;
            }
            hideLoadingBar();
            saveCachedTraits();
            extractTraitValues(); populateFilters(); updateMatchCount();
            openGridOnLoad();
        }

        function extractTraitValues() {
            for (const [tokenId, traits] of Object.entries(tokenTraits)) {
                if (!traits) continue;
                if (traits['Time of Day']) traitValues.timeOfDay.add(traits['Time of Day']);
                if (traits['Palette']) traitValues.palette.add(traits['Palette']);
                if (traits['Bounds']) traitValues.bounds.add(traits['Bounds']);
                if (traits['Traffic']) traitValues.traffic.add(traits['Traffic']);
                if (traits['Line']) traitValues.line.add(traits['Line']);
                if (traits['Render']) traitValues.render.add(traits['Render']);
                if (traits['Zoom']) traitValues.zoom.add(traits['Zoom']);
                if (traits['Water Feature']) traitValues.water.add(traits['Water Feature']);
            }
        }

        function populateFilters() {
            populateFilter(filterTime, traitValues.timeOfDay);
            populateFilter(filterPalette, traitValues.palette);
            populateFilter(filterBounds, traitValues.bounds);
            populateFilter(filterTraffic, traitValues.traffic);
            populateFilter(filterLine, traitValues.line, { 'Lighter': 'Chisel' });
            populateFilter(filterRender, traitValues.render);
            populateFilter(filterZoom, traitValues.zoom);
            populateFilter(filterWater, traitValues.water);
        }

        function populateFilter(select, values, displayMap = {}) {
            Array.from(values).sort().forEach(value => {
                const option = document.createElement('option');
                option.value = value;
                option.textContent = displayMap[value] || value;
                select.appendChild(option);
            });
        }

        function getFilteredTokens() {
            const filters = { timeOfDay: filterTime.value, palette: filterPalette.value, bounds: filterBounds.value, traffic: filterTraffic.value, line: filterLine.value, render: filterRender.value, zoom: filterZoom.value, water: filterWater.value };
            const hasFilters = Object.values(filters).some(v => v);
            if (!hasFilters) return Array.from({ length: MAX_TOKEN + 1 }, (_, i) => i);
            const matches = [];
            for (let i = 0; i <= MAX_TOKEN; i++) {
                const traits = tokenTraits[i];
                if (!traits) continue;
                let match = true;
                if (filters.timeOfDay && traits['Time of Day'] !== filters.timeOfDay) match = false;
                if (filters.palette && traits['Palette'] !== filters.palette) match = false;
                if (filters.bounds && traits['Bounds'] !== filters.bounds) match = false;
                if (filters.traffic && traits['Traffic'] !== filters.traffic) match = false;
                if (filters.line && traits['Line'] !== filters.line) match = false;
                if (filters.render && traits['Render'] !== filters.render) match = false;
                if (filters.zoom && traits['Zoom'] !== filters.zoom) match = false;
                if (filters.water && traits['Water Feature'] !== filters.water) match = false;
                if (match) matches.push(i);
            }
            return matches;
        }

        function updateMatchCount() {
            const matches = getFilteredTokens();
            const hasFilters = [filterTime, filterPalette, filterBounds, filterTraffic, filterLine, filterRender, filterZoom, filterWater].some(f => f.value);
            matchCount.innerHTML = hasFilters ? `<strong>${matches.length}</strong> MATCHES` : '';
        }

        function renderCollectorsPills() {
            const pillsContainer = document.getElementById('collectorsPills');

            // Vibrant colors that pop off dark background
            const VIBRANT_PILLS = [
                { bg: '#FF6B6B', text: '#000' },      // Coral red
                { bg: '#4ECDC4', text: '#000' },      // Teal
                { bg: '#FFE66D', text: '#000' },      // Yellow
                { bg: '#95E1D3', text: '#000' },      // Mint
                { bg: '#F38181', text: '#000' },      // Salmon
                { bg: '#AA96DA', text: '#000' },      // Lavender
                { bg: '#FCBAD3', text: '#000' },      // Pink
                { bg: '#A8D8EA', text: '#000' },      // Sky blue
                { bg: '#FF9F43', text: '#000' },      // Orange
                { bg: '#5DD39E', text: '#000' },      // Green
                { bg: '#BCE784', text: '#000' },      // Lime
                { bg: '#DDA0DD', text: '#000' },      // Plum
                { bg: '#87CEEB', text: '#000' },      // Light blue
                { bg: '#F0E68C', text: '#000' },      // Khaki
                { bg: '#98D8C8', text: '#000' },      // Seafoam
                { bg: '#FFB6C1', text: '#000' },      // Light pink
                { bg: '#77DD77', text: '#000' },      // Pastel green
                { bg: '#FDFD96', text: '#000' },      // Pastel yellow
                { bg: '#B19CD9', text: '#000' },      // Pastel purple
                { bg: '#FF6961', text: '#000' },      // Pastel red
                { bg: '#FFB347', text: '#000' },      // Pastel orange
                { bg: '#03C6FC', text: '#000' },      // Bright cyan
                { bg: '#FC6C85', text: '#000' },      // Watermelon
                { bg: '#C1E1C1', text: '#000' },      // Tea green
            ];

            // Shuffle the vibrant colors
            const shuffledColors = shuffleArray(VIBRANT_PILLS);

            pillsContainer.innerHTML = COLLECTORS_DATA.map((collector, i) => {
                const palette = shuffledColors[i % shuffledColors.length];
                const emoji = CITY_EMOJIS[i % CITY_EMOJIS.length];
                // Add multi-holder class for collectors with 2+ cities
                const multiClass = collector.count >= 2 ? ' multi-holder' : '';
                return `<span class="collector-pill${multiClass}" data-collector="${collector.name}" style="background: ${palette.bg}; color: ${palette.text}; --pill-index: ${i};">${collector.name}<span class="pill-count">${collector.count}</span><span class="pill-emoji">${emoji}  ${collector.count}</span></span>`;
            }).join('');

            // Add click handlers for pills
            pillsContainer.querySelectorAll('.collector-pill').forEach(pill => {
                pill.addEventListener('click', () => {
                    const collectorName = pill.dataset.collector;
                    fetchCollectorTokens(collectorName);
                });
            });
        }

        let currentCollectorFilter = null;

        async function fetchCollectorTokens(collectorName) {
            // Show loading state
            const banner = document.getElementById('collectorBanner');
            document.getElementById('collectorBannerName').textContent = collectorName + '...';
            banner.classList.add('visible');

            // Close collectors panel and open grid
            collectorsPanel.classList.remove('open');
            document.getElementById('gridPanel').classList.add('open');

            // First check if we already have this data from the collectors fetch
            const cachedCollector = COLLECTORS_DATA.find(c => c.name === collectorName);
            if (cachedCollector && cachedCollector.tokens && cachedCollector.tokens.length > 0) {
                showCollectorInGrid(collectorName, cachedCollector.tokens);
                return;
            }

            // Otherwise fetch from API
            try {
                // Query Art Blocks API for tokens owned by this collector
                const query = `{
                    users(where: {display_name: {_eq: "${collectorName}"}}) {
                        public_address
                    }
                }`;
                const response = await fetch('https://data.artblocks.io/v1/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await response.json();

                if (data.data?.users?.[0]?.public_address) {
                    const address = data.data.users[0].public_address;
                    // Now get tokens owned by this address for this contract
                    const tokensQuery = `{
                        tokens_metadata(where: {contract_address: {_eq: "${CONTRACT}"}, owner_address: {_eq: "${address}"}}) {
                            token_id
                        }
                    }`;
                    const tokensResponse = await fetch('https://data.artblocks.io/v1/graphql', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: tokensQuery })
                    });
                    const tokensData = await tokensResponse.json();

                    if (tokensData.data?.tokens_metadata) {
                        const tokens = tokensData.data.tokens_metadata.map(t => parseInt(t.token_id));
                        showCollectorInGrid(collectorName, tokens);
                        return;
                    }
                }
            } catch (e) {
                console.log('Error fetching collector tokens:', e);
            }

            // Fallback - just show empty state
            showCollectorInGrid(collectorName, []);
        }

        function showCollectorInGrid(collectorName, tokens) {
            currentCollectorFilter = { name: collectorName, tokens: tokens };

            // Update banner with final name
            document.getElementById('collectorBannerName').textContent = collectorName;

            // Reset to simple grid mode for collector view
            gridMode = 'grid';
            document.querySelectorAll('.grid-mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('.grid-mode-btn[data-mode="grid"]').classList.add('active');

            renderGrid();
        }

        function clearCollectorFilter() {
            currentCollectorFilter = null;
            document.getElementById('collectorBanner').classList.remove('visible');
            renderGrid();
        }

        function renderLeaderboard() {
            // Light, readable colors for leaderboard names
            const LEADERBOARD_COLORS = [
                '#E8B86D', '#D4A574', '#F5D6BA', '#FFB88C', '#FFC9A8',
                '#B8D4E3', '#A8E6CF', '#DCEDC1', '#FFD3B6', '#FFAAA5',
                '#C9B1FF', '#B5EAD7', '#E2F0CB', '#FFDAC1', '#FF9AA2',
                '#C7CEEA', '#E0BBE4', '#FEC8D8', '#D4F0F0', '#FCE1E4'
            ];
            const leaderboardList = document.getElementById('leaderboardList');
            // Filter to 2+ cities and sort strictly by count (highest first)
            const multiCollectors = COLLECTORS_DATA.filter(c => c.count >= 2).sort((a, b) => b.count - a.count);
            const maxCount = multiCollectors[0]?.count || 1;
            leaderboardList.innerHTML = multiCollectors.map((collector, i) => {
                const color = LEADERBOARD_COLORS[i % LEADERBOARD_COLORS.length];
                const barWidth = (collector.count / maxCount) * 100;
                return `<li class="leaderboard-item" data-collector="${collector.name}" style="cursor: pointer;"><div class="leaderboard-item-header"><span class="leaderboard-rank">${i + 1}</span><span class="leaderboard-name" style="color: ${color}">${collector.name}</span><span class="leaderboard-count">${collector.count}</span></div><div class="leaderboard-bar"><div class="leaderboard-bar-fill" style="width: ${barWidth}%; background: ${color};"></div></div></li>`;
            }).join('');

            // Add click handlers for leaderboard items
            leaderboardList.querySelectorAll('.leaderboard-item').forEach(item => {
                item.addEventListener('click', () => {
                    const collectorName = item.dataset.collector;
                    fetchCollectorTokens(collectorName);
                });
            });
        }

        function showLeaderboardView() {
            document.getElementById('pillsView').classList.add('hidden');
            document.getElementById('leaderboardView').classList.add('active');
            document.querySelector('.collectors-title-text').textContent = 'LEADERBOARD';
        }

        function showPillsView() {
            document.getElementById('pillsView').classList.remove('hidden');
            document.getElementById('leaderboardView').classList.remove('active');
            document.querySelector('.collectors-title-text').textContent = 'COLLECTORS';
        }

        async function fetchCollectorsData() {
            try {
                // Fetch all tokens with their owners from Art Blocks API
                const query = `{
                    tokens_metadata(where: {contract_address: {_eq: "${CONTRACT}"}}) {
                        token_id
                        owner_address
                    }
                }`;
                const response = await fetch('https://data.artblocks.io/v1/graphql', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });
                const data = await response.json();

                if (data.data?.tokens_metadata) {
                    // Group by owner address
                    const ownerCounts = {};
                    data.data.tokens_metadata.forEach(token => {
                        const addr = token.owner_address;
                        if (!ownerCounts[addr]) ownerCounts[addr] = { count: 0, tokens: [] };
                        ownerCounts[addr].count++;
                        ownerCounts[addr].tokens.push(parseInt(token.token_id));
                    });

                    // Fetch display names for all owners
                    const addresses = Object.keys(ownerCounts);
                    const usersQuery = `{
                        users(where: {public_address: {_in: [${addresses.map(a => `"${a}"`).join(',')}]}}) {
                            public_address
                            display_name
                        }
                    }`;
                    const usersResponse = await fetch('https://data.artblocks.io/v1/graphql', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query: usersQuery })
                    });
                    const usersData = await usersResponse.json();

                    // Map addresses to display names
                    const addressToName = {};
                    if (usersData.data?.users) {
                        usersData.data.users.forEach(u => {
                            if (u.display_name) addressToName[u.public_address] = u.display_name;
                        });
                    }

                    // Custom alias overrides - map API names to preferred display names
                    // Keys are LOWERCASE for case-insensitive matching
                    const nameAliases = {
                        // WillEP variations
                        'valisdao': 'WillEP',
                        'valisdao2': 'WillEP',
                        'valisdao.eth': 'WillEP',
                        'willep': 'WillEP',
                        'willep.eth': 'WillEP',
                        // OblivionNFT variations
                        'nyc': 'OblivionNFT',
                        'nftoblivion': 'OblivionNFT',
                        'oblivionnft': 'OblivionNFT',
                        'oblivionnft.eth': 'OblivionNFT',
                        'oblivion': 'OblivionNFT',
                        // REDBEARDNFT variations
                        'dr. whet faartz': 'REDBEARDNFT',
                        'dr whet faartz': 'REDBEARDNFT',
                        'drwhetfaartz': 'REDBEARDNFT',
                        'drwhetfaartz.eth': 'REDBEARDNFT',
                        'redbeardnft': 'REDBEARDNFT',
                        'redbeardnft.eth': 'REDBEARDNFT',
                        'redbeard': 'REDBEARDNFT',
                        // Unnikrishna variations
                        'unnikrishna m damodaran': 'Unnikrishna',
                        'unnikrishna': 'Unnikrishna',
                        'unnikrishna.eth': 'Unnikrishna',
                        // Specific ENS aliases
                        'bsy.eth': 'BatSoupYum',
                        'bsy': 'BatSoupYum',
                        'zaz.eth': 'Zanzibar',
                        'zaz': 'Zanzibar'
                    };

                    // Function to clean up ENS names - remove .eth suffix unless there's a specific alias
                    function cleanEnsName(name) {
                        if (!name) return name;
                        const lowerName = name.toLowerCase();
                        // Check for specific alias first
                        if (nameAliases[lowerName]) return nameAliases[lowerName];
                        // Remove .eth suffix
                        if (name.toLowerCase().endsWith('.eth')) {
                            return name.slice(0, -4);
                        }
                        return name;
                    }

                    // Direct wallet address prefix to name mappings (for wallets without Art Blocks names)
                    // Uses prefix matching - just the first few chars of the address
                    const walletPrefixAliases = {
                        '0xcf22': 'The Lost Cities',  // 14 cities
                        '0x6a08': 'WillEP',  // 11 cities
                    };

                    // Apply wallet prefix aliases - match addresses by their starting characters
                    addresses.forEach(addr => {
                        const lowerAddr = addr.toLowerCase();
                        Object.keys(walletPrefixAliases).forEach(prefix => {
                            if (lowerAddr.startsWith(prefix.toLowerCase()) && !addressToName[addr]) {
                                addressToName[addr] = walletPrefixAliases[prefix];
                            }
                        });
                    });

                    // Apply cleanEnsName to existing names (removes .eth, applies aliases)
                    Object.keys(addressToName).forEach(addr => {
                        addressToName[addr] = cleanEnsName(addressToName[addr]);
                    });

                    // Try ENS resolution for ALL addresses without names
                    // Process in batches to avoid overwhelming the API
                    const addressesWithoutNames = addresses.filter(addr => !addressToName[addr]);
                    const batchSize = 10;

                    for (let i = 0; i < addressesWithoutNames.length; i += batchSize) {
                        const batch = addressesWithoutNames.slice(i, i + batchSize);
                        const ensPromises = batch.map(async addr => {
                            try {
                                const ensResponse = await fetch(`https://api.ensideas.com/ens/resolve/${addr}`);
                                if (ensResponse.ok) {
                                    const ensData = await ensResponse.json();
                                    if (ensData.name) {
                                        addressToName[addr] = ensData.name;
                                    }
                                }
                            } catch (e) { /* ENS fetch failed, continue */ }
                        });
                        await Promise.all(ensPromises);
                    }

                    // Apply cleanEnsName to all names (removes .eth, applies aliases)
                    Object.keys(addressToName).forEach(addr => {
                        addressToName[addr] = cleanEnsName(addressToName[addr]);
                    });

                    // Build collectors array (exclude efdot and efdot x diid)
                    const excludeNames = ['efdot', 'efdot x diid', 'efdotxdiid'];
                    const rawCollectors = addresses.map(addr => ({
                        name: addressToName[addr] || addr.slice(0, 6) + '...' + addr.slice(-4),
                        address: addr,
                        count: ownerCounts[addr].count,
                        tokens: ownerCounts[addr].tokens,
                        hasName: !!addressToName[addr]
                    })).filter(c => !excludeNames.some(ex => c.name.toLowerCase().includes(ex.toLowerCase())));

                    // Merge collectors with same display name (e.g., WillEP from multiple wallets)
                    const mergedByName = {};
                    rawCollectors.forEach(c => {
                        if (mergedByName[c.name]) {
                            mergedByName[c.name].count += c.count;
                            mergedByName[c.name].tokens = mergedByName[c.name].tokens.concat(c.tokens);
                        } else {
                            mergedByName[c.name] = { ...c };
                        }
                    });

                    COLLECTORS_DATA = Object.values(mergedByName)
                    // Sort: named collectors first (by count), then wallet-only (by count)
                    .sort((a, b) => {
                        if (a.hasName && !b.hasName) return -1;
                        if (!a.hasName && b.hasName) return 1;
                        return b.count - a.count;
                    });

                    // Update stats
                    const totalCollectors = COLLECTORS_DATA.length;
                    const totalCollected = data.data.tokens_metadata.length;
                    document.querySelector('.collectors-stats').innerHTML = `<strong>${totalCollectors}</strong> COLLECTORS  <strong>${totalCollected}</strong> CITIES COLLECTED`;
                    const statsEl = document.getElementById('statsCollectors');
                    if (statsEl) statsEl.textContent = totalCollectors;

                    // Re-render
                    renderCollectorsPills();
                    renderLeaderboard();
                }
            } catch (e) {
                console.log('Error fetching collectors:', e);
            }
        }

        function initCollectorsPanel() {
            // Show loading state
            document.getElementById('collectorsPills').innerHTML = '<span style="color: var(--text-muted); font-size: 10px;">Loading collectors...</span>';

            // Fetch live data
            fetchCollectorsData();

            document.getElementById('showLeaderboard').addEventListener('click', showLeaderboardView);
            document.getElementById('backToPills').addEventListener('click', showPillsView);
            document.getElementById('collectorBannerClose').addEventListener('click', clearCollectorFilter);
        }

        function getTraitRarity(traitKey, traitValue) {
            if (totalMinted === 0) return null;
            let count = 0;
            if (traitKey === 'Palette') count = traitCounts.palettes[traitValue] || 0;
            else if (traitKey === 'Time of Day') count = traitCounts.times[traitValue] || 0;
            else if (traitKey === 'Zoom') count = traitCounts.zooms[traitValue] || 0;
            else if (traitKey === 'Bounds') count = traitCounts.bounds[traitValue] || 0;
            else if (traitKey === 'Traffic') count = traitCounts.traffic[traitValue] || 0;
            else if (traitKey === 'Line') count = traitCounts.lines[traitValue] || 0;
            else if (traitKey === 'Energy') count = traitCounts.energy[traitValue] || 0;
            else if (traitKey === 'Commute') count = traitCounts.commute[traitValue] || 0;
            else if (traitKey === 'Transit') count = traitCounts.transit[traitValue] || 0;
            else if (traitKey === 'Water Feature') count = traitCounts.water[traitValue] || 0;
            else return null;
            const pct = Math.round((count / totalMinted) * 100);
            return { count, pct };
        }

        function generateGridTooltip(tokenId) {
            const traits = tokenTraits[tokenId];
            if (!traits) return '';
            const keyTraits = ['Time of Day', 'Zoom', 'Bounds', 'Traffic'];
            const rows = keyTraits.map(key => {
                const value = traits[key];
                if (!value) return '';
                const rarity = getTraitRarity(key, value);
                const pctClass = rarity && rarity.pct <= 10 ? 'rare' : '';
                const pctHtml = rarity ? `<span class="grid-item-tooltip-pct ${pctClass}">${rarity.pct}%</span>` : '';
                return `<div class="grid-item-tooltip-row">
                    <span class="grid-item-tooltip-label">${key.replace('Time of Day', 'Time').toUpperCase()}</span>
                    <span><span class="grid-item-tooltip-value">${value}</span>${pctHtml}</span>
                </div>`;
            }).filter(Boolean).join('');
            return `<div class="grid-item-tooltip">${rows}</div>`;
        }

        function displayCurrentTraits(traits) {
            if (!traits) { traitsDisplay.innerHTML = '<div class="trait-row"><span class="trait-name">LOADING...</span></div>'; return; }
            // Rename "Lighter" to "Chisel" for Line trait display
            const displayValue = (key, value) => key === 'Line' && value === 'Lighter' ? 'Chisel' : value;
            // Order traits with Palette and Traffic at top
            const traitOrder = ['Palette', 'Traffic'];
            const sortedEntries = Object.entries(traits).sort((a, b) => {
                const aIndex = traitOrder.indexOf(a[0]);
                const bIndex = traitOrder.indexOf(b[0]);
                if (aIndex !== -1 && bIndex !== -1) return aIndex - bIndex;
                if (aIndex !== -1) return -1;
                if (bIndex !== -1) return 1;
                return 0;
            });
            let html = sortedEntries.map(([key, value]) => {
                const rarity = getTraitRarity(key, value);
                const rarityHtml = rarity ? `<span class="trait-rarity ${rarity.pct <= 10 ? 'rare' : ''}">${rarity.pct}%</span>` : '';
                return `<div class="trait-row"><span class="trait-name">${key.toUpperCase()}</span><span class="trait-value">${displayValue(key, value).toUpperCase()}</span>${rarityHtml}</div>`;
            }).join('');

            // Add compact color swatches for the palette (no hex codes - those are in inspector)
            const palette = traits['Palette'];
            if (palette && PALETTE_DATA[palette]) {
                const paletteInfo = PALETTE_DATA[palette];
                const swatches = paletteInfo.colors.map(c => `<span style="display:inline-block;width:12px;height:12px;background:${c};border-radius:3px;"></span>`).join('');
                html += `<div class="trait-swatches">${swatches}</div>`;
            }

            traitsDisplay.innerHTML = html;
        }

        function displayOwnerInfo(owner, loading = false) {
            if (loading) {
                ownerDisplay.innerHTML = '<span style="opacity:0.5">LOADING OWNER...</span>';
                return;
            }
            if (!owner || !owner.address) {
                ownerDisplay.innerHTML = '<span style="opacity:0.5">OWNER UNKNOWN</span>';
                return;
            }
            // Priority: Art Blocks username > ENS > shortened address
            const displayName = owner.artblocksName || owner.ens || shortenAddress(owner.address);
            ownerDisplay.innerHTML = `OWNED BY <a href="https://www.artblocks.io/user/${owner.address}" target="_blank">${displayName.toUpperCase()}</a>`;
        }

        async function loadOutput(tokenId = null, updateUrl = true) {
            currentTokenId = tokenId !== null ? tokenId : parseInt(tokenIdInput.value) || 0;
            currentTokenId = Math.max(0, Math.min(currentTokenId, MAX_TOKEN));
            displayToken.textContent = currentTokenId;
            tokenIdInput.value = currentTokenId;
            if (updateUrl) updateUrlWithToken(currentTokenId);
            saveLastViewed();

            // Fade out current image
            previewImage.classList.add('fade-out');
            previewImage.classList.remove('loaded'); // Remove loaded state for fullscreen transition
            loadingOverlay.classList.remove('hidden');

            setTimeout(() => {
                previewImage.style.display = 'block';
                previewImage.src = getPreviewUrl(currentTokenId);
            }, 150);

            closeMobileMenu();
            displayOwnerInfo(null, true); // Show loading state
            const data = await fetchTokenData(currentTokenId);
            displayCurrentTraits(data.traits);
            displayOwnerInfo(data.owner, false);
            updateCityNote();
            updateBackgroundColors(data.traits);
            updateMarketplaceLinks(currentTokenId);
            updateSimilarOutputs();
            updateFavoriteButton();
            preloadAdjacentImages();
        }

        previewImage.addEventListener('load', () => {
            loadingOverlay.classList.add('hidden');
            previewImage.classList.remove('fade-out');
            previewImage.classList.add('just-loaded');
            // Add loaded class for fullscreen smooth appearance
            if (isFullscreen) {
                previewImage.classList.add('loaded');
            }
            setTimeout(() => previewImage.classList.remove('just-loaded'), 250);
        });
        previewImage.addEventListener('error', () => {
            loadingOverlay.classList.add('hidden');
            previewImage.style.display = 'none';
            previewImage.classList.remove('fade-out');
        });

        function getTokenPageUrl(tokenId) { return `https://www.artblocks.io/token/${CONTRACT}/${tokenId}`; }
        function getOpenSeaUrl(tokenId) { return `https://opensea.io/assets/ethereum/${CONTRACT}/${tokenId}`; }
        function openFullView() { window.open(getTokenPageUrl(currentTokenId), '_blank'); }
        frameContainer.addEventListener('click', openFullView);

        function updateMarketplaceLinks(tokenId) {
            const linkOpenSea = document.getElementById('linkOpenSea');
            const linkArtBlocks = document.getElementById('linkArtBlocks');
            const linkRaster = document.getElementById('linkRaster');
            const iconOpenSea = document.getElementById('iconOpenSea');
            const iconArtBlocks = document.getElementById('iconArtBlocks');
            const makeOfferBtn = document.getElementById('makeOfferBtn');
            if (linkOpenSea) linkOpenSea.href = getOpenSeaUrl(tokenId);
            if (linkArtBlocks) linkArtBlocks.href = getTokenPageUrl(tokenId);
            if (linkRaster) linkRaster.href = `https://rfrsh.io/${CONTRACT}/${tokenId}`;
            if (iconOpenSea) iconOpenSea.href = getOpenSeaUrl(tokenId);
            if (iconArtBlocks) iconArtBlocks.href = getTokenPageUrl(tokenId);
            if (makeOfferBtn) makeOfferBtn.href = `https://opensea.io/assets/ethereum/${CONTRACT}/${tokenId}`;

            // Fetch listing info from Reservoir
            fetchListingInfo(tokenId);
        }

        async function fetchListingInfo(tokenId) {
            const listingInfo = document.getElementById('listingInfo');
            listingInfo.classList.remove('visible');

            try {
                const response = await fetch(`https://api.reservoir.tools/tokens/v7?tokens=${CONTRACT}:${tokenId}&includeAttributes=false`);
                const data = await response.json();

                if (data.tokens && data.tokens[0]) {
                    const token = data.tokens[0];
                    const market = token.market;

                    if (market && market.floorAsk && market.floorAsk.price) {
                        const price = market.floorAsk.price.amount.native;
                        const source = market.floorAsk.source?.name || 'OpenSea';
                        listingInfo.innerHTML = `
                            <div class="listing-label">LISTED FOR SALE</div>
                            <div class="listing-price">${price.toFixed(3)} ETH</div>
                            <div class="listing-source">on ${source}</div>
                        `;
                        listingInfo.classList.add('visible');
                    }
                }
            } catch (e) {
                // Listing fetch failed silently
            }
        }

        function setSize(size) {
            currentSize = size;
            const { width, height } = SIZES[size];
            frameContainer.style.width = width + 'px';
            frameContainer.style.height = height + 'px';
        }

        function showStatus(message, type = 'success') {
            statusMessage.textContent = message;
            statusMessage.className = 'status-message visible ' + type;
            setTimeout(() => statusMessage.classList.remove('visible'), 2500);
        }

        function saveFavorite() {
            const favBtn = document.getElementById('saveFavorite');
            const savedNote = document.getElementById('savedNote');
            const exists = favorites.some(f => f.tokenId === currentTokenId);
            if (exists) {
                // Unfavorite
                const idx = favorites.findIndex(f => f.tokenId === currentTokenId);
                favorites.splice(idx, 1);
                localStorage.setItem('cities-favorites', JSON.stringify(favorites));
                updateGallery();
                favBtn.classList.remove('favorited');
                savedNote.classList.remove('visible');
            } else {
                // Add favorite
                favorites.unshift({ id: Date.now(), tokenId: currentTokenId, timestamp: new Date().toISOString() });
                localStorage.setItem('cities-favorites', JSON.stringify(favorites));
                updateGallery();
                favBtn.classList.add('favorited');
                // Show saved note with animated dots
                savedNote.classList.add('visible');
                setTimeout(() => savedNote.classList.remove('visible'), 3000);
            }
            // Update note visibility (only shows for favorited cities)
            updateCityNote();
        }

        function updateFavoriteButton() {
            const favBtn = document.getElementById('saveFavorite');
            const traits = tokenTraits[currentTokenId];

            // Set spot color from palette
            if (traits && traits['Palette']) {
                const paletteInfo = PALETTE_DATA[traits['Palette']];
                if (paletteInfo && paletteInfo.colors && paletteInfo.colors.length > 10) {
                    // Use Spot 1 color (index 10 in the colors array)
                    favBtn.style.setProperty('--spot-color', paletteInfo.colors[10]);
                }
            }

            if (favorites.some(f => f.tokenId === currentTokenId)) {
                favBtn.classList.add('favorited');
            } else {
                favBtn.classList.remove('favorited');
            }
        }

        async function downloadPng() {
            showStatus('CREATING SOCIAL IMAGE...');
            try {
                // Fetch the original image
                const response = await fetch(getPreviewUrl(currentTokenId));
                const blob = await response.blob();

                // Create image element to get dimensions
                const img = new Image();
                img.crossOrigin = 'anonymous';

                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = URL.createObjectURL(blob);
                });

                // Target size: 1080x1920 (9:16 for Stories/X)
                const targetWidth = 1080;
                const targetHeight = 1920;

                // Create canvas
                const canvas = document.createElement('canvas');
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                const ctx = canvas.getContext('2d');

                // Fill with dark background matching the art style
                ctx.fillStyle = '#0A0910';
                ctx.fillRect(0, 0, targetWidth, targetHeight);

                // Calculate art placement - centered with padding
                const padding = 60;
                const availableWidth = targetWidth - (padding * 2);
                const availableHeight = targetHeight - (padding * 2);

                // Scale to fit while maintaining aspect ratio
                const imgRatio = img.width / img.height;
                let drawWidth, drawHeight;

                if (imgRatio > availableWidth / availableHeight) {
                    // Image is wider - fit to width
                    drawWidth = availableWidth;
                    drawHeight = availableWidth / imgRatio;
                } else {
                    // Image is taller - fit to height
                    drawHeight = availableHeight;
                    drawWidth = availableHeight * imgRatio;
                }

                const x = (targetWidth - drawWidth) / 2;
                const y = (targetHeight - drawHeight) / 2;

                // Draw the art
                ctx.drawImage(img, x, y, drawWidth, drawHeight);

                // Convert to JPG and download
                canvas.toBlob((jpgBlob) => {
                    const url = URL.createObjectURL(jpgBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `efdot-diid-${currentTokenId}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    URL.revokeObjectURL(img.src);
                    showStatus('DOWNLOADED FOR STORIES');
                }, 'image/jpeg', 0.95);

            } catch (e) {
                console.error('Download error:', e);
                // Fallback to original PNG
                window.open(getPreviewUrl(currentTokenId), '_blank');
                showStatus('RIGHT-CLICK TO SAVE');
            }
        }

        function shareTwitter() {
            const artBlocksUrl = getTokenPageUrl(currentTokenId);
            const tweetText = encodeURIComponent(`Cities #${currentTokenId} by @efdotstudio x @0xdiid\n\nMint your own City on @artlocker_xyz`);
            window.open(`https://twitter.com/intent/tweet?text=${tweetText}&url=${encodeURIComponent(artBlocksUrl)}`, '_blank', 'width=600,height=400');
            showStatus('OPENING TWITTER');
        }

        function shareInstagram() {
            const caption = `Cities #${currentTokenId}\nby @efdotstudio x @0xdiid\n\nMint: artblocks.io/cities`;
            navigator.clipboard.writeText(caption).then(() => {
                showStatus('CAPTION COPIED');
                setTimeout(() => alert('Caption copied!\n\n1. Download the image first\n2. Open Instagram and create a Story\n3. Add the downloaded image\n4. Paste the caption'), 500);
            }).catch(() => prompt('Copy this caption:', caption));
        }

        function openFrameMockup() {
            const frameMockup = document.getElementById('frameMockup');
            const frameImage = document.getElementById('frameMockupImage');
            frameImage.src = getPreviewUrl(currentTokenId);
            frameMockup.classList.add('open');
        }

        function closeFrameMockup() {
            document.getElementById('frameMockup').classList.remove('open');
        }

        async function downloadFramedImage() {
            const frameImage = document.getElementById('frameMockupImage');

            // Wait for image to be loaded
            if (!frameImage.complete) {
                showStatus('LOADING...');
                await new Promise(resolve => frameImage.onload = resolve);
            }

            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // 4:5 aspect ratio canvas (like Instagram portrait)
                const canvasWidth = 1600;
                const canvasHeight = 2000;
                canvas.width = canvasWidth;
                canvas.height = canvasHeight;

                // Light gray/white background
                ctx.fillStyle = '#f5f5f5';
                ctx.fillRect(0, 0, canvasWidth, canvasHeight);

                // Load the image
                const img = new Image();
                img.crossOrigin = 'anonymous';

                await new Promise((resolve, reject) => {
                    img.onload = resolve;
                    img.onerror = reject;
                    img.src = frameImage.src;
                });

                // Calculate framed image size to fit nicely in 4:5 with margins
                const imgAspect = img.naturalWidth / img.naturalHeight;
                const maxFrameWidth = canvasWidth * 0.7;
                const maxFrameHeight = canvasHeight * 0.75;

                let frameWidth, frameHeight;
                if (imgAspect > maxFrameWidth / maxFrameHeight) {
                    frameWidth = maxFrameWidth;
                    frameHeight = frameWidth / imgAspect;
                } else {
                    frameHeight = maxFrameHeight;
                    frameWidth = frameHeight * imgAspect;
                }

                // Frame dimensions
                const frameThickness = 24;
                const matThickness = 8;
                const totalFrameWidth = frameWidth + (frameThickness + matThickness) * 2;
                const totalFrameHeight = frameHeight + (frameThickness + matThickness) * 2;

                // Center the frame
                const frameX = (canvasWidth - totalFrameWidth) / 2;
                const frameY = (canvasHeight - totalFrameHeight) / 2;

                // Draw shadow
                ctx.shadowColor = 'rgba(0, 0, 0, 0.25)';
                ctx.shadowBlur = 40;
                ctx.shadowOffsetX = 8;
                ctx.shadowOffsetY = 12;

                // Draw outer frame (white/light frame)
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(frameX, frameY, totalFrameWidth, totalFrameHeight);

                // Reset shadow
                ctx.shadowColor = 'transparent';
                ctx.shadowBlur = 0;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 0;

                // Draw inner mat/border (slight gray)
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(
                    frameX + frameThickness,
                    frameY + frameThickness,
                    totalFrameWidth - frameThickness * 2,
                    totalFrameHeight - frameThickness * 2
                );

                // Draw the artwork
                ctx.drawImage(img,
                    frameX + frameThickness + matThickness,
                    frameY + frameThickness + matThickness,
                    frameWidth, frameHeight);

                // Download
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `efdot-diid-cities-${currentTokenId}-framed.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showStatus('FRAMED IMAGE SAVED');
                }, 'image/jpeg', 0.95);

            } catch (e) {
                console.error('Frame download error:', e);
                showStatus('DOWNLOAD FAILED');
            }
        }

        document.getElementById('downloadFramed').addEventListener('click', (e) => {
            e.stopPropagation();
            downloadFramedImage();
        });

        // Close frame mockup when clicking outside the frame
        document.getElementById('frameMockup').addEventListener('click', (e) => {
            if (e.target.id === 'frameMockup' || e.target.classList.contains('frame-mockup-content')) {
                closeFrameMockup();
            }
        });

        function randomFiltered() {
            const matches = getFilteredTokens();
            if (matches.length === 0) { showStatus('NO MATCHES', 'error'); return; }
            const randomToken = matches[Math.floor(Math.random() * matches.length)];
            tokenIdInput.value = randomToken;
            loadOutput(randomToken);
            showStatus(`#${randomToken}`);
        }

        function copyLink() {
            const url = `${window.location.origin}${window.location.pathname}?token=${currentTokenId}`;
            navigator.clipboard.writeText(url).then(() => showStatus('LINK COPIED')).catch(() => {
                prompt('Copy this link:', url);
            });
        }

        function toggleFullscreen() {
            isFullscreen = !isFullscreen;
            document.body.classList.toggle('fullscreen-mode', isFullscreen);
            // Handle image loading state for smooth fullscreen transition
            if (isFullscreen) {
                // If image is already loaded, show it after a brief delay for smooth transition
                if (previewImage.complete && previewImage.naturalHeight !== 0) {
                    setTimeout(() => previewImage.classList.add('loaded'), 100);
                } else {
                    previewImage.classList.remove('loaded');
                }
            } else {
                previewImage.classList.remove('loaded');
            }
        }

        let exploreTimeout = null;
        let exploreActive = false;
        let isFirstExplore = true;
        const EXPLORE_DELAY_FIRST = 12000; // 12 seconds for first output (after load)
        const EXPLORE_DELAY = 8000; // 8 seconds between subsequent cities

        function exploreNext() {
            if (!exploreActive) return;
            const randomToken = getPreloadedToken();
            tokenIdInput.value = randomToken;
            loadOutput(randomToken);
            isFirstExplore = false;
        }

        function scheduleNextExplore() {
            if (!exploreActive) return;
            const delay = isFirstExplore ? EXPLORE_DELAY_FIRST : EXPLORE_DELAY;
            exploreTimeout = setTimeout(exploreNext, delay);
        }

        // Hook into image load to trigger next explore only after image is ready
        previewImage.addEventListener('load', () => {
            if (exploreActive) {
                // Reset and restart the progress bar animation
                const progressBar = document.querySelector('.explore-progress');
                if (progressBar) {
                    const duration = isFirstExplore ? 12 : 8;
                    progressBar.style.animation = 'none';
                    progressBar.offsetHeight; // Force reflow
                    progressBar.style.animation = `exploreCountdown ${duration}s linear forwards`;
                }
                // Wait a moment after image loads before scheduling next
                setTimeout(() => scheduleNextExplore(), 500);
            }
        });

        function stopExplore() {
            if (!exploreActive) return;
            const btn = document.getElementById('exploreRandom');
            exploreActive = false;
            isFirstExplore = true; // Reset for next time
            document.body.classList.remove('explore-active');
            if (exploreTimeout) { clearTimeout(exploreTimeout); exploreTimeout = null; }
            if (exploreInterval) { clearInterval(exploreInterval); exploreInterval = null; }
            btn.classList.remove('active');
            btn.textContent = 'FULLSCREEN';
        }

        function toggleExploreRandom() {
            const btn = document.getElementById('exploreRandom');
            if (exploreActive) {
                stopExplore();
                // Exit fullscreen when stopping
                if (isFullscreen) {
                    isFullscreen = false;
                    document.body.classList.remove('fullscreen-mode');
                    previewImage.classList.remove('loaded');
                }
                showStatus('SHUFFLE STOPPED');
            } else {
                exploreActive = true;
                document.body.classList.add('explore-active');
                btn.classList.add('active', 'shuffling');
                btn.textContent = 'STOP';
                // Remove animation class after it plays
                setTimeout(() => btn.classList.remove('shuffling'), 500);

                // Preload images first
                preloadRandomImages();

                // Wait for current image to be ready, then enter fullscreen
                const enterFullscreen = () => {
                    if (!isFullscreen) {
                        isFullscreen = true;
                        document.body.classList.add('fullscreen-mode');
                        // Show image after fullscreen transition
                        if (previewImage.complete && previewImage.naturalHeight !== 0) {
                            setTimeout(() => previewImage.classList.add('loaded'), 150);
                        }
                    }
                    showStatus('FULLSCREEN');
                    scheduleNextExplore();
                };

                // If image is already loaded, enter fullscreen after brief delay
                if (previewImage.complete && previewImage.naturalHeight !== 0) {
                    setTimeout(enterFullscreen, 300);
                } else {
                    // Wait for image to load first
                    const onLoad = () => {
                        previewImage.removeEventListener('load', onLoad);
                        setTimeout(enterFullscreen, 300);
                    };
                    previewImage.addEventListener('load', onLoad);
                }
            }
        }

        // Explore fullscreen button - in fullscreen mode, exit to single view
        document.getElementById('exploreFullscreenBtn').addEventListener('click', (e) => {
            // Always prevent click from bubbling to frameContainer (which opens Art Blocks link)
            e.preventDefault();
            e.stopPropagation();

            // If in fullscreen explore mode, exit completely back to single view
            if (isFullscreen && exploreActive) {
                stopExplore();
                isFullscreen = false;
                document.body.classList.remove('fullscreen-mode');
                document.getElementById('exploreFullscreenBtn').title = 'Enter Fullscreen';
                showStatus('EXIT');
                return;
            }
            // Normal toggle behavior when not in explore mode
            isFullscreen = !isFullscreen;
            document.body.classList.toggle('fullscreen-mode', isFullscreen);
            document.getElementById('exploreFullscreenBtn').textContent = isFullscreen ? '' : '';
            document.getElementById('exploreFullscreenBtn').title = isFullscreen ? 'Exit Fullscreen' : 'Enter Fullscreen';
        });

        // Exit fullscreen on tap (for mobile) - clicking the hint or the image
        document.getElementById('fullscreenExitHint').addEventListener('click', () => {
            if (isFullscreen) {
                if (exploreActive) stopExplore();
                isFullscreen = false;
                document.body.classList.remove('fullscreen-mode');
            }
        });

        // Fullscreen swipe navigation for mobile
        let fullscreenTouchStartX = 0;
        let fullscreenTouchStartY = 0;
        let fullscreenTouchStartTime = 0;
        let fullscreenSwiped = false;

        previewImage.addEventListener('touchstart', (e) => {
            if (isFullscreen) {
                fullscreenTouchStartX = e.changedTouches[0].screenX;
                fullscreenTouchStartY = e.changedTouches[0].screenY;
                fullscreenTouchStartTime = Date.now();
                fullscreenSwiped = false;
            }
        }, { passive: true });

        previewImage.addEventListener('touchend', (e) => {
            if (isFullscreen) {
                const touchEndX = e.changedTouches[0].screenX;
                const touchEndY = e.changedTouches[0].screenY;
                const diffX = fullscreenTouchStartX - touchEndX;
                const diffY = fullscreenTouchStartY - touchEndY;
                const touchDuration = Date.now() - fullscreenTouchStartTime;
                const swipeThreshold = 50;

                // Check if horizontal swipe (more horizontal than vertical movement)
                if (Math.abs(diffX) > swipeThreshold && Math.abs(diffX) > Math.abs(diffY)) {
                    fullscreenSwiped = true;
                    if (diffX > 0) {
                        // Swipe left - next
                        document.getElementById('nextToken').click();
                    } else {
                        // Swipe right - previous
                        document.getElementById('prevToken').click();
                    }
                }
            }
        }, { passive: true });

        // Also exit fullscreen when tapping the image (not swiping)
        previewImage.addEventListener('click', (e) => {
            if (isFullscreen && !fullscreenSwiped) {
                e.preventDefault();
                e.stopPropagation();
                if (exploreActive) stopExplore();
                isFullscreen = false;
                document.body.classList.remove('fullscreen-mode');
            }
            fullscreenSwiped = false;
        });

        // More outputs feature - curated suggestions based on color relationships
        function getColorBrightness(hex) {
            if (!hex || hex.length < 7) return 128;
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return (r * 299 + g * 587 + b * 114) / 1000;
        }

        function getColorSaturation(hex) {
            if (!hex || hex.length < 7) return 0;
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            return max === 0 ? 0 : (max - min) / max;
        }

        function updateSimilarOutputs() {
            const grid = document.getElementById('similarOutputsGrid');
            const traits = tokenTraits[currentTokenId];
            if (!traits) { grid.innerHTML = ''; return; }

            const currentPalette = traits['Palette'];
            const currentBg = PALETTE_DATA[currentPalette]?.bg || '#000000';
            const currentBrightness = getColorBrightness(currentBg);
            const currentSaturation = getColorSaturation(currentBg);

            // Categorize all outputs
            const sameBg = [], darker = [], lighter = [], wildcards = [];

            for (let i = 0; i <= MAX_TOKEN; i++) {
                if (i === currentTokenId) continue;
                const t = tokenTraits[i];
                if (!t) continue;

                const palette = t['Palette'];
                const bg = PALETTE_DATA[palette]?.bg || '#000000';
                const brightness = getColorBrightness(bg);
                const saturation = getColorSaturation(bg);
                const traffic = t['Traffic'];

                // Weight for rare high-traffic outputs
                const weight = traffic === 'Rush Hour' ? 3 : (traffic === 'Heavy' ? 2 : 1);
                const entry = { id: i, weight, brightness, saturation, palette };

                // Same background color
                if (bg.toLowerCase() === currentBg.toLowerCase()) {
                    sameBg.push(entry);
                }
                // Darker/more saturated
                else if (brightness < currentBrightness - 20 || saturation > currentSaturation + 0.15) {
                    darker.push(entry);
                }
                // Lighter/less saturated
                else if (brightness > currentBrightness + 20 || saturation < currentSaturation - 0.15) {
                    lighter.push(entry);
                }
                // Everything else is wildcard
                else {
                    wildcards.push(entry);
                }
            }

            // Weighted random selection helper
            function weightedPick(arr) {
                if (arr.length === 0) return null;
                const totalWeight = arr.reduce((sum, item) => sum + item.weight, 0);
                let random = Math.random() * totalWeight;
                for (const item of arr) {
                    random -= item.weight;
                    if (random <= 0) return item;
                }
                return arr[arr.length - 1];
            }

            // Pick one from each category
            const picks = [];
            const sameBgPick = weightedPick(sameBg);
            const darkerPick = weightedPick(darker);
            const lighterPick = weightedPick(lighter);
            const wildcardPick = weightedPick(wildcards);

            if (sameBgPick) picks.push(sameBgPick);
            if (darkerPick) picks.push(darkerPick);
            if (lighterPick) picks.push(lighterPick);
            if (wildcardPick) picks.push(wildcardPick);

            // Fill remaining slots if we don't have 4
            const allOutputs = [...sameBg, ...darker, ...lighter, ...wildcards];
            while (picks.length < 4 && allOutputs.length > picks.length) {
                const pick = weightedPick(allOutputs.filter(o => !picks.find(p => p.id === o.id)));
                if (pick) picks.push(pick);
                else break;
            }

            grid.innerHTML = picks.map(s => `
                <div class="similar-output" data-token="${s.id}" title="Output #${s.id}">
                    <img src="${getSmallThumbnailUrl(s.id)}" alt="Output ${s.id}" loading="eager">
                    <div class="similar-output-id">#${s.id}</div>
                </div>
            `).join('');

            grid.querySelectorAll('.similar-output').forEach(el => {
                el.addEventListener('click', () => loadOutput(parseInt(el.dataset.token), true));
            });
        }

        // Favorite palettes
        let favoritePalettes = JSON.parse(localStorage.getItem('cities-fav-palettes') || '[]');
        // Debug: add a test palette if none exist
        if (favoritePalettes.length === 0) {
            favoritePalettes = ['Beach Day', 'Autumnal'];
            console.log('Added test palettes:', favoritePalettes);
        }

        function toggleFavoritePalette(palette) {
            console.log('toggleFavoritePalette called with:', palette);
            const idx = favoritePalettes.indexOf(palette);
            if (idx > -1) {
                favoritePalettes.splice(idx, 1);
                console.log('Removed palette, now:', favoritePalettes);
            } else {
                favoritePalettes.push(palette);
                console.log('Added palette, now:', favoritePalettes);
            }
            localStorage.setItem('cities-fav-palettes', JSON.stringify(favoritePalettes));
            updateGallery(); // Update the favorites panel
        }

        function isPaletteFavorited(palette) {
            return favoritePalettes.includes(palette);
        }

        // Check if a city is favorited
        function isCityFavorited(tokenId) {
            return favorites.some(f => f.tokenId === tokenId);
        }

        // Toggle favorite for a city (from grid)
        function toggleCityFavorite(tokenId, e) {
            if (e) e.stopPropagation();
            const exists = favorites.some(f => f.tokenId === tokenId);
            if (exists) {
                const idx = favorites.findIndex(f => f.tokenId === tokenId);
                favorites.splice(idx, 1);
                showStatus(`REMOVED #${tokenId}`);
            } else {
                favorites.unshift({ id: Date.now(), tokenId: tokenId, timestamp: new Date().toISOString() });
                showStatus(`SAVED #${tokenId}`);
            }
            localStorage.setItem('cities-favorites', JSON.stringify(favorites));
            updateGallery();
            // Update button state if in grid
            const btn = document.querySelector(`.grid-item[data-token="${tokenId}"] .grid-item-fav`);
            if (btn) btn.classList.toggle('favorited', isCityFavorited(tokenId));
            // Update note visibility if this is the current city
            if (tokenId === currentTokenId) {
                updateCityNote();
                updateFavoriteButton();
            }
        }

        // City notes - only visible for favorited cities
        function getCityNote(tokenId) {
            const fav = favorites.find(f => f.tokenId === tokenId);
            return fav?.note || '';
        }

        // Save note for already-favorited city
        function saveCityNote(tokenId, note) {
            const existingIdx = favorites.findIndex(f => f.tokenId === tokenId);
            if (existingIdx < 0) return; // Only save notes for favorited cities

            favorites[existingIdx].note = note;
            localStorage.setItem('cities-favorites', JSON.stringify(favorites));

            const noteContainer = document.getElementById('cityNote');
            noteContainer.classList.toggle('has-note', !!note.trim());
        }

        function updateCityNote() {
            const noteInput = document.getElementById('cityNoteInput');
            const noteContainer = document.getElementById('cityNote');
            const isFav = isCityFavorited(currentTokenId);

            // Only show note input for favorited cities
            noteContainer.classList.toggle('visible', isFav);

            if (isFav) {
                const note = getCityNote(currentTokenId);
                noteInput.value = note;
                noteContainer.classList.toggle('has-note', !!note);
            } else {
                noteInput.value = '';
                noteContainer.classList.remove('has-note');
            }
        }

        // Debounce for auto-save - longer delay to avoid issues
        let noteDebounceTimer = null;
        document.getElementById('cityNoteInput').addEventListener('input', (e) => {
            clearTimeout(noteDebounceTimer);
            noteDebounceTimer = setTimeout(() => {
                saveCityNote(currentTokenId, e.target.value);
            }, 1500);
        });

        // Save on blur
        document.getElementById('cityNoteInput').addEventListener('blur', (e) => {
            clearTimeout(noteDebounceTimer);
            saveCityNote(currentTokenId, e.target.value);
        });

        // Filters toggle
        document.getElementById('filtersToggle').addEventListener('click', () => {
            document.getElementById('filtersSection').classList.toggle('collapsed');
        });

        // Metadata toggle - toggles open/close
        document.getElementById('metadataToggle').addEventListener('click', () => {
            const section = document.getElementById('metadataSection');
            section.classList.toggle('collapsed');
        });

        function updateBackgroundColors(passedTraits) {
            const traits = passedTraits || tokenTraits[currentTokenId];
            if (!traits) { console.log('No traits found for token', currentTokenId); return; }
            const palette = traits['Palette'];
            if (!palette) { console.log('No Palette trait found'); return; }
            const paletteInfo = PALETTE_DATA[palette];
            if (!paletteInfo) { console.log('Palette not found in PALETTE_DATA:', palette); return; }

            const bubble1 = document.querySelector('.bubble-1');
            const bubble2 = document.querySelector('.bubble-2');
            const bubble3 = document.querySelector('.bubble-3');

            if (bubble1 && paletteInfo.colors[0]) bubble1.style.background = paletteInfo.colors[0];
            if (bubble2 && paletteInfo.colors[1]) bubble2.style.background = paletteInfo.colors[1];
            if (bubble3 && paletteInfo.colors[2]) bubble3.style.background = paletteInfo.colors[2];
        }

        // Preload cache for explore mode
        let preloadedImages = [];
        const PRELOAD_COUNT = 8;

        function preloadAdjacentImages() {
            const matches = getFilteredTokens();
            const currentIndex = matches.indexOf(currentTokenId);
            const prevToken = currentIndex > 0 ? matches[currentIndex - 1] : matches[matches.length - 1];
            const nextToken = currentIndex < matches.length - 1 ? matches[currentIndex + 1] : matches[0];
            [prevToken, nextToken].forEach(tokenId => {
                const img = new Image();
                img.src = getPreviewUrl(tokenId);
            });
        }

        // Curated fullscreen journey - dark to light with deviation, mix of rare and common
        let curatedSequence = [];
        let curatedIndex = 0;

        function buildCuratedSequence() {
            // Group tokens by time of day (dark to light journey)
            const timeOrder = ['Night', 'Dusk', 'Dawn', 'Day'];
            const byTime = { 'Night': [], 'Dusk': [], 'Dawn': [], 'Day': [] };

            Object.entries(tokenTraits).forEach(([id, traits]) => {
                const time = traits['Time of Day'] || 'Day';
                if (byTime[time]) byTime[time].push(parseInt(id));
            });

            // Build sequence: mostly dark-to-light but with some back-and-forth
            const sequence = [];
            const totalCities = 30; // Show about 30 cities in a full journey

            // Weights for each phase (more night at start, more day at end)
            const phases = [
                { weights: [0.6, 0.3, 0.1, 0], count: 6 },    // Start: mostly night
                { weights: [0.4, 0.4, 0.2, 0], count: 5 },    // Transition
                { weights: [0.2, 0.4, 0.3, 0.1], count: 5 },  // Dusk heavy
                { weights: [0.1, 0.3, 0.4, 0.2], count: 5 },  // Dawn emerging
                { weights: [0, 0.2, 0.4, 0.4], count: 5 },    // Light increasing
                { weights: [0, 0.1, 0.3, 0.6], count: 4 },    // End: mostly day
            ];

            phases.forEach(phase => {
                for (let i = 0; i < phase.count; i++) {
                    // Pick time based on weights
                    const rand = Math.random();
                    let cumulative = 0;
                    let selectedTime = 'Day';
                    for (let t = 0; t < timeOrder.length; t++) {
                        cumulative += phase.weights[t];
                        if (rand < cumulative) {
                            selectedTime = timeOrder[t];
                            break;
                        }
                    }

                    const pool = byTime[selectedTime];
                    if (pool && pool.length > 0) {
                        // Pick random from pool, avoid recent duplicates
                        let token;
                        let attempts = 0;
                        do {
                            token = pool[Math.floor(Math.random() * pool.length)];
                            attempts++;
                        } while (sequence.slice(-5).includes(token) && attempts < 10);
                        sequence.push(token);
                    }
                }
            });

            // Shuffle slightly to add natural deviation (swap some adjacent pairs)
            for (let i = 0; i < sequence.length - 1; i++) {
                if (Math.random() < 0.2) { // 20% chance to swap
                    [sequence[i], sequence[i + 1]] = [sequence[i + 1], sequence[i]];
                }
            }

            return sequence;
        }

        function preloadRandomImages() {
            // If user has favorites, show those first (shuffled), then fall back to curated
            const favs = JSON.parse(localStorage.getItem('cities-favorites') || '[]');

            if (favs.length >= 5) {
                // Enough favorites - shuffle and show them
                curatedSequence = [...favs].sort(() => Math.random() - 0.5);
            } else if (favs.length > 0) {
                // Some favorites - mix them into the curated sequence
                const curated = buildCuratedSequence();
                // Insert favorites at intervals throughout the curated sequence
                curatedSequence = [];
                const interval = Math.floor(curated.length / (favs.length + 1));
                let favIndex = 0;
                curated.forEach((token, i) => {
                    if (favIndex < favs.length && i > 0 && i % interval === 0) {
                        curatedSequence.push(favs[favIndex]);
                        favIndex++;
                    }
                    curatedSequence.push(token);
                });
            } else {
                // No favorites - use curated dark-to-light journey
                curatedSequence = buildCuratedSequence();
            }

            curatedIndex = 0;

            // Preload first several images
            preloadedImages = [];
            for (let i = 0; i < Math.min(PRELOAD_COUNT, curatedSequence.length); i++) {
                const token = curatedSequence[i];
                const img = new Image();
                img.src = getPreviewUrl(token);
                preloadedImages.push({ tokenId: token, img });
            }
        }

        function getPreloadedToken() {
            if (curatedSequence.length > 0 && curatedIndex < curatedSequence.length) {
                const token = curatedSequence[curatedIndex];
                curatedIndex++;

                // Preload upcoming image
                if (curatedIndex + PRELOAD_COUNT < curatedSequence.length) {
                    const futureToken = curatedSequence[curatedIndex + PRELOAD_COUNT - 1];
                    const img = new Image();
                    img.src = getPreviewUrl(futureToken);
                }

                // Loop back to start if we reach the end
                if (curatedIndex >= curatedSequence.length) {
                    curatedSequence = buildCuratedSequence();
                    curatedIndex = 0;
                }

                return token;
            }

            // Fallback to random
            const matches = getFilteredTokens();
            return matches[Math.floor(Math.random() * matches.length)];
        }

        function saveLastViewed() {
            localStorage.setItem('cities-last-viewed', currentTokenId.toString());
        }

        function getLastViewed() {
            return parseInt(localStorage.getItem('cities-last-viewed')) || 0;
        }

        function handleSwipe() {
            const swipeThreshold = 50;
            const diff = touchStartX - touchEndX;
            if (Math.abs(diff) > swipeThreshold) {
                if (diff > 0) {
                    document.getElementById('nextToken').click();
                } else {
                    document.getElementById('prevToken').click();
                }
            }
        }

        function clearFilters() {
            filterTime.value = ''; filterPalette.value = ''; filterBounds.value = '';
            filterTraffic.value = ''; filterLine.value = ''; filterRender.value = '';
            filterZoom.value = ''; filterWater.value = '';
            updateMatchCount();
            showStatus('CLEARED');
        }

        function updateGallery() {
            const palettesSection = document.getElementById('favPalettesSection');
            const palettesGrid = document.getElementById('favPalettesGrid');

            console.log('updateGallery - favoritePalettes:', favoritePalettes, 'palettesSection:', palettesSection);

            // Update total count (cities + palettes)
            const totalFavs = favorites.length + favoritePalettes.length;
            favCount.textContent = totalFavs;

            // Render favorited palettes
            if (favoritePalettes.length > 0) {
                console.log('Rendering', favoritePalettes.length, 'favorite palettes');
                palettesSection.style.display = 'block';
                palettesGrid.innerHTML = favoritePalettes.map(palette => {
                    const paletteInfo = PALETTE_DATA[palette];
                    const bgColor = paletteInfo?.bg || '#333';
                    // Count cities in this palette
                    const paletteTokens = Object.keys(tokenTraits).filter(id => tokenTraits[id]?.Palette === palette);
                    return `<div class="fav-palette-item" data-palette="${palette}">
                        <div class="fav-palette-swatch" style="background: ${bgColor};"></div>
                        <div>
                            <div class="fav-palette-name">${palette}</div>
                            <div class="fav-palette-count">${paletteTokens.length} cities</div>
                        </div>
                        <button class="fav-palette-remove" data-palette="${palette}" title="Remove palette"></button>
                    </div>`;
                }).join('');

                // Add click handlers - jump to palette in grid view
                palettesGrid.querySelectorAll('.fav-palette-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (e.target.closest('.fav-palette-remove')) return;
                        const palette = item.dataset.palette;
                        galleryPanel.classList.remove('open');
                        jumpToPalette(palette);
                    });
                });
                palettesGrid.querySelectorAll('.fav-palette-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const palette = btn.dataset.palette;
                        toggleFavoritePalette(palette);
                        updateGallery();
                        renderGrid(); // Update grid hearts
                    });
                });
            } else {
                palettesSection.style.display = 'none';
            }

            // Render favorited cities
            if (favorites.length === 0 && favoritePalettes.length === 0) {
                galleryGrid.innerHTML = '<div class="empty-gallery">NO FAVORITES YET<br>CLICK  ON CITIES OR PALETTES</div>';
            } else if (favorites.length === 0) {
                galleryGrid.innerHTML = '<div class="empty-gallery" style="padding: 30px 20px;">NO INDIVIDUAL CITIES YET<br>PRESS S TO SAVE CURRENT CITY</div>';
            } else {
                galleryGrid.innerHTML = favorites.map((fav, i) => {
                    const thumbUrl = getThumbnailUrl(fav.tokenId);
                    const fullUrl = getPreviewUrl(fav.tokenId);
                    return `<div class="gallery-item"><div class="item-info"><img src="${thumbUrl}" alt="City #${fav.tokenId}" loading="eager" onerror="this.src='${fullUrl}'" style="width:100%;height:100%;object-fit:cover;"><span class="gallery-item-id">#${fav.tokenId}</span></div><div class="item-actions"><button class="load-btn" onclick="loadFavorite(${i})">LOAD</button><button class="delete-btn" onclick="deleteFavorite(${i})">REMOVE</button></div></div>`;
                }).join('');
            }
        }

        window.loadFavorite = function(i) { const fav = favorites[i]; tokenIdInput.value = fav.tokenId; loadOutput(fav.tokenId); galleryPanel.classList.remove('open'); };
        window.deleteFavorite = function(i) { favorites.splice(i, 1); localStorage.setItem('cities-favorites', JSON.stringify(favorites)); updateGallery(); showStatus('REMOVED'); };

        // Enter key on token input loads the city
        tokenIdInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loadOutput(parseInt(tokenIdInput.value) || 0);
            }
        });
        document.getElementById('saveFavorite').addEventListener('click', saveFavorite);
        document.getElementById('downloadPng').addEventListener('click', downloadPng);
        document.getElementById('shareTwitter').addEventListener('click', shareTwitter);
        document.getElementById('frameViewBtn').addEventListener('click', openFrameMockup);
        document.getElementById('closeFrameMockup').addEventListener('click', closeFrameMockup);
        document.getElementById('clearFilters').addEventListener('click', clearFilters);
        document.getElementById('randomFiltered').addEventListener('click', randomFiltered);
        document.getElementById('copyLink').addEventListener('click', copyLink);
        document.getElementById('exploreRandom').addEventListener('click', toggleExploreRandom);

        document.getElementById('prevToken').addEventListener('click', () => {
            const matches = getFilteredTokens();
            const currentIndex = matches.indexOf(parseInt(tokenIdInput.value) || 0);
            let newToken = currentIndex > 0 ? matches[currentIndex - 1] : matches[matches.length - 1];
            tokenIdInput.value = newToken; loadOutput(newToken);
        });

        document.getElementById('nextToken').addEventListener('click', () => {
            const matches = getFilteredTokens();
            const currentIndex = matches.indexOf(parseInt(tokenIdInput.value) || 0);
            let newToken = currentIndex >= 0 && currentIndex < matches.length - 1 ? matches[currentIndex + 1] : matches[0];
            tokenIdInput.value = newToken; loadOutput(newToken);
        });

        function openCollectorsPanel() {
            collectorsPanel.classList.add('open');
            galleryPanel.classList.remove('open');
            document.body.classList.add('collectors-open');
        }
        function closeCollectorsPanel() {
            collectorsPanel.classList.remove('open');
            document.body.classList.remove('collectors-open');
        }
        function toggleCollectorsPanel() {
            if (collectorsPanel.classList.contains('open')) {
                closeCollectorsPanel();
            } else {
                openCollectorsPanel();
            }
        }

        document.getElementById('toggleGallery').addEventListener('click', () => { galleryPanel.classList.toggle('open'); closeCollectorsPanel(); updateGallery(); });
        document.getElementById('closeGallery').addEventListener('click', () => galleryPanel.classList.remove('open'));
        document.getElementById('toggleCollectors').addEventListener('click', toggleCollectorsPanel);
        document.getElementById('sidebarCollectorsBtn').addEventListener('click', toggleCollectorsPanel);
        document.getElementById('closeCollectors').addEventListener('click', closeCollectorsPanel);
        document.getElementById('collectorsTitle').addEventListener('click', closeCollectorsPanel);

        // Swipe/drag to close panels
        function setupPanelSwipe(panel, direction = 'right') {
            let startX = 0, startY = 0, currentX = 0, isDragging = false;
            const threshold = 100;

            panel.addEventListener('touchstart', (e) => {
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isDragging = true;
                panel.classList.add('dragging');
            }, { passive: true });

            panel.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diffX = currentX - startX;
                const diffY = Math.abs(e.touches[0].clientY - startY);
                // Only allow horizontal swipe
                if (diffY > 50) { isDragging = false; return; }
                if (direction === 'right' && diffX > 0) {
                    panel.style.transform = `translateX(${diffX}px)`;
                }
            }, { passive: true });

            panel.addEventListener('touchend', () => {
                panel.classList.remove('dragging');
                const diffX = currentX - startX;
                if (direction === 'right' && diffX > threshold) {
                    panel.classList.remove('open');
                }
                panel.style.transform = '';
                isDragging = false;
            });

            // Desktop drag from edge
            let mouseStartX = 0, mouseIsDragging = false;
            panel.addEventListener('mousedown', (e) => {
                if (e.offsetX > 20) return; // Only trigger near left edge
                mouseStartX = e.clientX;
                mouseIsDragging = true;
                panel.classList.add('dragging');
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!mouseIsDragging) return;
                const diffX = e.clientX - mouseStartX;
                if (direction === 'right' && diffX > 0) {
                    panel.style.transform = `translateX(${diffX}px)`;
                }
            });

            document.addEventListener('mouseup', () => {
                if (!mouseIsDragging) return;
                panel.classList.remove('dragging');
                const rect = panel.getBoundingClientRect();
                const shouldClose = rect.left > window.innerWidth - 200;
                if (shouldClose) {
                    // Close first, then reset transform after transition
                    panel.classList.remove('open');
                    setTimeout(() => { panel.style.transform = ''; }, 350);
                } else {
                    panel.style.transform = '';
                }
                mouseIsDragging = false;
            });
        }

        setupPanelSwipe(collectorsPanel, 'right');
        setupPanelSwipe(galleryPanel, 'right');

        [filterTime, filterPalette, filterBounds, filterTraffic, filterLine, filterRender, filterZoom, filterWater].forEach(filter => filter.addEventListener('change', () => {
            updateMatchCount();
            // Auto-pause explore when a filter is applied
            if (filter.value) stopExplore();
        }));

        document.getElementById('toggleShortcuts').addEventListener('click', () => {
            const hints = document.getElementById('keyboardHints');
            hints.style.display = hints.style.display === 'none' ? 'block' : 'none';
        });

        // Palette inspector
        function getContrastColor(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#000000' : '#ffffff';
        }

        function openPaletteInspector() {
            const traits = tokenTraits[currentTokenId];
            if (!traits) return;
            const paletteName = traits['Palette'];
            const paletteInfo = PALETTE_DATA[paletteName];
            if (!paletteInfo) return;

            const inspector = document.getElementById('paletteInspector');
            const nameEl = document.getElementById('paletteInspectorName');
            const colorsEl = document.getElementById('paletteInspectorColors');

            // Create colorful name with each letter using only bright palette colors
            // Filter out dark colors - only use colors with high brightness
            function isBrightColor(hex) {
                const r = parseInt(hex.slice(1, 3), 16);
                const g = parseInt(hex.slice(3, 5), 16);
                const b = parseInt(hex.slice(5, 7), 16);
                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                return brightness > 120; // Only colors brighter than this threshold
            }
            const brightColors = paletteInfo.colors.filter(c => isBrightColor(c));
            // If no bright colors, fall back to spot colors or use white
            const titleColors = brightColors.length > 0 ? brightColors : ['#fff', '#00E5CC', '#FF2D92', '#FFE135'];
            const letters = paletteName.toUpperCase().split('');
            nameEl.innerHTML = letters.map((letter, i) => {
                const color = titleColors[i % titleColors.length];
                return `<span style="color: ${color}; text-shadow: 0 2px 10px ${color}40;">${letter}</span>`;
            }).join('');

            // Show palette metadata (time, energy, hour)
            const meta = PALETTE_META[paletteName];
            const metaEl = document.getElementById('paletteInspectorMeta');
            if (meta) {
                metaEl.innerHTML = `
                    <div class="palette-meta-item">TIME<span>${meta.time}</span></div>
                    <div class="palette-meta-item">ENERGY<span>${meta.energy}</span></div>
                    <div class="palette-meta-item">HOUR<span>${meta.hour}</span></div>
                `;
            } else {
                metaEl.innerHTML = '';
            }

            // Segment colors by type
            // Colors array: [Grid1, Grid2, Bold1-4, Subtle1-4, Spot1-2]
            const colors = paletteInfo.colors;
            const bgColor = paletteInfo.bg;
            const gridColors = colors.slice(0, 2);
            const boldColors = colors.slice(2, 6);
            const subtleColors = colors.slice(6, 10);
            const spotColors = colors.slice(10, 12);

            function renderColorChip(color, extraClass = '') {
                const textColor = getContrastColor(color);
                return `<div class="palette-color-chip ${extraClass}" style="background: ${color}; color: ${textColor};" data-hex="${color.toUpperCase()}">${color.toUpperCase()}</div>`;
            }

            function renderSection(label, colorArr) {
                if (!colorArr || colorArr.length === 0) return '';
                return `
                    <div class="palette-color-section">
                        <div class="palette-color-section-label">${label}</div>
                        <div class="palette-color-row">${colorArr.map(c => renderColorChip(c)).join('')}</div>
                    </div>
                `;
            }

            colorsEl.innerHTML = `
                <div class="palette-color-section">
                    <div class="palette-color-section-label">BACKGROUND</div>
                    <div class="palette-color-row">${renderColorChip(bgColor, 'bg-chip')}</div>
                </div>
                ${renderSection('GRID', gridColors)}
                ${renderSection('BOLD', boldColors)}
                ${renderSection('SUBTLE', subtleColors)}
                ${renderSection('SPOT', spotColors)}
            `;

            // Add click to toggle expanded state
            colorsEl.querySelectorAll('.palette-color-chip:not(.bg-chip)').forEach(chip => {
                chip.addEventListener('click', () => chip.classList.toggle('expanded'));
            });

            // Populate hex codes section
            const hexEl = document.getElementById('paletteInspectorHex');
            const allColors = [bgColor, ...colors];
            hexEl.innerHTML = allColors.map(c => `<span>${c.toUpperCase()}</span>`).join('');

            // Wire up hex toggle
            const hexToggle = document.getElementById('showHexCodes');
            hexToggle.checked = false;
            hexEl.classList.remove('visible');
            hexToggle.onchange = () => hexEl.classList.toggle('visible', hexToggle.checked);

            // Find similar palettes (by shared colors or similar time of day)
            const similarEl = document.getElementById('paletteInspectorSimilar');
            const currentColors = new Set([bgColor, ...colors]);
            const similarPalettes = [];

            Object.entries(PALETTE_DATA).forEach(([name, info]) => {
                if (name === paletteName) return;
                const otherColors = [info.bg, ...info.colors];
                // Count shared colors
                const shared = otherColors.filter(c => currentColors.has(c)).length;
                if (shared >= 2) {
                    similarPalettes.push({ name, info, shared });
                }
            });

            // Sort by most shared and take top 5
            similarPalettes.sort((a, b) => b.shared - a.shared);
            const topSimilar = similarPalettes.slice(0, 5);

            if (topSimilar.length > 0) {
                similarEl.innerHTML = `
                    <div class="palette-inspector-similar-label">SIMILAR PALETTES</div>
                    <div class="similar-palettes-row">
                        ${topSimilar.map(p => {
                            const textColor = getContrastColor(p.info.bg);
                            return `<span class="similar-palette-chip" data-palette="${p.name}" style="background: ${p.info.bg}; color: ${textColor};">${p.name}</span>`;
                        }).join('')}
                    </div>
                `;

                // Click to view that palette
                similarEl.querySelectorAll('.similar-palette-chip').forEach(chip => {
                    chip.addEventListener('click', () => {
                        // Find a city with this palette and load it
                        const targetPalette = chip.dataset.palette;
                        for (let i = 0; i <= MAX_TOKEN; i++) {
                            if (tokenTraits[i]?.['Palette'] === targetPalette) {
                                inspector.classList.remove('open');
                                loadOutput(i, true);
                                break;
                            }
                        }
                    });
                });
            } else {
                similarEl.innerHTML = '';
            }

            inspector.classList.add('open');
        }

        document.getElementById('inspectPalette').addEventListener('click', openPaletteInspector);
        document.getElementById('closePaletteInspector').addEventListener('click', () => {
            document.getElementById('paletteInspector').classList.remove('open');
        });
        document.getElementById('paletteInspector').addEventListener('click', (e) => {
            if (e.target.id === 'paletteInspector') {
                document.getElementById('paletteInspector').classList.remove('open');
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
            switch(e.key.toLowerCase()) {
                case 's': saveFavorite(); break;
                case 'd': downloadPng(); break;
                case 't': shareTwitter(); break;
                case 'arrowleft': document.getElementById('prevToken').click(); break;
                case 'arrowright': document.getElementById('nextToken').click(); break;
                case 'g': galleryPanel.classList.toggle('open'); collectorsPanel.classList.remove('open'); updateGallery(); break;
                case 'c': collectorsPanel.classList.toggle('open'); galleryPanel.classList.remove('open'); break;
                case 'enter': openFullView(); break;
                case 'f': randomFiltered(); break;
                case 'l': copyLink(); break;
                case ' ': e.preventDefault(); if (!gridPanel.classList.contains('open')) toggleFullscreen(); break;
                case 'escape':
                    if (document.getElementById('frameMockup').classList.contains('open')) {
                        closeFrameMockup();
                    } else if (document.getElementById('paletteInspector').classList.contains('open')) {
                        document.getElementById('paletteInspector').classList.remove('open');
                    } else if (isFullscreen) { toggleFullscreen(); }
                    else if (gridPanel.classList.contains('open')) { closeGridView(); }
                    else { openGridView(); }
                    break;
            }
        });

        // Touch swipe gestures for mobile
        frameContainer.addEventListener('touchstart', (e) => {
            touchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        frameContainer.addEventListener('touchend', (e) => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
        }, { passive: true });

        window.addEventListener('popstate', () => {
            const params = getUrlParams();
            if (params.token !== null) {
                const tokenId = parseInt(params.token);
                if (!isNaN(tokenId) && tokenId >= 0 && tokenId <= MAX_TOKEN) loadOutput(tokenId, false);
            }
        });

        updateGallery();
        setSize('medium');
        initCollectorsPanel();

        // Grid View functionality
        const gridPanel = document.getElementById('gridPanel');
        const gridContent = document.getElementById('gridContent');
        const gridStats = document.getElementById('gridStats');
        const gridPrevPage = document.getElementById('gridPrevPage');
        const gridNextPage = document.getElementById('gridNextPage');
        const gridPageInfo = document.getElementById('gridPageInfo');
        const gridModeBtns = document.querySelectorAll('.grid-mode-btn');

        let gridMode = 'palette';
        let gridPage = 1;
        const gridPageSize = 24;

        document.getElementById('toggleGrid').addEventListener('click', () => {
            openGridView();
        });

        // View toggle button (fixed in top right)
        const viewToggleBtn = document.getElementById('viewToggleBtn');
        function openGridView() {
            gridPanel.classList.add('open');
            viewToggleBtn.classList.add('grid-open');
            document.body.classList.add('grid-open');
            populateGridFilters();
            renderGrid();
        }
        function closeGridView() {
            gridPanel.classList.remove('open');
            viewToggleBtn.classList.remove('grid-open');
            document.body.classList.remove('grid-open');
            // If no city loaded yet (first time clicking X), load the rarest city
            if (!previewImage.src || previewImage.src === window.location.href || currentTokenId === 0) {
                const rarestToken = getRarestToken();
                if (rarestToken) {
                    loadOutput(rarestToken);
                }
            }
        }
        viewToggleBtn.addEventListener('click', () => {
            if (gridPanel.classList.contains('open')) {
                closeGridView();
            } else {
                openGridView();
            }
        });

        // Jump to a specific palette in grid view
        function jumpToPalette(paletteName) {
            // Make sure we're in "by palette" mode
            document.querySelector('.grid-mode-btn[data-mode="palette"]')?.click();

            // Open grid view if not already open
            if (!gridPanel.classList.contains('open')) {
                openGridView();
            }

            // Wait for render, then scroll to the palette
            setTimeout(() => {
                const paletteGroup = gridContent.querySelector(`.grid-group[data-palette="${paletteName}"]`);
                if (paletteGroup) {
                    // Expand if collapsed
                    paletteGroup.classList.remove('collapsed');
                    // Scroll into view
                    paletteGroup.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        // Mobile filter toggle
        const filterToggleBar = document.getElementById('filterToggleBar');
        const gridFilterBar = document.getElementById('gridFilterBar');
        filterToggleBar.addEventListener('click', (e) => {
            e.stopPropagation();
            filterToggleBar.classList.toggle('open');
            gridFilterBar.classList.toggle('open');
        });

        // Title hover animation - text breaks apart on long hover
        // Open grid view by default on page load
        function openGridOnLoad() {
            openGridView();
            // Update active button to show palette is selected
            gridModeBtns.forEach(b => b.classList.remove('active'));
            document.querySelector('[data-mode="palette"]').classList.add('active');
        }

        // Palette/Color/A-Z/Rarity toggle button
        const paletteColorToggle = document.getElementById('paletteColorToggle');
        let paletteColorState = 'palette'; // toggles between 'palette', 'color', 'az', 'rarity'
        const toggleStates = {
            palette: { next: 'color', text: 'BY PALETTE', color: 'var(--warm)' },
            color: { next: 'az', text: 'BY COLOR', color: 'var(--warm)' },
            az: { next: 'rarity', text: 'A-Z', color: 'var(--warm)' },
            rarity: { next: 'palette', text: 'RARITY', color: 'var(--warm)' }
        };

        function updateToggleStyle() {
            const state = toggleStates[paletteColorState];
            paletteColorToggle.textContent = state.text;
            paletteColorToggle.dataset.mode = paletteColorState;
            paletteColorToggle.style.borderColor = state.color;
            paletteColorToggle.style.color = state.color;
        }

        gridModeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.id === 'gridCollectorsBtn' || btn.id === 'gridAllFavBtn') return; // Handled separately
                if (btn.id === 'paletteColorToggle') {
                    // Cycle through palette -> color -> a-z -> rarity -> palette
                    paletteColorState = toggleStates[paletteColorState].next;
                    updateToggleStyle();
                }
                gridModeBtns.forEach(b => { if (!b.classList.contains('collectors-btn') && b.id !== 'gridAllFavBtn') b.classList.remove('active'); });
                btn.classList.add('active');
                gridMode = btn.dataset.mode;
                gridPage = 1;
                renderGrid();
            });
        });

        // Grid size toggle - cycles from small to large (zoom in effect)
        // Reversed order: starts at responsive (6, 8, or 11 based on width), zooms in to 1-col (largest/texture view)
        const sizeModes = ['auto', '12-col', '11-col', '8-col', '6-col', '4-col', '3-col', '2-col', '1-col'];
        const sizeIcons = ['size-auto', 'size-12', 'size-10', 'size-8', 'size-6', 'size-4', 'size-3', 'size-2', 'size-1'];

        // Calculate responsive initial grid size based on window width
        function getResponsiveGridSize() {
            const w = window.innerWidth;
            // Wider windows get more columns, narrower get fewer
            if (w >= 1600) return '11-col';  // Wide screens: 11 columns
            if (w >= 1200) return '8-col';   // Medium-large: 8 columns
            return '6-col';                   // Smaller: 6 columns
        }

        // Initialize with responsive size
        let gridSize = getResponsiveGridSize();
        let gridSizeIndex = sizeModes.indexOf(gridSize);
        if (gridSizeIndex === -1) gridSizeIndex = 4; // fallback to 6-col

        function updateSizeIcon() {
            const icon = document.getElementById('sizeIcon');
            const sizeClass = sizeIcons[gridSizeIndex];
            icon.className = 'size-icon ' + sizeClass;

            // Generate <b> elements based on grid pattern
            let count = 1;
            if (['size-2', 'size-3', 'size-4'].includes(sizeClass)) count = 4;      // 2x2
            else if (['size-6', 'size-8'].includes(sizeClass)) count = 9;            // 3x3
            else if (['size-10', 'size-12', 'size-auto'].includes(sizeClass)) count = 16; // 4x4

            icon.innerHTML = '<b></b>'.repeat(count);
        }

        document.getElementById('gridSizeToggle').addEventListener('click', () => {
            gridSizeIndex = (gridSizeIndex + 1) % sizeModes.length;
            const oldSize = gridSize;
            gridSize = sizeModes[gridSizeIndex];
            updateSizeIcon();

            // Just update CSS classes instead of full re-render for performance
            const gridContainers = gridContent.querySelectorAll('.grid-items, .grid-group-items');
            if (gridContainers.length > 0) {
                gridContainers.forEach(container => {
                    container.classList.remove('grid-' + oldSize);
                    container.classList.add('grid-' + gridSize);
                });
            } else {
                renderGrid();
            }
        });

        updateSizeIcon();

        // Collectors button in grid
        document.getElementById('gridCollectorsBtn').addEventListener('click', () => {
            toggleCollectorsPanel();
            document.getElementById('gridStatsBar').classList.toggle('visible');
        });

        // ALL/FAVS toggle button
        let showingFavoritesOnly = false;
        const gridAllFavBtn = document.getElementById('gridAllFavBtn');
        gridAllFavBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showingFavoritesOnly = !showingFavoritesOnly;
            gridAllFavBtn.textContent = showingFavoritesOnly ? 'FAVS' : 'ALL';
            gridAllFavBtn.classList.toggle('favorites-active', showingFavoritesOnly);
            gridPage = 1;
            renderGrid();
        });

        // Multi-select filter state
        const gridFilterState = {
            palettes: new Set(),
            times: new Set(),
            zooms: new Set(),
            bounds: new Set(),
            traffic: new Set()
        };

        // Trait counts for rarity display
        const traitCounts = {
            palettes: {},
            times: {},
            zooms: {},
            bounds: {},
            traffic: {},
            lines: {},
            energy: {},
            commute: {},
            transit: {},
            water: {}
        };
        let totalMinted = 0;

        // Multi-select dropdown functionality
        function setupMultiSelect(containerId, filterKey, label) {
            const container = document.getElementById(containerId);
            const btn = container.querySelector('.multi-select-btn');
            const dropdown = container.querySelector('.multi-select-dropdown');

            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                // Close other dropdowns
                document.querySelectorAll('.multi-select.open').forEach(ms => {
                    if (ms !== container) ms.classList.remove('open');
                });
                container.classList.toggle('open');
            });

            dropdown.addEventListener('click', (e) => e.stopPropagation());
        }

        function populateMultiSelect(containerId, filterKey, valueCounts, label) {
            const container = document.getElementById(containerId);
            const dropdown = container.querySelector('.multi-select-dropdown');
            const btn = container.querySelector('.multi-select-btn');
            const sortedValues = Object.keys(valueCounts).sort();

            dropdown.innerHTML = `
                <label class="multi-select-item select-all">
                    <input type="checkbox" checked> <span class="select-all-text">DESELECT ALL</span>
                </label>
                ${sortedValues.map(v => {
                    const count = valueCounts[v];
                    const pct = totalMinted > 0 ? Math.round((count / totalMinted) * 100) : 0;
                    // Add color swatch for palette filter
                    let swatchHtml = '';
                    if (filterKey === 'palettes' && PALETTE_DATA[v]) {
                        const bg = PALETTE_DATA[v].bg;
                        const colors = PALETTE_DATA[v].colors.slice(0, 4);
                        swatchHtml = `<span class="multi-select-swatch" style="background:${bg}">${colors.map(c => `<span style="background:${c}"></span>`).join('')}</span>`;
                    }
                    return `
                    <label class="multi-select-item">
                        <input type="checkbox" value="${v}" checked>
                        ${swatchHtml}
                        <span class="multi-select-label">${v.toUpperCase()}</span>
                        <span class="multi-select-count">${count} (${pct}%)</span>
                    </label>
                `}).join('')}
            `;

            // Initialize state with all values selected
            gridFilterState[filterKey] = new Set(sortedValues);

            const selectAllCheckbox = dropdown.querySelector('.select-all input');
            const selectAllText = dropdown.querySelector('.select-all-text');
            const itemCheckboxes = dropdown.querySelectorAll('.multi-select-item:not(.select-all) input');

            function updateSelectAllText() {
                const allSelected = gridFilterState[filterKey].size === sortedValues.length;
                selectAllText.textContent = allSelected ? 'DESELECT ALL' : 'SELECT ALL';
            }

            selectAllCheckbox.addEventListener('change', () => {
                const checked = selectAllCheckbox.checked;
                itemCheckboxes.forEach(cb => {
                    cb.checked = checked;
                    if (checked) gridFilterState[filterKey].add(cb.value);
                    else gridFilterState[filterKey].delete(cb.value);
                });
                updateSelectAllText();
                updateMultiSelectBtn(btn, gridFilterState[filterKey], sortedValues.length, label);
                gridPage = 1; renderGrid();
                if (gridFilterState[filterKey].size < sortedValues.length) stopExplore();
            });

            itemCheckboxes.forEach(cb => {
                cb.addEventListener('change', () => {
                    if (cb.checked) gridFilterState[filterKey].add(cb.value);
                    else gridFilterState[filterKey].delete(cb.value);
                    selectAllCheckbox.checked = gridFilterState[filterKey].size === sortedValues.length;
                    updateSelectAllText();
                    updateMultiSelectBtn(btn, gridFilterState[filterKey], sortedValues.length, label);
                    gridPage = 1; renderGrid();
                    if (gridFilterState[filterKey].size < sortedValues.length) stopExplore();
                });
            });

            updateMultiSelectBtn(btn, gridFilterState[filterKey], sortedValues.length, label);
        }

        function updateMultiSelectBtn(btn, selectedSet, totalCount, label) {
            const count = selectedSet.size;
            if (count === 0) {
                btn.innerHTML = `NONE <span class="arrow"></span>`;
                btn.classList.add('has-selection');
            } else if (count === totalCount) {
                btn.innerHTML = `${label} <span class="arrow"></span>`;
                btn.classList.remove('has-selection');
            } else {
                btn.innerHTML = `${count} ${label} <span class="arrow"></span>`;
                btn.classList.add('has-selection');
            }
        }

        // Reset all grid filters to default (all selected)
        function resetGridFilters() {
            // Re-setup all multi-selects to reset them
            setupMultiSelect('paletteMultiSelect', 'palettes', 'PALETTES');
            setupMultiSelect('timeMultiSelect', 'times', 'TIMES');
            setupMultiSelect('zoomMultiSelect', 'zooms', 'ZOOMS');
            setupMultiSelect('boundsMultiSelect', 'bounds', 'BOUNDS');
            setupMultiSelect('trafficMultiSelect', 'traffic', 'TRAFFIC');
            // Uncheck water filter
            document.getElementById('gridWaterFilter').checked = false;
            gridPage = 1;
            renderGrid();
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.multi-select.open').forEach(ms => ms.classList.remove('open'));
        });

        // Setup multi-selects
        setupMultiSelect('paletteMultiSelect', 'palettes', 'PALETTES');
        setupMultiSelect('timeMultiSelect', 'times', 'TIMES');
        setupMultiSelect('zoomMultiSelect', 'zooms', 'ZOOMS');
        setupMultiSelect('boundsMultiSelect', 'bounds', 'BOUNDS');
        setupMultiSelect('trafficMultiSelect', 'traffic', 'TRAFFIC');

        document.getElementById('gridWaterFilter').addEventListener('change', () => { gridPage = 1; renderGrid(); if (document.getElementById('gridWaterFilter').checked) stopExplore(); });
        gridPrevPage.addEventListener('click', () => { if (gridPage > 1) { gridPage--; renderGrid(); } });
        gridNextPage.addEventListener('click', () => { gridPage++; renderGrid(); });

        function populateGridFilters() {
            // Reset counts
            traitCounts.palettes = {};
            traitCounts.times = {};
            traitCounts.zooms = {};
            traitCounts.bounds = {};
            traitCounts.traffic = {};
            traitCounts.lines = {};
            traitCounts.energy = {};
            traitCounts.commute = {};
            traitCounts.transit = {};
            traitCounts.water = {};
            totalMinted = 0;

            for (let i = 0; i <= MAX_TOKEN; i++) {
                const traits = tokenTraits[i];
                if (traits) {
                    totalMinted++;
                    if (traits['Palette']) {
                        traitCounts.palettes[traits['Palette']] = (traitCounts.palettes[traits['Palette']] || 0) + 1;
                    }
                    if (traits['Time of Day']) {
                        traitCounts.times[traits['Time of Day']] = (traitCounts.times[traits['Time of Day']] || 0) + 1;
                    }
                    if (traits['Zoom']) {
                        traitCounts.zooms[traits['Zoom']] = (traitCounts.zooms[traits['Zoom']] || 0) + 1;
                    }
                    if (traits['Bounds']) {
                        traitCounts.bounds[traits['Bounds']] = (traitCounts.bounds[traits['Bounds']] || 0) + 1;
                    }
                    if (traits['Traffic']) {
                        traitCounts.traffic[traits['Traffic']] = (traitCounts.traffic[traits['Traffic']] || 0) + 1;
                    }
                    if (traits['Line']) {
                        traitCounts.lines[traits['Line']] = (traitCounts.lines[traits['Line']] || 0) + 1;
                    }
                    if (traits['Energy']) {
                        traitCounts.energy[traits['Energy']] = (traitCounts.energy[traits['Energy']] || 0) + 1;
                    }
                    if (traits['Commute']) {
                        traitCounts.commute[traits['Commute']] = (traitCounts.commute[traits['Commute']] || 0) + 1;
                    }
                    if (traits['Transit']) {
                        traitCounts.transit[traits['Transit']] = (traitCounts.transit[traits['Transit']] || 0) + 1;
                    }
                    if (traits['Water Feature']) {
                        traitCounts.water[traits['Water Feature']] = (traitCounts.water[traits['Water Feature']] || 0) + 1;
                    }
                }
            }
            populateMultiSelect('paletteMultiSelect', 'palettes', traitCounts.palettes, 'PALETTES');
            populateMultiSelect('timeMultiSelect', 'times', traitCounts.times, 'TIMES');
            populateMultiSelect('zoomMultiSelect', 'zooms', traitCounts.zooms, 'ZOOMS');
            populateMultiSelect('boundsMultiSelect', 'bounds', traitCounts.bounds, 'BOUNDS');
            populateMultiSelect('trafficMultiSelect', 'traffic', traitCounts.traffic, 'TRAFFIC');
        }

        function getGridFilteredTokens() {
            // If collector filter is active, only show their tokens
            if (currentCollectorFilter && currentCollectorFilter.tokens.length > 0) {
                return currentCollectorFilter.tokens.sort((a, b) => a - b);
            }

            const waterFilter = document.getElementById('gridWaterFilter').checked;
            const tokens = [];
            for (let i = 0; i <= MAX_TOKEN; i++) {
                const traits = tokenTraits[i];
                if (!traits) continue;
                // Favorites filter: if showing favorites only, skip non-favorited cities
                if (showingFavoritesOnly && !isCityFavorited(i)) continue;
                // Multi-select filters: if none selected, show none; if value not in set, skip
                if (gridFilterState.palettes.size > 0 && !gridFilterState.palettes.has(traits['Palette'])) continue;
                if (gridFilterState.times.size > 0 && !gridFilterState.times.has(traits['Time of Day'])) continue;
                if (gridFilterState.zooms.size > 0 && !gridFilterState.zooms.has(traits['Zoom'])) continue;
                if (gridFilterState.bounds.size > 0 && !gridFilterState.bounds.has(traits['Bounds'])) continue;
                if (gridFilterState.traffic.size > 0 && !gridFilterState.traffic.has(traits['Traffic'])) continue;
                // Water filter: show items where Water Feature exists and is not "None"
                const waterVal = (traits['Water Feature'] || '').toLowerCase();
                if (waterFilter && (!waterVal || waterVal === 'none' || waterVal === 'no')) continue;
                tokens.push(i);
            }
            return tokens;
        }

        function getColorSortValue(palette) {
            const info = PALETTE_DATA[palette];
            if (!info || !info.bg) return 0;
            const hex = info.bg.replace('#', '');
            const r = parseInt(hex.substr(0, 2), 16);
            const g = parseInt(hex.substr(2, 2), 16);
            const b = parseInt(hex.substr(4, 2), 16);
            // Convert to HSL hue for rainbow sorting
            const max = Math.max(r, g, b), min = Math.min(r, g, b);
            let h = 0;
            if (max !== min) {
                const d = max - min;
                if (max === r) h = ((g - b) / d + (g < b ? 6 : 0)) / 6;
                else if (max === g) h = ((b - r) / d + 2) / 6;
                else h = ((r - g) / d + 4) / 6;
            }
            return h;
        }

        function renderGrid() {
            const tokens = getGridFilteredTokens();
            const totalMinted = Object.keys(tokenTraits).length || 318;

            // Check if any filters are active (filter is active when fewer than all options are selected)
            const hasActiveFilters = showingFavoritesOnly ||
                currentCollectorFilter !== null ||
                gridFilterState.palettes.size < Object.keys(traitCounts.palettes).length ||
                gridFilterState.times.size < Object.keys(traitCounts.times).length ||
                gridFilterState.zooms.size < Object.keys(traitCounts.zooms).length ||
                gridFilterState.bounds.size < Object.keys(traitCounts.bounds).length ||
                gridFilterState.traffic.size < Object.keys(traitCounts.traffic).length ||
                document.getElementById('gridWaterFilter').checked;

            // Update showing count - only visible when filters are active
            const showingEl = document.getElementById('gridShowingCount');
            if (showingEl) {
                showingEl.textContent = `${tokens.length} showing`;
                if (hasActiveFilters) {
                    showingEl.classList.add('visible');
                } else {
                    showingEl.classList.remove('visible');
                }
            }

            // Update supply bar
            const supplyFill = document.getElementById('gridSupplyFill');
            const mintedCount = document.getElementById('gridMintedCount');
            if (supplyFill) supplyFill.style.width = `${(totalMinted / 500) * 100}%`;
            if (mintedCount) mintedCount.textContent = totalMinted;

            // Use special favorites view when favorites mode is active
            if (showingFavoritesOnly) {
                renderFavoritesGrid(tokens);
            } else if (gridMode === 'grid') {
                renderSimpleGrid(tokens);
            } else if (gridMode === 'palette') {
                renderPaletteGroups(tokens);
            } else if (gridMode === 'color') {
                renderColorSorted(tokens);
            } else if (gridMode === 'az') {
                renderAZPalettes(tokens);
            } else if (gridMode === 'rarity') {
                renderRaritySorted(tokens);
            }
        }

        function renderFavoritesGrid(tokens) {
            // Special clean grid for favorites - sized big for viewing
            if (tokens.length === 0) {
                gridContent.innerHTML = `<div class="empty-gallery">NO FAVORITES YET<br><br>CLICK  ON CITIES TO ADD THEM</div>`;
                document.getElementById('gridPagination').style.display = 'none';
                return;
            }

            // Calculate optimal columns based on number of favorites
            let favGridSize;
            if (tokens.length <= 4) {
                favGridSize = '2-col';
            } else if (tokens.length <= 9) {
                favGridSize = '3-col';
            } else if (tokens.length <= 16) {
                favGridSize = '4-col';
            } else if (tokens.length <= 36) {
                favGridSize = '6-col';
            } else {
                favGridSize = '8-col';
            }

            gridContent.innerHTML = `<div class="grid-items grid-${favGridSize} favorites-grid">${tokens.map(id => generateGridItem(id, false, 0, true)).join('')}</div>`;

            document.getElementById('gridPagination').style.display = 'none';

            gridContent.querySelectorAll('.grid-item-fav').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleCityFavorite(parseInt(btn.dataset.token), e);
                });
            });

            gridContent.querySelectorAll('.grid-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.grid-item-fav')) return;
                    const tokenId = parseInt(item.dataset.token);
                    gridPanel.classList.remove('open');
                    loadOutput(tokenId, true);
                });
            });
        }

        function renderAZPalettes(tokens) {
            // Group by palette, then sort palettes A-Z
            const groups = {};
            tokens.forEach(id => {
                const traits = tokenTraits[id];
                const palette = traits?.['Palette'] || 'Unknown';
                if (!groups[palette]) groups[palette] = [];
                groups[palette].push(id);
            });

            // Sort palette names A-Z
            const sortedPalettes = Object.keys(groups).sort((a, b) => a.localeCompare(b));

            let html = sortedPalettes.map(palette => {
                const paletteInfo = PALETTE_DATA[palette];
                const swatches = paletteInfo?.colors ? paletteInfo.colors.map(c => `<span style="background:${c}"></span>`).join('') : '';
                const isFav = isPaletteFavorited(palette);
                const bgColor = paletteInfo?.bg || '#333';
                const rawSpotColor = paletteInfo?.colors?.[10] || '#FFE135';
                const spotColor = getContrastingSpotColor(rawSpotColor, '#14131c'); // Contrast against panel bg

                // Dark background with light text for better readability
                return `
                <div class="grid-group" data-palette="${palette}" style="--spot-color:${spotColor};">
                    <div class="grid-group-header">
                        <button class="grid-group-fav ${isFav ? 'favorited' : ''}" data-palette="${palette}" title="Favorite palette">${isFav ? '' : ''}</button>
                        <div class="grid-group-color" style="background:${bgColor}"></div>
                        <div class="grid-group-swatches">${swatches}</div>
                        <span class="grid-group-name">${palette.toUpperCase()}</span>
                        <span class="grid-group-count">${groups[palette].length}</span>
                        <button class="grid-group-shuffle" data-palette="${palette}" title="Shuffle order"></button>
                        <span class="grid-group-toggle"></span>
                    </div>
                    <div class="grid-group-items grid-${gridSize}">${groups[palette].map(id => generateGridItem(id)).join('')}</div>
                </div>
            `}).join('');

            gridContent.innerHTML = html;

            document.getElementById('gridPagination').style.display = 'none';

            // Palette favorite buttons
            gridContent.querySelectorAll('.grid-group-fav').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const palette = btn.dataset.palette;
                    toggleFavoritePalette(palette);
                    const isFav = btn.classList.toggle('favorited');
                    btn.textContent = isFav ? '' : '';
                });
            });

            // Shuffle buttons
            gridContent.querySelectorAll('.grid-group-shuffle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const group = btn.closest('.grid-group');
                    const itemsContainer = group.querySelector('.grid-group-items');
                    const items = [...itemsContainer.querySelectorAll('.grid-item')];
                    items.sort(() => Math.random() - 0.5);
                    items.forEach(item => itemsContainer.appendChild(item));
                });
            });

            // Header collapse toggle
            gridContent.querySelectorAll('.grid-group-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('.grid-group-fav') || e.target.closest('.grid-group-shuffle')) return;
                    header.parentElement.classList.toggle('collapsed');
                });
            });

            // Grid item clicks
            gridContent.querySelectorAll('.grid-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.grid-item-fav')) return;
                    const tokenId = parseInt(item.dataset.token);
                    gridPanel.classList.remove('open');
                    loadOutput(tokenId, true);
                });
            });

            gridContent.querySelectorAll('.grid-item-fav').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleCityFavorite(parseInt(btn.dataset.token), e);
                });
            });
        }

        function renderSimpleGrid(tokens) {
            // Show empty state if no matches
            if (tokens.length === 0) {
                gridContent.innerHTML = `<div class="empty-gallery">NO CITIES MATCH THESE FILTERS<br><br><button class="btn btn-secondary" onclick="resetGridFilters()">RESET FILTERS</button></div>`;
                document.getElementById('gridPagination').style.display = 'none';
                return;
            }
            // Use eager loading for small sets (collector views)
            const useEagerLoad = tokens.length <= 20;
            gridContent.innerHTML = `<div class="grid-items grid-${gridSize}">${tokens.map(id => generateGridItem(id, false, 0, useEagerLoad)).join('')}</div>`;

            document.getElementById('gridPagination').style.display = 'none';

            gridContent.querySelectorAll('.grid-item-fav').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleCityFavorite(parseInt(btn.dataset.token), e);
                });
            });

            gridContent.querySelectorAll('.grid-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.grid-item-fav')) return;
                    const tokenId = parseInt(item.dataset.token);
                    gridPanel.classList.remove('open');
                    loadOutput(tokenId, true);
                });
            });
        }

        function renderPaletteGroups(tokens) {
            const groups = {};
            tokens.forEach(id => {
                const traits = tokenTraits[id];
                const palette = traits?.['Palette'] || 'Unknown';
                if (!groups[palette]) groups[palette] = [];
                groups[palette].push(id);
            });

            // Find unminted palettes (in PALETTE_DATA but not in minted tokens)
            const mintedPalettes = new Set(Object.keys(groups));
            const unmintedPalettes = Object.keys(PALETTE_DATA).filter(p => !mintedPalettes.has(p));

            const sortedPalettes = Object.keys(groups).sort((a, b) => groups[b].length - groups[a].length);

            let html = sortedPalettes.map(palette => {
                const paletteInfo = PALETTE_DATA[palette];
                const swatches = paletteInfo?.colors ? paletteInfo.colors.map(c => `<span style="background:${c}"></span>`).join('') : '';
                const isFav = isPaletteFavorited(palette);
                const bgColor = paletteInfo?.bg || '#333';
                const rawSpotColor = paletteInfo?.colors?.[10] || '#FFE135';
                const spotColor = getContrastingSpotColor(rawSpotColor, '#14131c'); // Contrast against panel bg
                return `
                <div class="grid-group" data-palette="${palette}" style="--spot-color:${spotColor};">
                    <div class="grid-group-header">
                        <button class="grid-group-fav ${isFav ? 'favorited' : ''}" data-palette="${palette}" title="Favorite palette">${isFav ? '' : ''}</button>
                        <div class="grid-group-color" style="background:${bgColor}"></div>
                        <div class="grid-group-swatches">${swatches}</div>
                        <span class="grid-group-name">${palette.toUpperCase()}</span>
                        <span class="grid-group-count">${groups[palette].length}</span>
                        <button class="grid-group-shuffle" data-palette="${palette}" title="Shuffle order"></button>
                        <span class="grid-group-toggle"></span>
                    </div>
                    <div class="grid-group-items grid-${gridSize}">${groups[palette].map(id => generateGridItem(id)).join('')}</div>
                </div>
            `}).join('');

            // Add explore palettes section - shows unminted palettes waiting to be discovered
            if (unmintedPalettes.length > 0) {
                html += `
                <div class="grid-group explore-palettes-section collapsed">
                    <div class="grid-group-header" style="background: linear-gradient(135deg, rgba(232, 184, 109, 0.6), rgba(255, 140, 66, 0.6));">
                        <span class="grid-group-name" style="color: #000;"> EXPLORE PALETTES (${unmintedPalettes.length} WAITING)</span>
                        <span class="grid-group-toggle" style="color: #fff;"></span>
                    </div>
                    <div class="grid-group-items" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 16px;">
                        ${unmintedPalettes.sort().map(palette => {
                            const paletteInfo = PALETTE_DATA[palette];
                            const swatches = paletteInfo?.colors ? paletteInfo.colors.slice(0, 5).map(c => `<span style="background:${c};width:14px;height:14px;border-radius:3px;display:inline-block;"></span>`).join('') : '';
                            const textColor = getContrastColor(paletteInfo?.bg || '#333');
                            return `
                            <div class="explore-palette-chip" data-palette="${palette}" style="background:${paletteInfo?.bg || '#333'};padding:8px 12px;border-radius:8px;display:flex;align-items:center;gap:6px;cursor:pointer;transition:all 0.2s ease;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                <span style="font-size:9px;font-weight:700;color:${textColor};text-transform:uppercase;letter-spacing:0.05em;">${palette}</span>
                                <div style="display:flex;gap:2px;">${swatches}</div>
                            </div>
                        `}).join('')}
                    </div>
                </div>`;
            }

            gridContent.innerHTML = html;

            document.getElementById('gridPagination').style.display = 'none';

            // Palette favorite buttons
            gridContent.querySelectorAll('.grid-group-fav').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const palette = btn.dataset.palette;
                    toggleFavoritePalette(palette);
                    const isFav = btn.classList.toggle('favorited');
                    btn.textContent = isFav ? '' : '';
                });
            });

            // Shuffle buttons
            gridContent.querySelectorAll('.grid-group-shuffle').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const palette = btn.dataset.palette;
                    const group = btn.closest('.grid-group');
                    const itemsContainer = group.querySelector('.grid-group-items');
                    const items = [...itemsContainer.querySelectorAll('.grid-item')];
                    items.sort(() => Math.random() - 0.5);
                    items.forEach(item => itemsContainer.appendChild(item));
                    showStatus(`SHUFFLED: ${palette.toUpperCase()}`);
                });
            });

            // Explore palette chips - try to jump to palette, show message if no cities
            gridContent.querySelectorAll('.explore-palette-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    const palette = chip.dataset.palette;
                    // Check if this palette has any minted cities
                    const paletteTokens = Object.keys(tokenTraits).filter(id => tokenTraits[id]?.Palette === palette);
                    if (paletteTokens.length > 0) {
                        // Has cities - scroll to it (shouldn't be in explore section but just in case)
                        jumpToPalette(palette);
                    } else {
                        showStatus(`${palette.toUpperCase()} - NOT MINTED YET`);
                    }
                });
            });

            // City favorite buttons
            gridContent.querySelectorAll('.grid-item-fav').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleCityFavorite(parseInt(btn.dataset.token), e);
                });
            });

            gridContent.querySelectorAll('.grid-group-header').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('.grid-group-fav') || e.target.closest('.grid-group-shuffle')) return;
                    header.parentElement.classList.toggle('collapsed');
                });
            });

            gridContent.querySelectorAll('.grid-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.grid-item-fav')) return;
                    e.stopPropagation();
                    const tokenId = parseInt(item.dataset.token);
                    gridPanel.classList.remove('open');
                    loadOutput(tokenId, true);
                });
            });
        }

        function renderColorSorted(tokens) {
            const sorted = [...tokens].sort((a, b) => {
                const paletteA = tokenTraits[a]?.['Palette'] || '';
                const paletteB = tokenTraits[b]?.['Palette'] || '';
                return getColorSortValue(paletteA) - getColorSortValue(paletteB);
            });

            gridContent.innerHTML = `<div class="grid-items grid-${gridSize}">${sorted.map(id => generateGridItem(id)).join('')}</div>`;

            document.getElementById('gridPagination').style.display = 'none';

            gridContent.querySelectorAll('.grid-item-fav').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleCityFavorite(parseInt(btn.dataset.token), e);
                });
            });

            gridContent.querySelectorAll('.grid-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.grid-item-fav')) return;
                    const tokenId = parseInt(item.dataset.token);
                    gridPanel.classList.remove('open');
                    loadOutput(tokenId, true);
                });
            });
        }

        function calculateRarityScore(tokenId) {
            const traits = tokenTraits[tokenId];
            if (!traits || totalMinted === 0) return 100;

            // Calculate combined rarity as product of individual trait rarities
            // Lower score = more rare
            let score = 1;
            const keyTraits = ['Palette', 'Time of Day', 'Zoom', 'Bounds', 'Traffic'];
            keyTraits.forEach(key => {
                const value = traits[key];
                if (value) {
                    const rarity = getTraitRarity(key, value);
                    if (rarity) {
                        score *= (rarity.pct / 100);
                    }
                }
            });
            return score * 100; // Convert to percentage-like number
        }

        function getRarestToken() {
            // Find the rarest token across all minted tokens
            const allTokens = Object.keys(tokenTraits).map(Number);
            if (allTokens.length === 0) return 0;

            let rarestToken = allTokens[0];
            let lowestScore = calculateRarityScore(rarestToken);

            allTokens.forEach(tokenId => {
                const score = calculateRarityScore(tokenId);
                if (score < lowestScore) {
                    lowestScore = score;
                    rarestToken = tokenId;
                }
            });

            return rarestToken;
        }

        function renderRaritySorted(tokens) {
            // Calculate rarity score for each token and sort (rarest first)
            const withScores = tokens.map(id => ({
                id,
                score: calculateRarityScore(id)
            })).sort((a, b) => a.score - b.score);

            gridContent.innerHTML = `<div class="grid-items grid-${gridSize}">${withScores.map((item, idx) => generateGridItem(item.id, true, idx + 1)).join('')}</div>`;

            document.getElementById('gridPagination').style.display = 'none';

            gridContent.querySelectorAll('.grid-item-fav').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleCityFavorite(parseInt(btn.dataset.token), e);
                });
            });

            gridContent.querySelectorAll('.grid-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.grid-item-fav')) return;
                    const tokenId = parseInt(item.dataset.token);
                    gridPanel.classList.remove('open');
                    loadOutput(tokenId, true);
                });
            });
        }

        const urlParams = getUrlParams();
        const lastViewed = getLastViewed();
        // Load a random city on fresh visit (avoid token 0 which can be slow)
        const randomStart = Math.floor(Math.random() * MAX_TOKEN) + 1;
        const initialToken = urlParams.token !== null ? parseInt(urlParams.token) : (lastViewed || randomStart);
        const validInitialToken = !isNaN(initialToken) && initialToken >= 0 && initialToken <= MAX_TOKEN ? initialToken : randomStart;

        loadOutput(validInitialToken, true);
        loadAllTokenData();

        // Fetch and update minted count from Art Blocks API
        async function updateMintedCount() {
            try {
                const response = await fetch(`https://token.artblocks.io/${CONTRACT}/0`);
                const data = await response.json();
                // The invocations field shows total minted
                if (data.invocations) {
                    const minted = parseInt(data.invocations);
                    const newMaxToken = minted - 1; // Token IDs are 0-indexed

                    // Update UI
                    const percent = Math.round((minted / 500) * 100);
                    document.getElementById('mintedPercent').textContent = percent;
                    document.getElementById('statsCities').textContent = minted;

                    // Update progress bar
                    document.getElementById('supplyFill').style.width = percent + '%';

                    // If new tokens have been minted, fetch their data
                    if (newMaxToken > MAX_TOKEN) {
                        console.log(`New mints detected: ${MAX_TOKEN + 1} to ${newMaxToken}`);
                        // Fetch traits for new tokens
                        for (let i = MAX_TOKEN + 1; i <= newMaxToken; i++) {
                            await fetchTokenTraits(i);
                        }
                        MAX_TOKEN = newMaxToken;
                        // Update filters and counts with new data
                        extractTraitValues();
                        populateFilters();
                        updateMatchCount();
                        saveCachedTraits();
                    }

                    if (minted >= 500) {
                        document.getElementById('supplyTracker').classList.add('sold-out');
                        document.querySelector('.supply-label .dots').style.display = 'none';
                    }
                }
            } catch (e) {
                console.log('Could not fetch minted count');
            }
        }
        updateMintedCount();
        // Refresh every 30 seconds to catch new mints
        setInterval(updateMintedCount, 30000);

        // Mint button wave animation - each letter waves independently
        function triggerMintWave() {
            const letters = document.querySelectorAll('#mintToggle .mint-letter');
            letters.forEach((letter, i) => {
                setTimeout(() => {
                    letter.classList.add('wave');
                    setTimeout(() => letter.classList.remove('wave'), 500);
                }, i * 80);
            });
        }
        // Initial wave after 2 seconds, then every 5 seconds
        setTimeout(triggerMintWave, 2000);
        setInterval(triggerMintWave, 5000);

        // Countdown to May 31st
        function updateCountdown() {
            const target = new Date('2025-05-31T23:59:59').getTime();
            const now = new Date().getTime();
            const diff = target - now;
            const timerEl = document.getElementById('countdownTimer');
            const containerEl = document.getElementById('mintCountdown');

            if (diff <= 0) {
                containerEl.classList.add('ended');
                return;
            }

            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((diff % (1000 * 60)) / 1000);

            timerEl.textContent = `${days}D ${hours}H ${mins}M ${secs}S`;
        }
        updateCountdown();
        setInterval(updateCountdown, 1000);

        // Welcome screen - blob first, then city if needed, then reveal
        const welcomeScreen = document.getElementById('welcomeScreen');
        const welcomeProgress = document.getElementById('welcomeProgressBar');

        let readyToReveal = false;
        let loadProgress = 0;
        const pageLoadTime = Date.now();

        // Start with city animation showing
        welcomeScreen.classList.add('show-city');

        // Animate progress bar
        function updateWelcomeProgress(percent) {
            loadProgress = percent;
            welcomeProgress.style.width = Math.min(100, percent) + '%';
        }

        // Reveal the page
        function revealPage() {
            if (readyToReveal) return;
            readyToReveal = true;
            updateWelcomeProgress(100);
            setTimeout(() => welcomeScreen.classList.add('hidden'), 400);
        }

        // Preload the first visible city image
        function preloadInitialImage() {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => resolve(true);
                img.onerror = () => resolve(false);
                img.src = `${MEDIA_BASE}/${CONTRACT}/${currentTokenId}.png`;
            });
        }

        // Progress animation - gradual increase during city phase (0-3s)
        updateWelcomeProgress(5);
        setTimeout(() => updateWelcomeProgress(15), 400);
        setTimeout(() => updateWelcomeProgress(30), 900);
        setTimeout(() => updateWelcomeProgress(50), 1600);
        setTimeout(() => updateWelcomeProgress(65), 2400);

        // Track image loading
        let imageLoaded = false;
        preloadInitialImage().then((loaded) => {
            imageLoaded = loaded;
            updateWelcomeProgress(Math.max(loadProgress, 80));
        });

        // After 3 seconds of city: check if 80% loaded
        setTimeout(() => {
            if (readyToReveal) return;

            if (loadProgress >= 80 || imageLoaded) {
                // Images are ready, reveal now
                updateWelcomeProgress(95);
                setTimeout(revealPage, 400);
            } else {
                // Not ready yet - switch to blob animation for a few more seconds
                welcomeScreen.classList.remove('show-city');
                updateWelcomeProgress(70);

                // Continue progress during blob phase
                setTimeout(() => updateWelcomeProgress(80), 800);
                setTimeout(() => updateWelcomeProgress(90), 1800);
                setTimeout(() => updateWelcomeProgress(95), 2800);

                // Reveal after blob plays for ~3 seconds
                setTimeout(() => {
                    if (!readyToReveal) revealPage();
                }, 3200);
            }
        }, 3000);

        // Force reveal at 7 seconds max regardless
        setTimeout(revealPage, 7000);

        // Side navigation arrows
        document.getElementById('sideNavPrev').addEventListener('click', () => document.getElementById('prevToken').click());
        document.getElementById('sideNavNext').addEventListener('click', () => document.getElementById('nextToken').click());

        // Token ID slot machine animation
        const tokenInput = document.getElementById('tokenId');
        let lastTokenValue = tokenInput.value;
        tokenInput.addEventListener('input', () => {
            if (tokenInput.value !== lastTokenValue) {
                tokenInput.classList.add('digit-change');
                setTimeout(() => tokenInput.classList.remove('digit-change'), 150);
                lastTokenValue = tokenInput.value;
            }
        });

        // Filter glow effect
        document.querySelectorAll('.filter-grid select').forEach(select => {
            select.addEventListener('change', () => {
                if (select.value) {
                    select.classList.add('has-value', 'just-selected');
                    setTimeout(() => select.classList.remove('just-selected'), 400);
                } else {
                    select.classList.remove('has-value');
                }
            });
        });

        // Sidebar note area - rotating placeholder messages
        const notePlaceholders = [
            'Add a note',
            'Leave a thought',
            'Which city is your fave?',
            'Hello from downtown',
            'Notes from the skyline',
            'Urban observations',
            'City whispers'
        ];
        const notePlaceholder = document.getElementById('notePlaceholder');
        const noteInput = document.getElementById('noteInput');
        const noteCharCount = document.getElementById('noteCharCount');
        const noteArea = document.querySelector('.sidebar-note-area');

        // Pick a random placeholder on load
        const randomPlaceholder = notePlaceholders[Math.floor(Math.random() * notePlaceholders.length)];
        notePlaceholder.innerHTML = randomPlaceholder + '<span class="note-dots">...</span><span class="note-cursor">|</span>';
        noteInput.placeholder = randomPlaceholder + '...';

        notePlaceholder.addEventListener('click', () => {
            noteArea.classList.add('active');
            noteInput.focus();
        });

        noteInput.addEventListener('input', () => {
            noteCharCount.textContent = noteInput.value.length;
        });

        noteInput.addEventListener('blur', () => {
            if (!noteInput.value.trim()) {
                noteArea.classList.remove('active');
            }
        });

        // Navigation bounce at limits
        document.getElementById('prevToken').addEventListener('click', () => {
            if (currentTokenId <= 0) {
                document.getElementById('prevToken').classList.add('at-limit-prev');
                setTimeout(() => document.getElementById('prevToken').classList.remove('at-limit-prev'), 300);
            }
        });
        document.getElementById('nextToken').addEventListener('click', () => {
            if (currentTokenId >= MAX_TOKEN) {
                document.getElementById('nextToken').classList.add('at-limit-next');
                setTimeout(() => document.getElementById('nextToken').classList.remove('at-limit-next'), 300);
            }
        });

        // Heart burst effect on favorite
        const originalSaveFavorite = saveFavorite;
        saveFavorite = function() {
            const wasAdded = originalSaveFavorite();
            if (wasAdded !== false) {
                const heartBtn = document.getElementById('saveFavorite');
                heartBtn.classList.add('burst');
                setTimeout(() => heartBtn.classList.remove('burst'), 350);

                // Create color particles from current palette
                const traits = tokenTraits[currentTokenId];
                if (traits && PALETTE_DATA[traits['Palette']]) {
                    const colors = PALETTE_DATA[traits['Palette']].colors.slice(0, 6);
                    const particles = document.createElement('div');
                    particles.className = 'heart-particles';
                    colors.forEach((color, i) => {
                        const p = document.createElement('div');
                        p.className = 'heart-particle';
                        p.style.background = color;
                        const angle = (i / colors.length) * Math.PI * 2;
                        p.style.setProperty('--tx', `${Math.cos(angle) * 25}px`);
                        p.style.setProperty('--ty', `${Math.sin(angle) * 25}px`);
                        particles.appendChild(p);
                    });
                    heartBtn.appendChild(particles);
                    setTimeout(() => particles.remove(), 500);
                }
            }
        };

        // Owner name color from palette
        function updateOwnerColor() {
            const traits = tokenTraits[currentTokenId];
            if (traits && PALETTE_DATA[traits['Palette']]) {
                const colors = PALETTE_DATA[traits['Palette']].colors;
                const brightColor = colors.find(c => {
                    const r = parseInt(c.slice(1, 3), 16);
                    const g = parseInt(c.slice(3, 5), 16);
                    const b = parseInt(c.slice(5, 7), 16);
                    return (r * 299 + g * 587 + b * 114) / 1000 > 120;
                }) || colors[0];
                const ownerLink = document.querySelector('.owner-display a');
                if (ownerLink) ownerLink.style.color = brightColor;
            }
        }

        // Override displayOwnerInfo to add color
        const originalDisplayOwnerInfo = displayOwnerInfo;
        displayOwnerInfo = function(owner, loading) {
            originalDisplayOwnerInfo(owner, loading);
            if (!loading) setTimeout(updateOwnerColor, 50);
        };

        // ===== GALLERY ROOM EXPERIENCE =====
        const galleryRoom = document.getElementById('galleryRoom');
        const galleryRoomWall = document.getElementById('galleryRoomWall');
        const galleryRoomClose = document.getElementById('galleryRoomClose');
        const galleryRoomToggle = document.getElementById('galleryRoomToggle');

        function getGalleryTokens() {
            if (showingFavoritesOnly) {
                const favs = JSON.parse(localStorage.getItem('cities-favorites') || '[]');
                return favs.map(f => f.tokenId).filter(id => tokenTraits[id]);
            }
            return getGridFilteredTokens();
        }

        // Gallery Room - simplified, just art with edge-based scroll speed
        let galleryScrollPos = 0;
        let galleryScrollSpeed = 0.3; // Base slow speed
        let galleryTargetSpeed = 0.3;
        let galleryAnimFrame = null;
        let galleryWallWidth = 0;
        let galleryHoveredFrame = null;

        function openGalleryRoom() {
            const tokens = getGalleryTokens();
            if (tokens.length < 3) return;

            // Shuffle and limit tokens
            const shuffled = [...tokens].sort(() => Math.random() - 0.5);
            const displayTokens = shuffled.slice(0, Math.min(40, shuffled.length));

            // Duplicate for seamless loop
            const allTokens = [...displayTokens, ...displayTokens];

            // Update counter
            document.getElementById('galleryRoomCounter').textContent = `${displayTokens.length} Cities`;

            galleryRoomWall.innerHTML = allTokens.map((id) => `
                <div class="gallery-room-frame" data-token="${id}">
                    <img src="${MEDIA_BASE}/${CONTRACT}/${id}.png" alt="Cities #${id}" loading="lazy">
                </div>
            `).join('');

            galleryRoom.classList.add('open');
            document.body.style.overflow = 'hidden';

            // Calculate wall width after render
            requestAnimationFrame(() => {
                galleryWallWidth = galleryRoomWall.scrollWidth / 2;
                galleryScrollPos = 0;
                startGalleryScroll();
            });
        }

        function closeGalleryRoom() {
            galleryRoom.classList.remove('open');
            document.body.style.overflow = '';
            if (galleryAnimFrame) {
                cancelAnimationFrame(galleryAnimFrame);
                galleryAnimFrame = null;
            }
        }

        function startGalleryScroll() {
            function animate() {
                // Smoothly interpolate speed
                galleryScrollSpeed += (galleryTargetSpeed - galleryScrollSpeed) * 0.02;

                // Only scroll if not hovering a frame
                if (!galleryHoveredFrame) {
                    galleryScrollPos += galleryScrollSpeed;

                    // Loop seamlessly
                    if (galleryScrollPos >= galleryWallWidth) {
                        galleryScrollPos -= galleryWallWidth;
                    }

                    galleryRoomWall.style.transform = `translateX(${-galleryScrollPos}px)`;
                }

                galleryAnimFrame = requestAnimationFrame(animate);
            }
            animate();
        }

        // Mouse position affects scroll speed - edges go faster
        galleryRoom.addEventListener('mousemove', (e) => {
            if (galleryHoveredFrame) return; // Don't change speed when hovering frame

            const x = e.clientX;
            const w = window.innerWidth;
            const edgeZone = w * 0.15; // 15% edge zone on each side

            if (x < edgeZone) {
                // Left edge - scroll right (negative direction), speed up based on how far into edge
                const edgeProgress = 1 - (x / edgeZone);
                galleryTargetSpeed = -0.3 - (edgeProgress * 1.5); // -0.3 to -1.8
            } else if (x > w - edgeZone) {
                // Right edge - scroll left (positive direction), speed up
                const edgeProgress = (x - (w - edgeZone)) / edgeZone;
                galleryTargetSpeed = 0.3 + (edgeProgress * 1.5); // 0.3 to 1.8
            } else {
                // Center - slow base speed
                galleryTargetSpeed = 0.3;
            }
        });

        // Hover on frame - pause and scale up
        galleryRoomWall.addEventListener('mouseenter', (e) => {
            const frame = e.target.closest('.gallery-room-frame');
            if (frame) {
                galleryHoveredFrame = frame;
            }
        }, true);

        galleryRoomWall.addEventListener('mouseleave', (e) => {
            const frame = e.target.closest('.gallery-room-frame');
            if (frame && frame === galleryHoveredFrame) {
                galleryHoveredFrame = null;
            }
        }, true);

        galleryRoomToggle.addEventListener('click', openGalleryRoom);
        galleryRoomClose.addEventListener('click', closeGalleryRoom);
        galleryRoom.addEventListener('click', (e) => {
            if (e.target === galleryRoom || e.target.classList.contains('gallery-room-ambient')) {
                closeGalleryRoom();
            }
        });

        // Click on frame to view that token
        galleryRoomWall.addEventListener('click', (e) => {
            const frame = e.target.closest('.gallery-room-frame');
            if (frame) {
                const tokenId = parseInt(frame.dataset.token);
                closeGalleryRoom();
                gridPanel.classList.remove('open');
                loadOutput(tokenId, true);
            }
        });

        // ESC key closes gallery room
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && galleryRoom.classList.contains('open')) {
                closeGalleryRoom();
            }
        });


    </script>

    <a href="https://shop.efdotstudio.com" target="_blank" title="Shop"><img src="blob-shop.png" alt="Shop" class="blob-shop-fixed"></a>
</body>
</html>
